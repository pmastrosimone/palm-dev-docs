<HTML>

<HEAD>
<SMALLSCREENIGNORE> 
<LINK HREF="copy_of_palmos.css" REL="stylesheet" TYPE="text/css">
<LINK HREF="document.css" REL="StyleSheet" TYPE="text/css" media="screen">
<!-- SCRIPT_START -->
<!-- SCRIPT_END -->
</SMALLSCREENIGNORE>
<TITLE>Exchange Libraries</TITLE>

<META NAME="PALMTEMPLATE" CONTENT="1006-002 Palm HTML 20020513">
<META NAME="GENERATOR" CONTENT="Quadralay WebWorks Publisher Professional Edition 6.0.7">
<META NAME="TEMPLATEBASE" CONTENT="Palm HTML 20010625">
<META NAME="LASTUPDATED" CONTENT="12/13/02 10:04:15">
<META HTTP-EQUIV="content-type" CONTENT="text/html;charset=ISO-8859-1">

</HEAD>

<BODY LEFTMARGIN="0" MARGINWIDTH="0" TOPMARGIN="0" MARGINHEIGHT="0">
<SMALLSCREENIGNORE> 
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr>
	<td><a name="975845"></a>
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr height="35"> 
          <td height="35" colspan="2" bgcolor="#6699CC">&nbsp;</td>
        </tr>
        <tr valign="top"> 
          <td width="160" align="left"><a href="http://www.palmos.com"><img src="images/bigorb.gif" width="160" height="110" border="0"></a></td>
          <td align="left" width="100%"> 
            </SMALLSCREENIGNORE>
            <!-- CONTENTCELL_START -->
            <img border="0" height="45" src="images/orb_bkgrnd_600.gif" width="600"><br>
            <!--PAGENAV_START-->
            <SPAN CLASS="subnav">&nbsp;&lt;&nbsp;<A HREF="http://www.palmos.com/index.html">Home</a> 
              &nbsp;&nbsp;&lt;&nbsp;<A HREF="http://www.palmos.com/dev/">Developers</a> 
              &nbsp;&nbsp;&lt;&nbsp;<A HREF="http://www.palmos.com/dev/support/">Development Support</a>
              &nbsp;&nbsp;&lt;&nbsp;<A HREF="http://www.palmos.com/dev/support/docs/">Documentation</a></span><BR>
             <img src="images/pixel_ltblue.gif" width="600" height="1" border="0" vspace="2"><br>
             <h2 class="HeadDocPage">2  Exchange Libraries</h2>
             <img src="images/pixel_ltblue.gif" width="600" height="1" border="0" vspace="2"><br>
             &nbsp;<span class="subnav"><a href="Companion2TOC.html">Table of Contents</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="ExchangeManagerConcept.html">&lt;&nbsp;Previous</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="PersonalDataInterchange.html">Next&nbsp;&gt;</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="Companion2IX.html">Index</a></span>  
            <!--PAGENAV_END-->
          </td>
        </tr>
      </table>
    </td>
			</tr>
  <tr>
				<td> 
      <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
							<td>&nbsp;&nbsp;&nbsp;</td>
						</tr>
        <tr>
		<td valign="top" width="10">&nbsp;&nbsp;&nbsp;</td>
		<td valign="top" width="175">
			<p class="SideTitle">Title - <br><a href="Companion2Front.html">Palm OS® Programmer's Companion</a></p>
			<p class="SideTOC1-PartTab">Volume II Communications </p>
			<p class="SideTOC1"><a href="ExchangeLibraries.html">2  Exchange Libraries</a></p>
			
<p class="SideTOC2">
<a href="#975871">About Exchange Libraries
</a></p>

<p class="SideTOC3">
<a href="#975884">Exchange Libraries, Exchange Manager, and Applications
</a></p>

<p class="SideTOC3">
<a href="#975941">Palm OS Exchange Libraries
</a></p>

<p class="SideTOC2">
<a href="#975987">Exchange Library Components
</a></p>

<p class="SideTOC3">
<a href="#975999">The Exchange Library API
</a></p>

<p class="SideTOC3">
<a href="#976077">Dispatch Table
</a></p>

<p class="SideTOC2">
<a href="#976235">Implementing an Exchange Library
</a></p>

<p class="SideTOC3">
<a href="#976238">Required Functions
</a></p>

<p class="SideTOC3">
<a href="#976392">Registering with the Exchange Manager
</a></p>

<p class="SideTOC2">
<a href="#976406">Summary of Exchange Library
</a></p>

		</td>

		<td width="5">&nbsp;&nbsp;</td>
		<td width="1" bgcolor="#6699cc">&nbsp;</td>
		<td width="5">&nbsp;&nbsp;</td>
		<td> 

				<!-- CONTENT_START -->

<p class="Body">
  <a name="975847"> </a>This chapter describes how to implement an exchange library. It covers the following topics:
</p>

  <a name="975851"> </a><p class="B1Bullet"> &#8226; <a href="ExchangeLibraries.html#975871">About Exchange Libraries</a></p>

  <a name="975855"> </a><p class="B1Bullet"> &#8226; <a href="ExchangeLibraries.html#975987">Exchange Library Components</a></p>

  <a name="975859"> </a><p class="B1Bullet"> &#8226; <a href="ExchangeLibraries.html#976235">Implementing an Exchange Library</a></p>
<p class="Body">
  <a name="975860"> </a>Prior to implementing an exchange library, you should have a clear understanding of how the Exchange Manager operates. See <a href="ExchangeManagerConcept.html#969979">Chapter 1, "Object Exchange,"</a> for an in-depth discussion on the Exchange Manager. Also see <a href="ExgLibAPI.html#1244433">Chapter 58, "Exchange Library,"</a> of the <i>Palm OS Programmer's API Reference</i> for a detailed description of the functions that must be implemented in each exchange library.
</p>

<h2 class="HaHeadA">
  <a name="975871"> </a>About Exchange Libraries 
<a href="#975845"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="975873"> </a>Exchange libraries are Palm OS<sup>®</sup> shared libraries that act as "plug-ins" to the <a href="ExchangeManager.html#1232736">Exchange Manager</a>. They deal with protocols and communication devices and allow Palm OS applications to import and export data objects without regard to the transport mechanism. For example, one exchange library always available to Palm Powered<sup>&#8482;</sup> handhelds implements the IrDA protocol, IrOBEX. This allows applications to beam objects by way of infrared from one Palm Powered handheld to another.
</p>
<p class="Body">
  <a name="975877"> </a>The following can take advantage of the Exchange Library API:
</p>

  <a name="975878"> </a><p class="B1Bullet"> &#8226; Removable storage cards</p>

  <a name="975879"> </a><p class="B1Bullet"> &#8226; Notification services</p>

  <a name="975880"> </a><p class="B1Bullet"> &#8226; Email attachments</p>

  <a name="975881"> </a><p class="B1Bullet"> &#8226; Web (HTTP/FTP/CTP/WAP) exchange</p>

  <a name="975882"> </a><p class="B1Bullet"> &#8226; HotSync<sup>®</sup> simplified import and export</p>

<h2 class="HBHeadB">
  <a name="975884"> </a>Exchange Libraries, Exchange Manager, and Applications
<a href="#975845"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="975885"> </a>The Exchange Manager is a high-level tool for applications to use. An exchange library is a set of routines that handle the implementation specifics of a particular transport. Typically, exchange library functions are called from the Exchange Manager and are not directly accessed by applications. Applications wanting to send or receive data call the functions provided by the Exchange Manager API, many of which do little more than invoke the corresponding function in the appropriate exchange library.
</p>
<p class="Body">
  <a name="975886"> </a>Exchange libraries also make calls back into the Exchange Manager. For example, an exchange library would call <a href="ExchangeManager.html#1234294"><span style="font-family: monospace">ExgNotifyReceive</span></a> to have the Exchange Manager deliver objects received by the exchange library.
</p>
<p class="Body">
  <a name="975890"> </a>No one component involved with data exchange (Exchange Manager, exchange library, or application) is complete in itself. However, applications and exchange libraries should be written so the user experiences all interaction as a single seamless interface, even though what takes place is really a complex interaction between different pieces of code.
</p>
<p class="Body">
  <a name="975894"> </a><a href="ExchangeLibraries.html#975896">Figure 2.1</a> illustrates the relationship between applications, the Exchange Manager, and the exchange libraries within two devices that are in communication.
</p>

<p class="FFigureCaption">
  <a name="975896"> </a>Figure 2.1	 Object exchange using Exchange Manager
</p>
<p class="FgFigure">
  <a name="975900"> </a><div align="left"><img src="images/ExchangeMgr.gif" height="207" width="580" border="0" hspace="20" vspace="0">
</div>
</p>
<p class="Body">
  <a name="975901"> </a>The following table lists the division of responsibilities between Palm OS applications, the Exchange Manager, and the exchange libraries.
</p>

<h5 class="TgTable">
  <a name="975940"> </a>

<table border="1" cellpadding="5" cellspacing="0">
  <caption><a name="975904"> </a><div class="TableTitle">Table 2.1  Division of responsibility for data object exchange </div></caption>
  <tr bgcolor="#CCCCCC" valign="top">
    <th><a name="975910"> </a><div class="CellHeading">Palm OS Application</div></th>
    <th><a name="975912"> </a><div class="CellHeading">Exchange Manager</div></th>
    <th><a name="975914"> </a><div class="CellHeading">Exchange Library</div></th>
  </tr>
  <tr valign="top">
    <td><a name="975916"> </a><div class="CellBody">Creates, edits, and stores data</div></td>
    <td><a name="975918"> </a><div class="CellBody">Maintains registry of exchange libraries</div></td>
    <td><a name="975920"> </a><div class="CellBody">Sends data to or receives data from other devices</div></td>
  </tr>
  <tr valign="top">
    <td><a name="975922"> </a><div class="CellBody">Converts data to and from the interchange formats</div></td>
    <td><a name="975924"> </a><div class="CellBody">Maintains registry of applications that can receive data</div><a name="975925"> </a><div class="CellBody"><br></div></td>
    <td><a name="975927"> </a><div class="CellBody">Displays a dialog to get addressing information from user</div></td>
  </tr>
  <tr valign="top">
    <td><a name="975929"> </a><div class="CellBody">Views or describes data</div></td>
    <td><a name="975931"> </a><div class="CellBody">Passes send and receive requests to appropriate exchange library</div></td>
    <td><a name="975933"> </a><div class="CellBody">Displays status and error dialogs, possibly using the Progress Manager</div></td>
  </tr>
  <tr valign="top">
    <td><a name="975935"> </a><div class="CellBody"><br></div></td>
    <td><a name="975937"> </a><div class="CellBody">Displays a dialog asking if user wants to receive data</div></td>
    <td><a name="975939"> </a><div class="CellBody"><br></div></td>
  </tr>
</table>




</h5>
<h2 class="HBHeadB">
  <a name="975941"> </a>Palm OS Exchange Libraries
<a href="#975845"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="975942"> </a>The Exchange Manager was introduced in Palm OS 3.0 and was significantly enhanced in Palm OS 4.0. Because of this, the various exchange libraries require different versions of the OS. <a href="ExchangeLibraries.html#975953">Table 2.2</a> lists the minimum OS version required by various exchange libraries.
</p>

<h5 class="TgTable">
  <a name="975983"> </a>

<table border="1" cellpadding="5" cellspacing="0">
  <caption><a name="975953"> </a><div class="TableTitle">Table 2.2  Version of Palm OS required by exchange libraries </div></caption>
  <tr bgcolor="#CCCCCC" valign="top">
    <th><a name="975957"> </a><div class="CellHeading">Exchange Library </div></th>
    <th><a name="975959"> </a><div class="CellHeading">Minimum Palm OS Version </div></th>
  </tr>
  <tr valign="top">
    <td><a name="975962"> </a><div class="CellBody">IR Library (IrDA) </div></td>
    <td><a name="975964"> </a><div class="CellBody">Palm OS 3.0</div></td>
  </tr>
  <tr valign="top">
    <td><a name="975967"> </a><div class="CellBody">Local Exchange Library </div></td>
    <td><a name="975969"> </a><div class="CellBody">Palm OS 4.0</div></td>
  </tr>
  <tr valign="top">
    <td><a name="975972"> </a><div class="CellBody">SMS Library (Short Messaging System)</div></td>
    <td><a name="975974"> </a><div class="CellBody">Palm OS 4.0</div></td>
  </tr>
  <tr valign="top">
    <td><a name="975980"> </a><div class="CellBody">Bluetooth Library<a href="#975979"><span class="Footnote">1</span></a></div></td>
    <td><a name="975982"> </a><div class="CellBody">Palm OS 4.0</div></td>
  </tr>
</table>

<table>
  <tr>
    <td><a name="975979"> </a><div class="FNTFootnoteTable"><a href="#975980"><span class="FootnoteNumber">1. </span></a><a name="975979"> </a><div class="FNTFootnoteTable">Although not present in Palm OS 4.0, Palm plans to provide a Bluetooth Library soon after Palm OS 4.0 ships.</div></div></td>
  </tr>
</table>



</h5><p class="Body">
  <a name="975985"> </a>Included with the Palm OS SDK version 4 is the HostTransfer sample exchange library which can be used as a starting point when creating your own exchange libraries.
</p>

<h2 class="HaHeadA">
  <a name="975987"> </a>Exchange Library Components 
<a href="#975845"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="975988"> </a>This section describes the components that make up an exchange library. The topics covered are:
</p>

  <a name="975992"> </a><p class="B1Bullet"> &#8226; <a href="ExchangeLibraries.html#975999">The Exchange Library API</a></p>

  <a name="975996"> </a><p class="B1Bullet"> &#8226; <a href="ExchangeLibraries.html#976077">Dispatch Table</a></p>

<h2 class="HBHeadB">
  <a name="975999"> </a>The Exchange Library API
<a href="#975845"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="976003"> </a>The Palm OS <a href="ExgLibAPI.html#1244433">Exchange Library</a> API specifies the minimum set of functions that all exchange libraries must implement. These functions can be classified into three major categories: functions that must be included in all shared libraries, functions that establish a connection and send and receive data, and miscellaneous support functions.
</p>

<h4 class="HCHeadC">
  <a name="976004"> </a>Standard Shared Library Functions
</h4>
<p class="Body">
  <a name="976005"> </a>Any Palm OS shared library must implement open, close, sleep, and wake functions.
</p>

  <a name="976009"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244691">ExgLibOpen</a></p>

  <a name="976013"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244482">ExgLibClose</a></p>

  <a name="976017"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244873">ExgLibSleep</a></p>

  <a name="976021"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244890">ExgLibWake</a></p>

<h4 class="HCHeadC">
  <a name="976022"> </a>Functions That Send and Receive Data
</h4>
<p class="Body">
  <a name="976023"> </a>These functions do the work of establishing a connection and sending and receiving data.
</p>

<h5 class="TgTable">
  <a name="976024"> </a>
</h5>
  <a name="976028"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244444">ExgLibAccept</a></p>

  <a name="976032"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244496">ExgLibConnect</a></p>

  <a name="976036"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244574">ExgLibDisconnect</a></p>

  <a name="976040"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244630">ExgLibGet</a></p>

  <a name="976044"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244705">ExgLibPut</a></p>

  <a name="976048"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244764">ExgLibReceive</a></p>

  <a name="976052"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244805">ExgLibRequest</a></p>

  <a name="976056"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244834">ExgLibSend</a></p>
<p class="Body">
  <a name="976057"> </a>Note that each of these corresponds directly to an Exchange Manager function; in most cases the Exchange Manager simply calls the corresponding exchange library function.
</p>

<h4 class="HCHeadC">
  <a name="976058"> </a>Support Functions
</h4>
<p class="Body">
  <a name="976059"> </a>This category consists of functions that provide information about your exchange library and that handle events.
</p>

  <a name="976063"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244541">ExgLibControl</a></p>

  <a name="976067"> </a><p class="B1Bullet"> &#8226; <a href="ExgLibAPI.html#1244670">ExgLibHandleEvent</a></p>
<p class="Body">
  <a name="976068"> </a>Although each of the functions in these three categories must be present in every exchange library, depending on the specific requirements of the exchange library some of them can simply return <span style="font-family: monospace">errNone</span> or <span style="font-family: monospace">exgErrNotSupported</span>.
</p>
<p class="Body">
  <a name="976070"> </a>As with any shared library, the order in which the functions appear in the exchange library's dispatch table identifies the functions in the library. This order is specified in <span style="font-family: monospace">ExgLib.h</span>. Because it's the function's position in the dispatch table and not its name that is important, the actual function names used in a given exchange library may be different from those specified in <span style="font-family: monospace">ExgLib.h</span>. In fact, you'll likely want to use function names that are unique to your shared library, as the Host Transfer library does with such functions as <span style="font-family: monospace">HostTransferLibPut</span>, <span style="font-family: monospace">HostTransferLibSend</span>, and <span style="font-family: monospace">HostTransferLibDisconnect</span>. By using function names specific to your exchange library, you can link your functions into the Mac Simulator and debug with it. If you use the function names defined in <span style="font-family: monospace">ExgLib.h</span> for your functions, you'll get a link error because the Simulator uses those names for stub functions which call your functions.
</p>
<p class="Body">
  <a name="976074"> </a>Beyond the functions listed above, additional library-specific functions must appear in the exchange library's dispatch table after <span style="font-family: monospace">exgLibTrapLast</span>.
</p>

<h2 class="HBHeadB">
  <a name="976077"> </a>Dispatch Table
<a href="#975845"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="976078"> </a>The dispatch table is a map used by the Palm OS to find the functions in the exchange library. At link time, references to the exchange library functions are resolved to a system trap by way of the <span style="font-family: monospace">SYS_TRAP</span> macro. At runtime, when an exchange library function is called, a trap occurs and the trap finds the function in its library dispatch table and computes the function's offset into the code resource of the exchange library. A JMP instruction to the function's address is made, causing the function to be executed.
</p>
<div class="NINoteImportant"><hr>
  <a name="976081"> </a> <span style="color: #333;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">NOTE:  </span> The structure of the dispatch table for exchange libraries is the same as that of shared libraries. Exchange libraries must do everything shared libraries must do, plus they must register with the Exchange Manager. This gives applications access to their services by way of the Exchange Manager APIs such as <a href="ExchangeManager.html#1234399"><span style="font-family: monospace">ExgPut</span></a>.
<hr>
</div>
<p class="Body">
  <a name="976085"> </a>A sample dispatch table source file, <span style="font-family: monospace">HostTransferDispatch.c</span>, is provided with the OS SDK. <a href="ExchangeLibraries.html#976090">Listing 2.1</a> provides a sample of the dispatch table contained within this file (some parts are omitted for clarity).
</p>
<p class="CCodeCaption">
  <a name="976090"> </a>Listing 2.1  HostTransferDispatch.c
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
...<a name="976091"> </a>
void *PrvHostTransferDispatchTable(void);<a name="976092"> </a>
...<a name="976093"> </a>
extern Err PrvInstallHostTransferDispatcher(UInt16 refNum, SysLibTblEntryType *entryP);<a name="976094"> </a>
...<a name="976095"> </a>
Err __Startup__(UInt16 refNum, SysLibTblEntryType *entryP)<a name="976096"> </a>
{<a name="976097"> </a>
   return PrvInstallHostTransferDispatcher(refNum, entryP);<a name="976098"> </a>
}<a name="976099"> </a>
...<a name="976100"> </a>
asm void *PrvHostTransferDispatchTable(void)<a name="976101"> </a>
{<a name="976102"> </a>
   LEA  @Table, A0            // table ptr<a name="976103"> </a>
   RTS                                 // exit with it<a name="976104"> </a>
 <a name="976105"> </a>
@Table:<a name="976106"> </a>
   DC.W  @Name<a name="976107"> </a>
   DC.W  (kOffset)       // Open<a name="976108"> </a>
   DC.W  (kOffset+(1*4))   // Close<a name="976109"> </a>
   DC.W  (kOffset+(2*4))   // Sleep<a name="976110"> </a>
   DC.W  (kOffset+(3*4))   // Wake<a name="976111"> </a>
   // Start of the exchange libary<a name="976112"> </a>
   DC.W  (kOffset+(4*4)) // HostTransferLibHandleEvent<a name="976113"> </a>
...<a name="976114"> </a>
   DC.W  (kOffset+(12*4))  // HostTransferLibControl<a name="976115"> </a>
   DC.W  (kOffset+(13*4))  // HostTransferLibRequest<a name="976116"> </a>
 <a name="976117"> </a>
@GotoOpen:<a name="976118"> </a>
   JMP   HostTransferLibOpen<a name="976119"> </a>
@GotoClose:<a name="976120"> </a>
   JMP   HostTransferLibClose<a name="976121"> </a>
@GotoSleep:<a name="976122"> </a>
   JMP   HostTransferLibSleep<a name="976123"> </a>
@GotoWake:<a name="976124"> </a>
   JMP   HostTransferLibWake<a name="976125"> </a>
 <a name="976126"> </a>
@GotoHandleEvent:<a name="976127"> </a>
   JMP   HostTransferLibHandleEvent<a name="976128"> </a>
...<a name="976129"> </a>
@GotoOption:<a name="976130"> </a>
   JMP   HostTransferLibControl<a name="976131"> </a>
@GotoCheck:<a name="976132"> </a>
   JMP   HostTransferLibRequest<a name="976133"> </a>
 <a name="976134"> </a>
@Name:<a name="976135"> </a>
   DC.B  HostTransferName<a name="976136"> </a>
}<a name="976137"> </a>
...<a name="976138"> </a>
 <a name="976139"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="976140"> </a>The last entry in the dispatch table is the name of the exchange library. This must match the name of the database containing the exchange library, and on the simulator, it must end with <span style="font-family: monospace">"-</span><i>crid</i><span style="font-family: monospace">"</span>, where <i>crid</i> is the creator ID. For example, the Host Transfer library uses <span style="font-family: monospace">"HostTransfer Library-HXfr"</span>.
</p>
<p class="Body">
  <a name="976141"> </a>The code segment must be locked so that the dispatch table itself, and the routine addresses in it, will remain valid. The library's database is automatically protected so that it cannot be deleted.
</p>
<div class="NINoteImportant"><hr>
  <a name="976143"> </a> <span style="color: #333;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">NOTE:  </span> The system's shared library table has a slot for library globals for each loaded library. The start-up routine should at least zero this field, if not actually allocate the globals. Some libraries allocate a small structure with an <span style="font-family: monospace">openCount</span> and leave the larger allocation for later, when the library is opened by way of the library's <span style="font-family: monospace">Open()</span> entry point. In this case, the small structure has a reference to the larger one.
<hr>
</div>
<p class="Body">
  <a name="976146"> </a>The code resource of an exchange library must start with a routine that sets up the dispatch table. This routine must be named <span style="font-family: monospace">__Startup__</span>. The prototype for this function is:
</p>
<pre  class="Preformatted">
Err __Startup__(UInt16 refNum,
	SysLibTblEntryType *entryP)<a name="976148"> </a>
</pre>
<p class="Body">
  <a name="976149"> </a>Usually, <span style="font-family: monospace">__Startup__</span> consists of a one line call in a <span style="font-family: monospace">MyLibDispatch.c</span> file that calls the actual setup routine in a corresponding <span style="font-family: monospace">MyLib.c</span> file. For example, in the <span style="font-family: monospace">HostTransferDispatch.c</span> sample file provided with the OS SDK the following is used to install the HostTransfer dispatch table:
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
extern Err PrvInstallHostTransferDispatcher(UInt16 refNum,
SysLibTblEntryType *entryP);<a name="976150"> </a>
...<a name="976151"> </a>
Err __Startup__(UInt16 refNum, SysLibTblEntryType *entryP)<a name="976152"> </a>
{<a name="976153"> </a>
	return PrvInstallHostTransferDispatcher(refNum, entryP);<a name="976154"> </a>
}<a name="976155"> </a>
...<a name="976156"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="976157"> </a><span style="font-family: monospace">__Startup__</span> is called to set up the dispatch table when a call to <a href="SystemManager.html#1166185"><span style="font-family: monospace">SysLibInstall</span></a> or <a href="SystemManager.html#1166207"><span style="font-family: monospace">SysLibLoad</span></a> is made. For example:
</p>
<pre  class="Preformatted">
SysLibInstall(PrvInstallHostTransferDispatcher, &amp;refNum);<a name="976164"> </a>
</pre>
<p class="Body">
  <a name="976168"> </a><a href="ExchangeLibraries.html#976174">Listing 2.2</a> shows how the HostTransfer dispatch table installer function is implemented. This function can be found in the OS SDK sample file <span style="font-family: monospace">HostTransferLib.c</span>. The dispatch table installer function is responsible for making the system's library table entry (<span style="font-family: monospace">entryP</span>) point to the dispatch table. For example:
</p>
<pre  class="Preformatted">
entryP-&gt;dispatchTblP =
  (MemPtr *)PrvHostTransferDispatchTable();<a name="976169"> </a>
</pre>
<p class="Body">
  <a name="976170"> </a>The dispatch installer routine generally does a bit of initialization as well.
</p>
<p class="CCodeCaption">
  <a name="976174"> </a>Listing 2.2  Host transfer dispatch table installer function
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
Err PrvInstallHostTransferDispatcher(UInt16 refNum, SysLibTblEntryType *entryP)<a name="976175"> </a>
{<a name="976176"> </a>
   Err err;<a name="976177"> </a>
   HostTransferGlobalsType *gP;<a name="976178"> </a>
   UInt32 value;<a name="976179"> </a>
   Char macro[14];<a name="976180"> </a>
   <a name="976181"> </a>
   // Must be 4.0 or greator<a name="976182"> </a>
   err = FtrGet(sysFtrCreator, sysFtrNumROMVersion, &amp;value);<a name="976183"> </a>
   if (err || value &lt; kVersion4_0) return -1;<a name="976184"> </a>
   <a name="976185"> </a>
   // Allocate library globals and store pointer to them in the system's <a name="976186"> </a>
   // library table<a name="976187"> </a>
   gP = MemPtrNew(sizeof(HostTransferGlobalsType));<a name="976188"> </a>
   ErrFatalDisplayIf(!gP, "No memory for globals");<a name="976189"> </a>
   if (gP)<a name="976190"> </a>
      {<a name="976191"> </a>
      MemPtrSetOwner(gP, 0);<a name="976192"> </a>
      MemSet(gP, sizeof(HostTransferGlobalsType), 0);<a name="976193"> </a>
      gP-&gt;refNum = refNum;   // make self reference<a name="976194"> </a>
      entryP-&gt;globalsP = gP;<a name="976195"> </a>
      }<a name="976196"> </a>
 <a name="976197"> </a>
   // Install pointer to our dispatch table in system's library table<a name="976198"> </a>
   entryP-&gt;dispatchTblP = (MemPtr *)PrvHostTransferDispatchTable();<a name="976199"> </a>
   <a name="976200"> </a>
   // Check if we're running on the simulator or emulator. On a real device,<a name="976201"> </a>
   // there's no host so we don't register this library with the Exchange<a name="976202"> </a>
   // Manager. In this case, we should really abort the library installation<a name="976203"> </a>
   // altogether, but this demonstrates how exchange libs can change their<a name="976204"> </a>
   // registration status.<a name="976205"> </a>
#if EMULATION_LEVEL == EMULATION_NONE<a name="976206"> </a>
   if (FtrGet('pose', 0, &amp;value) != ftrErrNoSuchFeature)<a name="976207"> </a>
#endif<a name="976208"> </a>
      {<a name="976209"> </a>
      Char description[exgTitleBufferSize + 1];<a name="976210"> </a>
      UInt16 descriptionSize = sizeof(description);<a name="976211"> </a>
      Err err;<a name="976212"> </a>
      <a name="976213"> </a>
      // Get the title of the library<a name="976214"> </a>
      err = HostTransferLibControl(refNum, exgLibCtlGetTitle, &amp;description,
         &amp;descriptionSize);<a name="976215"> </a>
      if (! err)<a name="976216"> </a>
         {<a name="976217"> </a>
         // Register this library with the Exchange Manager<a name="976218"> </a>
         err = ExgRegisterDatatype(HostTransferCreator, exgRegSchemeID,<a name="976219"> </a>
           kHostTransferScheme "\t" exgSendScheme, description, 0 /*flags*/);<a name="976220"> </a>
         }<a name="976221"> </a>
      }<a name="976222"> </a>
   <a name="976223"> </a>
   // Add a magic macro to initiate ExgRequest<a name="976224"> </a>
   StrCopy(macro, "\x01" "0117" "0000" "0408");<a name="976225"> </a>
   // virtualkeycode,vchrIrReceive,refnum,libEvtHookKeyMask<a name="976226"> </a>
   macro[7] = PrvHexToAscii((refNum&gt;&gt;4) &amp; 0x0f); // put refnum into string as hex<a name="976227"> </a>
   macro[8] = PrvHexToAscii(refNum &amp; 0x0f);<a name="976228"> </a>
   PrvDeleteExistingMacro(".r");<a name="976229"> </a>
   GrfAddMacro(".r", (UInt8 *)macro, 13);<a name="976230"> </a>
   <a name="976231"> </a>
   return err;<a name="976232"> </a>
}<a name="976233"> </a>
</pre><div class="CodeRule"><hr></div>

<h2 class="HaHeadA">
  <a name="976235"> </a>Implementing an Exchange Library 
<a href="#975845"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="976236"> </a>In order to work with the Palm OS Exchange Manager, an exchange library must implement a required set of functions and must register with the Exchange Manager.
</p>

<h2 class="HBHeadB">
  <a name="976238"> </a>Required Functions
<a href="#975845"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="976239"> </a>Exchange libraries contain functions to handle implementation specifics of a particular transport plus the functions required by the <a href="ExgLibAPI.html#1244433">Exchange Library</a> API. Functions required to handle transport-specific tasks or other tasks that aren't specific to the Exchange Library API are outside the scope of this document. In general, however, other functions required by the exchange library could include tasks such as polling devices, handling interrupts, or checking for user input.
</p>
<p class="Body">
  <a name="976243"> </a>Depending on the application, the exchange library's requirements may be send only, receive only, or both. At a minimum, when sending objects, <a href="ExgLibAPI.html#1244705"><span style="font-family: monospace">ExgLibPut</span></a>, <a href="ExgLibAPI.html#1244834"><span style="font-family: monospace">ExgLibSend</span></a>, and <a href="ExgLibAPI.html#1244574"><span style="font-family: monospace">ExgLibDisconnect</span></a> are typically required; for receiving objects, <a href="ExgLibAPI.html#1244444"><span style="font-family: monospace">ExgLibAccept</span></a>, <a href="ExgLibAPI.html#1244764"><span style="font-family: monospace">ExgLibReceive</span></a>, and <a href="ExgLibAPI.html#1244574"><span style="font-family: monospace">ExgLibDisconnect</span></a> are needed. See <a href="ExgLibAPI.html#1244433">Chapter 58, "Exchange Library,"</a> of the <i>Palm OS Programmer's API Reference</i> for a detailed description of each exchange library function.
</p>

<h4 class="HCHeadC">
  <a name="976345"> </a>Implementing ExgLibAccept
</h4>
<p class="Body">
  <a name="976346"> </a>There are two situations in which an application calls the Exchange Manager's <a href="ExchangeManager.html#1233284"><span style="font-family: monospace">ExgAccept</span></a> function:
</p>

  <a name="976350"> </a><p class="B1Bullet"> &#8226; The application wants to initiate a connection to receive data, which it does in response to <span style="font-family: monospace">sysAppLaunchCmdExgReceiveData</span>.</p>

  <a name="976351"> </a><p class="B1Bullet"> &#8226; The application wants to initiate a connection to receive a preview of the data, which it does in response to <span style="font-family: monospace">sysAppLaunchCmdExgAskUser</span>.</p>
<p class="Body">
  <a name="976355"> </a>The Exchange Manager in turn calls <a href="ExgLibAPI.html#1244444"><span style="font-family: monospace">ExgLibAccept</span></a>. 
</p>
<p class="Body">
  <a name="976357"> </a>When previewing data, you must buffer incoming data. Your <span style="font-family: monospace">ExgLibAccept</span> function should observe the preview flag and rewind the buffer, preparing for non-destructive read. When it is called again without the preview flag, it should rewind again, this time preparing for destructive read. 
</p>
<p class="Body">
  <a name="976358"> </a><span style="font-family: monospace">ExgLibAccept</span> must update any progress dialogs to indicate that data is being accepted, or received, into an application.
</p>

<h4 class="HCHeadC">
  <a name="976360"> </a>Handling Connection Errors
</h4>
<p class="Body">
  <a name="976365"> </a><a href="ExgLibAPI.html#1244496"><span style="font-family: monospace">ExgLibConnect</span></a> can be used by exchange libraries as a convenient place to put code that needs to be executed prior to the first <a href="ExgLibAPI.html#1244705"><span style="font-family: monospace">ExgLibPut</span></a> call. Many exchange libraries don't support <span style="font-family: monospace">ExgLibConnect</span>, however, instead establishing a connection in the initial call to <span style="font-family: monospace">ExgLibPut</span>. If your library doesn't need to support <span style="font-family: monospace">ExgLibConnect</span>, your implementation of this function should simply return <span style="font-family: monospace">errNone</span>.
</p>
<p class="Body">
  <a name="976369"> </a>If your exchange library doesn't support <span style="font-family: monospace">ExgLibConnect</span> and an error occurs during the initial call to <span style="font-family: monospace">ExgLibPut</span>, your implementation of <span style="font-family: monospace">ExgLibPut</span> should clean up after itself; it should not count on <a href="ExgLibAPI.html#1244574"><span style="font-family: monospace">ExgLibDisconnect</span></a> being called. If the initial call to <span style="font-family: monospace">ExgLibPut</span> succeeds, however, cleanup of subsequent errors can be done in <span style="font-family: monospace">ExgLibDisconnect</span>.
</p>
<p class="Body">
  <a name="976373"> </a>If your exchange library does support <span style="font-family: monospace">ExgLibConnect</span> and an error occurs during a call to it, <span style="font-family: monospace">ExgLibConnect</span> should clean up after itself. Cleanup of errors that occur after a successful call to <span style="font-family: monospace">ExgLibConnect</span>, however, can be delegated to <span style="font-family: monospace">ExgLibDisconnect</span>.
</p>
<p class="Body">
  <a name="976374"> </a>Finally, if your exchange library supports <span style="font-family: monospace">ExgLibConnect</span> but the application doesn't call it prior to calling <span style="font-family: monospace">ExgLibPut</span>, the situation is as if your library didn't implement <span style="font-family: monospace">ExgLibConnect</span>: if an error occurs during the initial call to <span style="font-family: monospace">ExgLibPut</span> your implementation of <span style="font-family: monospace">ExgLibPut</span> should clean up after itself, while if the initial call to <span style="font-family: monospace">ExgLibPut</span> succeeds you can clean up after any subsequent errors in <span style="font-family: monospace">ExgLibDisconnect</span>.
</p>
<p class="Body">
  <a name="976375"> </a>Note that you must support <span style="font-family: monospace">ExgLibConnect</span> if your exchange library supports two-way communication as discussed in <a href="ExchangeManagerConcept.html#971077">"Two-Way Communications."</a>
</p>

<h4 class="HCHeadC">
  <a name="976380"> </a>Buffering Data
</h4>
<p class="Body">
  <a name="976381"> </a>Data can be sent by the exchange library as it receives it by using <a href="ExgLibAPI.html#1244834"><span style="font-family: monospace">ExgLibSend</span></a> calls or by buffering the data and sending it in response to an <a href="ExgLibAPI.html#1244574"><span style="font-family: monospace">ExgLibDisconnect</span></a> call. Buffering has some advantages. For example, the communication stack does not have to share cycles with the sending or receiving application and the communication hardware is on for the shortest possible time, conserving battery power. One drawback is that buffering requires extra storage that could be problematic if the amount of data exchanged is large.
</p>

<h2 class="HBHeadB">
  <a name="976392"> </a>Registering with the Exchange Manager
<a href="#975845"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="976393"> </a>Exchange libraries, like applications, must register with the Exchange Manager for the object types they are to receive. Exchange libraries typically register for two URL schemes, one that is used to uniquely identify the exchange library, and one for how it is used.
</p>
<p class="Body">
  <a name="976396"> </a>For example, the IR library registers for "_irobex", which identifies the specific protocol, and for "_beam" which makes it accessible from the Beam command. The Host Transfer sample exchange library registers for "_host" and "_send". The latter registration makes it accessible from the Send command. Most exchange libraries will probably want to register for the "_send" scheme. These URL schemes all start with an underscore to avoid conflicting with standard URL schemes like "http" and "mailto". See <a href="ExchangeManagerConcept.html#970212">Table 1.3</a> in <a href="ExchangeManagerConcept.html#969979">Chapter 1, "Object Exchange,"</a> for the supported URL schemes.
</p>

<h2 class="HaHeadA">
  <a name="976406"> </a>Summary of Exchange Library 
<a href="#975845"><img src="images/top.gif" border="0"></a></h2>


<h5 class="TgTable">
  <a name="976502"> </a>

<table border="1" cellpadding="5" cellspacing="0">
  <caption></caption>
  <tr bgcolor="#CCCCCC" valign="top">
    <th colspan="2" rowspan="1"><a name="976409"> </a><div class="CellHeading">Exchange Library Functions</div></th>
  </tr>
  <tr valign="top">
    <td><a name="976413"> </a><div class="CellHeading">Handling the Connection</div></td>
    <td><a name="976415"> </a><div class="CellHeading"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="976420"> </a><div class="CellBody"><a href="ExgLibAPI.html#1244496"><span style="font-family: monospace">ExgLibConnect</span></a><br><a href="ExgLibAPI.html#1244574"><span style="font-family: monospace">ExgLibDisconnect</span></a></div></td>
    <td><a name="976428"> </a><div class="CellBody"><a href="ExgLibAPI.html#1244444"><span style="font-family: monospace">ExgLibAccept</span></a><br><a href="ExgLibAPI.html#1244705"><span style="font-family: monospace">ExgLibPut</span></a></div></td>
  </tr>
  <tr valign="top">
    <td><a name="976433"> </a><div class="CellHeading">Requesting Data</div></td>
    <td><a name="976435"> </a><div class="CellHeading"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="976440"> </a><div class="CellBody"><a href="ExgLibAPI.html#1244630"><span style="font-family: monospace">ExgLibGet</span></a></div></td>
    <td><a name="976445"> </a><div class="CellBody"><a href="ExgLibAPI.html#1244805"><span style="font-family: monospace">ExgLibRequest</span></a></div></td>
  </tr>
  <tr valign="top">
    <td><a name="976447"> </a><div class="CellHeading">Transferring Data </div></td>
    <td><a name="976449"> </a><div class="CellHeading"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="976454"> </a><div class="CellBody"><a href="ExgLibAPI.html#1244764"><span style="font-family: monospace">ExgLibReceive</span></a></div></td>
    <td><a name="976459"> </a><div class="CellBody"><a href="ExgLibAPI.html#1244834"><span style="font-family: monospace">ExgLibSend</span></a></div></td>
  </tr>
  <tr valign="top">
    <td><a name="976461"> </a><div class="CellHeading">Querying the Exchange Library</div></td>
    <td><a name="976463"> </a><div class="CellHeading"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="976468"> </a><div class="CellBody"><a href="ExgLibAPI.html#1244541"><span style="font-family: monospace">ExgLibControl</span></a></div></td>
    <td><a name="976470"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="976472"> </a><div class="CellHeading">Handling Events</div></td>
    <td><a name="976474"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="976479"> </a><div class="CellBody"><a href="ExgLibAPI.html#1244670"><span style="font-family: monospace">ExgLibHandleEvent</span></a></div></td>
    <td><a name="976481"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="976483"> </a><div class="CellHeading">Required Shared Library Functions</div></td>
    <td><a name="976485"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="976490"> </a><div class="CellBody"><a href="ExgLibAPI.html#1244691"><span style="font-family: monospace">ExgLibOpen</span></a><br><a href="ExgLibAPI.html#1244482"><span style="font-family: monospace">ExgLibClose</span></a></div></td>
    <td><a name="976498"> </a><div class="CellBody"><a href="ExgLibAPI.html#1244873"><span style="font-family: monospace">ExgLibSleep</span></a><br><a href="ExgLibAPI.html#1244890"><span style="font-family: monospace">ExgLibWake</span></a></div></td>
  </tr>
</table>




</h5>
&nbsp;<br>
				<!-- CONTENT_END -->

		</td>
		<td width="5">&nbsp;&nbsp;</td>
	</tr>
      </table>
    </td>
			</tr>
  <tr>
				<td>
					<table border="0" cellpadding="0" cellspacing="0" width="760">
        <!-- CONTENTCELL_END -->
        <tr valign="top"> 
          <td width="10">&nbsp;<!-- FOOTER_START --></td>
          <td width="72">&nbsp;</td>
          <td width="25" bgcolor="white" background="images/bkgrnd.gif">&nbsp;</td>
          <td width="600"> 
            <table border="0" cellpadding="0" cellspacing="0" width="600">
              <tr> 
                <td><img src="images/rule_10-1-5_ltblue.gif" width="600" height="16" border="0"></td>
              </tr>
              <tr> 
                <td> 
                  <p align="center" class="footer"> ©2002 PalmSource, Inc. and its affiliates.  All rights reserved. 
<a href="http://www.palmos.com/dev/training/">Training</a>&nbsp;|&nbsp;<a href="http://www.palmos.com/dev/support/kb/">Knowledge Base</a>&nbsp;|&nbsp;<a href="http://www.palmos.com/">Palm&nbsp;OS&nbsp;Platform</a>&nbsp;|&nbsp;<a href="Companion2Front.html" target="_blank">Legal Notices</a>&nbsp;<br>
												<!-- FOOTER_END --><br>
											</p>
                </td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
				</td>
			</tr>
</table>
</BODY>
</HTML>