<HTML>

<HEAD>
<SMALLSCREENIGNORE> 
<LINK HREF="copy_of_palmos.css" REL="stylesheet" TYPE="text/css">
<LINK HREF="document.css" REL="StyleSheet" TYPE="text/css" media="screen">
<!-- SCRIPT_START -->
<!-- SCRIPT_END -->
</SMALLSCREENIGNORE>
<TITLE>Palm System Support</TITLE>

<META NAME="PALMTEMPLATE" CONTENT="1006-002 Palm HTML 20020513">
<META NAME="GENERATOR" CONTENT="Quadralay WebWorks Publisher Professional Edition 6.0.7">
<META NAME="TEMPLATEBASE" CONTENT="Palm HTML 20010625">
<META NAME="LASTUPDATED" CONTENT="12/13/02 10:05:57">
<META HTTP-EQUIV="content-type" CONTENT="text/html;charset=ISO-8859-1">

</HEAD>

<BODY LEFTMARGIN="0" MARGINWIDTH="0" TOPMARGIN="0" MARGINHEIGHT="0">
<SMALLSCREENIGNORE> 
<table width="100%" border="0" cellspacing="0" cellpadding="0">
  <tr>
	<td><a name="1013426"></a>
      <table border="0" cellpadding="0" cellspacing="0" width="100%">
        <tr height="35"> 
          <td height="35" colspan="2" bgcolor="#6699CC">&nbsp;</td>
        </tr>
        <tr valign="top"> 
          <td width="160" align="left"><a href="http://www.palmos.com"><img src="images/bigorb.gif" width="160" height="110" border="0"></a></td>
          <td align="left" width="100%"> 
            </SMALLSCREENIGNORE>
            <!-- CONTENTCELL_START -->
            <img border="0" height="45" src="images/orb_bkgrnd_600.gif" width="600"><br>
            <!--PAGENAV_START-->
            <SPAN CLASS="subnav">&nbsp;&lt;&nbsp;<A HREF="http://www.palmos.com/index.html">Home</a> 
              &nbsp;&nbsp;&lt;&nbsp;<A HREF="http://www.palmos.com/dev/">Developers</a> 
              &nbsp;&nbsp;&lt;&nbsp;<A HREF="http://www.palmos.com/dev/support/">Development Support</a>
              &nbsp;&nbsp;&lt;&nbsp;<A HREF="http://www.palmos.com/dev/support/docs/">Documentation</a></span><BR>
             <img src="images/pixel_ltblue.gif" width="600" height="1" border="0" vspace="2"><br>
             <h2 class="HeadDocPage">10  Palm System Support</h2>
             <img src="images/pixel_ltblue.gif" width="600" height="1" border="0" vspace="2"><br>
             &nbsp;<span class="subnav"><a href="CompanionTOC.html">Table of Contents</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="AttnsAndAlarms.html">&lt;&nbsp;Previous</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="Localization.html">Next&nbsp;&gt;</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="CompanionIX.html">Index</a></span>  
            <!--PAGENAV_END-->
          </td>
        </tr>
      </table>
    </td>
			</tr>
  <tr>
				<td> 
      <table width="100%" border="0" cellspacing="0" cellpadding="0">
        <tr>
							<td>&nbsp;&nbsp;&nbsp;</td>
						</tr>
        <tr>
		<td valign="top" width="10">&nbsp;&nbsp;&nbsp;</td>
		<td valign="top" width="175">
			<p class="SideTitle">Title - <br><a href="Companion_Front.html">Palm OS® Programmer's Companion</a></p>
			<p class="SideTOC1-PartTab">Volume I </p>
			<p class="SideTOC1"><a href="SystemFeatures.html">10  Palm System Support</a></p>
			
<p class="SideTOC2">
<a href="#1013479">Features
</a></p>

<p class="SideTOC3">
<a href="#1013505">The System Version Feature
</a></p>

<p class="SideTOC3">
<a href="#1013564">Application-Defined Features
</a></p>

<p class="SideTOC3">
<a href="#1013569">Using the Feature Manager
</a></p>

<p class="SideTOC3">
<a href="#1013590">Feature Memory
</a></p>

<p class="SideTOC2">
<a href="#1013637">Preferences
</a></p>

<p class="SideTOC3">
<a href="#1013655">Accessing System Preferences
</a></p>

<p class="SideTOC3">
<a href="#1013745">Setting System Preferences
</a></p>

<p class="SideTOC3">
<a href="#1013765">Setting Application-Specific Preferences
</a></p>

<p class="SideTOC2">
<a href="#1028953">Sound
</a></p>

<p class="SideTOC3">
<a href="#1028706">Simple Sound
</a></p>

<p class="SideTOC3">
<a href="#1028720">Sampled Sound
</a></p>

<p class="SideTOC3">
<a href="#1028737">Simple vs Sampled
</a></p>

<p class="SideTOC3">
<a href="#1028745">Sound Preferences
</a></p>

<p class="SideTOC3">
<a href="#1028785">Standard MIDI Files
</a></p>

<p class="SideTOC3">
<a href="#1028840">Creating a Sound Stream
</a></p>

<p class="SideTOC2">
<a href="#1014357">System Boot and Reset
</a></p>

<p class="SideTOC3">
<a href="#1014361">Soft Reset
</a></p>

<p class="SideTOC3">
<a href="#1014369">Soft Reset + Up Arrow
</a></p>

<p class="SideTOC3">
<a href="#1014375">Hard Reset
</a></p>

<p class="SideTOC3">
<a href="#1014382">System Reset Calls
</a></p>

<p class="SideTOC2">
<a href="#1014391">ARM-Native Functions
</a></p>

<p class="SideTOC3">
<a href="#1014424">Calling an ARM Function
</a></p>

<p class="SideTOC3">
<a href="#1024777">ARM Function Definition
</a></p>

<p class="SideTOC3">
<a href="#1014448">Accessing 68K Data From an ARM Function
</a></p>

<p class="SideTOC3">
<a href="#1014452">Embedding ARM Code in a 68K Application
</a></p>

<p class="SideTOC3">
<a href="#1014490">Calling Palm OS Functions From ARM Code
</a></p>

<p class="SideTOC2">
<a href="#1014605">Hardware Interaction
</a></p>

<p class="SideTOC3">
<a href="#1014623">Palm OS Power Modes
</a></p>

<p class="SideTOC3">
<a href="#1014641">Guidelines for Application Developers
</a></p>

<p class="SideTOC3">
<a href="#1014654">Power Management Calls
</a></p>

<p class="SideTOC2">
<a href="#1014669">The Microkernel
</a></p>

<p class="SideTOC2">
<a href="#1014692">Retrieving the ROM Serial Number
</a></p>

<p class="SideTOC2">
<a href="#1014739">Time
</a></p>

<p class="SideTOC3">
<a href="#1014768">Using Real-Time Clock Functions
</a></p>

<p class="SideTOC3">
<a href="#1014788">Using System Ticks Functions
</a></p>

<p class="SideTOC2">
<a href="#1014810">Floating-Point
</a></p>

<p class="SideTOC2">
<a href="#1014866">Summary of System Features
</a></p>

		</td>

		<td width="5">&nbsp;&nbsp;</td>
		<td width="1" bgcolor="#6699cc">&nbsp;</td>
		<td width="5">&nbsp;&nbsp;</td>
		<td> 

				<!-- CONTENT_START -->

<p class="Body">
  <a name="1013427"> </a>In this chapter, you learn how to work with the miscellaneous supporting functionality that the Palm OS<sup>®</sup> system provides, such as sound, time, and floating-point operations. Most parts of the Palm OS are controlled by a manager, which is a group of functions that work together to implement a certain functionality. As a rule, all functions that belong to one manager use the same prefix and work together to implement a certain aspect of functionality. 
</p>
<p class="Body">
  <a name="1013429"> </a>This chapter discusses these topics: 
</p>

  <a name="1013433"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013479">Features</a> </p>

  <a name="1013437"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013637">Preferences</a></p>

  <a name="1013441"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1028953">Sound</a> </p>

  <a name="1013445"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014357">System Boot and Reset</a> </p>

  <a name="1013449"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014391">ARM-Native Functions</a></p>

  <a name="1013453"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014605">Hardware Interaction</a></p>

  <a name="1021497"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014669">The Microkernel</a></p>

  <a name="1021505"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014692">Retrieving the ROM Serial Number</a> </p>

  <a name="1021509"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014739">Time</a> </p>

  <a name="1013473"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014810">Floating-Point</a> </p>

  <a name="1013477"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014866">Summary of System Features</a></p>

<h2 class="HaHeadA">
  <a name="1013479"> </a>Features 
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1013482"> </a>A <span style="color: #333;;  font-style: italic; font-weight: normal; text-decoration: none; text-transform: none; vertical-align: baseline">feature</span> is a 32-bit value that has special meaning to both the feature publisher and to users of that feature. Features can be published by the system or by applications. 
</p>
<p class="Body">
  <a name="1013483"> </a>Each feature is identified by a feature creator and a feature number: 
</p>

  <a name="1013484"> </a><p class="B1Bullet"> &#8226; The feature creator is a unique creator registered with PalmSource, Inc. You usually use the creator type of the application that publishes the feature. </p>

  <a name="1013485"> </a><p class="B1Bullet"> &#8226; The feature number is any 16-bit value used to distinguish between different features of a particular creator.</p>
<p class="Body">
  <a name="1013486"> </a>Once a feature is published, it remains present until it is explicitly unregistered or the handheld is reset. A feature published by an application sticks around even after the application quits.
</p>
<p class="Body">
  <a name="1013487"> </a>This section introduces the feature manager by discussing these topics: 
</p>

  <a name="1013491"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013505">The System Version Feature</a></p>

  <a name="1013495"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013564">Application-Defined Features</a></p>

  <a name="1013499"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013569">Using the Feature Manager</a></p>

  <a name="1013503"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013590">Feature Memory</a></p>

<h2 class="HBHeadB">
  <a name="1013505"> </a>The System Version Feature
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1013507"> </a>An example for a feature is the system version. This feature is published by the system and contains a 32-bit representation of the system version. The system version has a feature creator of <span style="font-family: monospace">sysFtrCreator</span> and a feature number of <span style="font-family: monospace">sysFtrNumROMVersion</span>). Currently, the different versions of the system software have the following numbers:
</p>

<h5 class="TgTable">
  <a name="1013539"> </a>

<table width="450" border="0" cellpadding="5" cellspacing="0">
  <caption></caption>
  <tr valign="top">
    <td><a name="1013512"> </a><div class="CellBody"><span style="color: #333;;  font-style: normal; font-weight: normal; text-decoration: none; text-transform: none; vertical-align: baseline">0x01003001</span></div></td>
    <td><a name="1013514"> </a><div class="CellBody">Palm OS 1.0</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013516"> </a><div class="CellBody">0x02003000</div></td>
    <td><a name="1013518"> </a><div class="CellBody">Palm OS 2.0</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013520"> </a><div class="CellBody">0x03003000</div></td>
    <td><a name="1013522"> </a><div class="CellBody">Palm OS 3.0</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013524"> </a><div class="CellBody">0x03103000</div></td>
    <td><a name="1013526"> </a><div class="CellBody">Palm OS 3.1</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013528"> </a><div class="CellBody">0x03203000</div></td>
    <td><a name="1013530"> </a><div class="CellBody">Palm OS 3.2</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013532"> </a><div class="CellBody">0x03503000</div></td>
    <td><a name="1013534"> </a><div class="CellBody">Palm OS 3.5</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013536"> </a><div class="CellBody">0x04003000</div></td>
    <td><a name="1013538"> </a><div class="CellBody">Palm OS 4.0</div></td>
  </tr>
</table>




</h5><p class="Body">
  <a name="1013540"> </a>Rather than hard wiring an obscure constant like one of the above into your code, however, you can use the <span style="font-family: monospace">sysMakeROMVersion</span> macro (defined in <span style="font-family: monospace">SystemMgr.h</span>) to construct a version number for comparison purposes. It takes five parameters:
</p>

  <a name="1013542"> </a><p class="B1Bullet"> &#8226; Major version number</p>

  <a name="1013543"> </a><p class="B1Bullet"> &#8226; Minor version number</p>

  <a name="1013544"> </a><p class="B1Bullet"> &#8226; Fix level</p>

  <a name="1013545"> </a><p class="B1Bullet"> &#8226; Build stage (either <span style="font-family: monospace">sysROMStageDevelopment</span>,<br><span style="font-family: monospace">sysROMStageAlpha</span>, <span style="font-family: monospace">sysROMStageBeta</span>, or<br><span style="font-family: monospace">sysROMStageRelease</span>)</p>

  <a name="1013546"> </a><p class="B1Bullet"> &#8226; Build number</p>
<p class="Body">
  <a name="1013547"> </a>The fix level and build number parameters are normally set to zero, while build stage is usually set to <span style="font-family: monospace">sysROMStageRelease</span>. Simply check to see whether <span style="font-family: monospace">sysFtrNumROMVersion</span> is greater than or equal to the version number constructed with <span style="font-family: monospace">sysMakeROMVersion</span>, as shown here:
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
// See if we're on ROM version 3.1 or later.<a name="1013548"> </a>
FtrGet(sysFtrCreator, sysFtrNumROMVersion, &amp;romVersion);<a name="1013549"> </a>
if (romVersion &gt;= sysMakeROMVersion(3, 1, 0,<a name="1013550"> </a>
    sysROMStageRelease, 0)) {<a name="1013551"> </a>
   ....<a name="1013552"> </a>
}<a name="1013553"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="1013555"> </a>Other system features are defined in <span style="font-family: monospace">SystemMgr.h</span>. System features are stored in a feature table in the ROM. (In Palm OS 3.1 and higher, the contents of this table are copied into the RAM feature table at system startup.) Checking for the presence of system features allows an application to be compatible with multiple versions of the system by refining its behavior depending on which capabilities are present or not. Future hardware platforms may lack some capabilities present in the first platform, so checking the system version feature is important. 
</p>
<div class="NINoteImportant"><hr>
  <a name="1013556"> </a> <span style="color: #333;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">IMPORTANT:  </span> For best results, we recommend that you check for specific features rather than relying on the system version number to determine if a specific API is available. For more details on checking for features, see the appendix <a href="CompatibilityApdx.html#987591">Compatibility Guide</a> in <i>Palm OS Programmer's API Reference</i>.
<hr>
</div>

<h2 class="HBHeadB">
  <a name="1013564"> </a>Application-Defined Features
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1013566"> </a>Applications may find the feature manager useful for their own private use. For example, an application may want to publish a feature that contains a pointer to some private data it needs for processing launch codes. Because an application's global data is not generally available while it processes launch codes, using the feature manager is usually the easiest way for an application to get to its data. 
</p>
<p class="Body">
  <a name="1013567"> </a>The feature manager maintains one feature table in the RAM as well as the feature table in the ROM. Application-defined features are stored in the RAM feature table. 
</p>

<h2 class="HBHeadB">
  <a name="1013569"> </a>Using the Feature Manager
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1013574"> </a>To check whether a particular feature is present, call <a href="FeatureManager.html#1110037"><span style="font-family: monospace">FtrGet</span></a> and pass it the feature creator and feature number. If the feature exists, <span style="font-family: monospace">FtrGet</span> returns the 32-bit value of the feature. If the feature doesn't exist, an error code is returned.
</p>
<p class="Body">
  <a name="1013575"> </a>To publish a new feature or change the value of an existing one, call <a href="FeatureManager.html#1110193"><span style="font-family: monospace">FtrSet</span></a> and pass the feature creator, number, and the 32-bit value of the feature. A published feature remains available until it is explicitly removed by a call to <a href="FeatureManager.html#1110224"><span style="font-family: monospace">FtrUnregister</span></a> or until the system resets; simply quitting an application doesn't remove a feature published by that application. 
</p>
<p class="Body">
  <a name="1013584"> </a>Call <span style="font-family: monospace">FtrUnregister</span> to remove features that were created by calling <span style="font-family: monospace">FtrSet</span>.
</p>
<p class="Body">
  <a name="1013585"> </a>You can get a complete list of all published features by calling <a href="FeatureManager.html#1110060"><span style="font-family: monospace">FtrGetByIndex</span></a> repeatedly. Passing an index value starting at 0 to <span style="font-family: monospace">FtrGetByIndex</span> and incrementing repeatedly by 1 eventually returns all available features. <span style="font-family: monospace">FtrGetByIndex</span> accepts a parameter that specifies whether to search the ROM feature table or RAM feature table. Note that in Palm OS version 3.1 and higher, the contents of the ROM table are copied into the RAM table at system startup; thus the RAM table serves the entire system. 
</p>

<h2 class="HBHeadB">
  <a name="1013590"> </a>Feature Memory
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1013592"> </a>Palm OS 3.1 adds support for <b>feature memory</b>. Feature memory provides quick, efficient access to data that persists between invocations of an application. The values stored in feature memory persist until the handheld is reset or until you explicitly free the memory. Feature memory is memory allocated from the storage heap. Thus, you write to feature memory using <a href="DataAndResourceManager.html#1097774"><span style="font-family: monospace">DmWrite</span></a>, which means that writing to feature memory is no faster than writing to a database. However, feature memory can provide more efficient access to that data in certain circumstances.
</p>
<p class="Body">
  <a name="1013601"> </a>To allocate a chunk of feature memory, call <a href="FeatureManager.html#1110109"><span style="font-family: monospace">FtrPtrNew</span></a>, specifying a feature creator, a feature number, the number of bytes to allocate, and a location where the feature manager can return a pointer to the newly allocated memory chunk. For example:
</p>
<pre  class="Preformatted">
FtrPtrNew(appCreator, 
    myFtrMemFtr, 32, &amp;ftrMem);<a name="1013602"> </a>
</pre>
<p class="Body">
  <a name="1013603"> </a>Elsewhere in your application, you can obtain the pointer to the feature memory chunk using <a href="FeatureManager.html#1110037"><span style="font-family: monospace">FtrGet</span></a>. 
</p>
<div class="NINoteImportant"><hr>
  <a name="1013608"> </a> <span style="color: #333;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">NOTE:  </span> Starting with Palm OS 3.5 <span style="font-family: monospace">FtrPtrNew</span> allows allocating chunks larger than 64KB. Do keep in mind standard issues with allocating large chunks of memory: there might not be enough contiguous space, and it can impact system performance. 
<hr>
</div>
<p class="Body">
  <a name="1013609"> </a>Feature memory is considered a performance optimization. The conditions under which you'd use it are not common, and you probably won't find them in a typical application. You use feature memory in code that: 
</p>

  <a name="1013610"> </a><p class="B1Bullet"> &#8226; Is executed infrequently</p>

  <a name="1013611"> </a><p class="B1Bullet"> &#8226; Does not have access to global variables</p>

  <a name="1013612"> </a><p class="B1Bullet"> &#8226; Needs access to data whose contents change infrequently and that cannot be stored in a 32-bit feature value </p>
<p class="Body">
  <a name="1013613"> </a>For example, suppose you've written a function that is called in response to a launch code, and you expect to receive this launch code frequently. Suppose that function needs access to the application's preferences database. At the start of the function, you'd need to open the database and read the data from it. If the function is called frequently, opening the database each time can be a drain on performance. Instead, you can allocate a chunk of feature memory and write the values you need to that chunk. Because the chunk persists until the handheld is reset, you only need to open the database once. <a href="SystemFeatures.html#1013618">Listing 10.1</a> illustrates this example.
</p>
<p class="CCodeCaption">
  <a name="1013618"> </a>Listing 10.1  Using feature memory 
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
MyAppPreferencesType prefs; <a name="1013619"> </a>
 <a name="1013620"> </a>
if (FtrGet(appCreator, myPrefFtr, (UInt32*)&amp;prefs) != 0) {<a name="1013621"> </a>
 <a name="1013622"> </a>
   // Feature memory doesn't exist, so allocate it.<a name="1013623"> </a>
   FtrPtrNew(appCreator, myPrefFtr, 32, &amp;thePref);<a name="1013624"> </a>
 <a name="1013625"> </a>
   // Load the preferences database. <a name="1013626"> </a>
   PrefGetAppPreferences (appCreator, prefID, &amp;prefs, <a name="1013627"> </a>
      sizeof(prefs), true);<a name="1013628"> </a>
 <a name="1013629"> </a>
   // Write it to feature memory. <a name="1013630"> </a>
   DmWrite(thePref, 0, &amp;prefs, sizeof(prefs));<a name="1013631"> </a>
}<a name="1013632"> </a>
// Now prefs is guaranteed to be defined.<a name="1013633"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="1013634"> </a>Another potential use of feature memory is to "publish" data from your application or library to other applications when that data doesn't fit in a normal 32-bit feature value. For example, suppose you are writing a communications library and you want to publish an icon that client applications can use to draw the current connection state. The library can use <span style="font-family: monospace">FtrPtrNew</span> to allocate a feature memory chunk and store an icon representing the current state in that location. Applications can then use <span style="font-family: monospace">FtrGet</span> to access the icon and pass the result to <span style="font-family: monospace">WinDrawBitmap</span> to display the connection state on the screen. 
</p>

<h2 class="HaHeadA">
  <a name="1013637"> </a>Preferences 
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1013638"> </a>The Preferences Manager handles both system-wide preferences and application-specific preferences. The Preferences Manager maintains preferences in two separate databases: 
</p>

  <a name="1013639"> </a><p class="B1Bullet"> &#8226; The "saved" preferences database contains preferences that are backed up during a HotSync operation. There is one "saved" preferences database that all applications use. This database contains all system-wide preferences as well as application-specific preferences. </p>

  <a name="1013640"> </a><p class="B1Bullet"> &#8226; The "unsaved" preferences database contains application-specific preferences that are not to be backed up during a HotSync operation. There is one "unsaved" preferences database that all application use. </p>
<p class="Body">
  <a name="1013641"> </a>This section describes how to obtain and set values for each of these preferences databases. It covers: 
</p>

  <a name="1013645"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013655">Accessing System Preferences</a></p>

  <a name="1013649"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013745">Setting System Preferences</a></p>

  <a name="1013653"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013765">Setting Application-Specific Preferences</a></p>

<h2 class="HBHeadB">
  <a name="1013655"> </a>Accessing System Preferences
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1013656"> </a>The system preferences specify how users want their Palm Powered<sup>&#8482;</sup> handhelds to behave. For example, system preferences specify how dates and times are displayed and whether the system plays a sound when an alarm fires. These values are typically set using the built-in Preferences or Security application. Applications should, as a rule, respect the values stored in the system preferences. 
</p>
<p class="Body">
  <a name="1013657"> </a>To obtain the value of a system preference, use the <a href="Preferences.html#1146319"><span style="font-family: monospace">PrefGetPreference</span></a> function and pass one of the <a href="Preferences.html#1145328"><span style="font-family: monospace">SystemPreferencesChoice</span></a> enum constants. For example, if an application's user interface displays the current date and time, it could do the following to find out how the user wants the date and time displayed: 
</p>
<pre  class="Preformatted">
TimeFormatType timeFormat = (TimeFormatType)<a name="1013666"> </a>
<span style="color: #333;;  font-style: normal; font-weight: normal; text-decoration: none; text-transform: none; vertical-align: baseline">   </span>PrefGetPreference(prefTimeFormat);<a name="1013667"> </a>
DateFormatType dateFormat = (DateFormatType)<a name="1013668"> </a>
<span style="color: #333;;  font-style: normal; font-weight: normal; text-decoration: none; text-transform: none; vertical-align: baseline">   </span>PrefGetPreference(prefDateFormat);<a name="1013669"> </a>
</pre>
<div class="NWNoteWarning"><hr>
  <a name="1013670"> </a> <span style="color: #FF0000;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">WARNING!  </span> Do not confuse <span style="font-family: monospace">PrefGetPreference</span> with <span style="font-family: monospace">PrefGetPreferences</span>. The latter function is obsolete and retrieves the 1.0 version of the system preferences structure. 
<hr>
</div>
<p class="Body">
  <a name="1013671"> </a>Note that the <span style="font-family: monospace">PrefGetPreference</span> function by default returns a <span style="font-family: monospace">UInt32</span> value. This return value must be cast to the appropriate type for the preference being returned. 
</p>
<p class="Body">
  <a name="1013672"> </a>Also note that the system preferences structure has been updated many times and maintains its own version information. Each Palm OS release that modifies the system preferences structure adds its new values to the end and increments the structure's version number. See <a href="SystemFeatures.html#1013682">Table 10.1</a>.
</p>

<h5 class="TgTable">
  <a name="1013721"> </a>

<table border="1" cellpadding="5" cellspacing="0">
  <caption><a name="1013682"> </a><div class="TableTitle">Table 10.1  System preference version numbers </div></caption>
  <tr bgcolor="#CCCCCC" valign="top">
    <th><a name="1013686"> </a><div class="CellHeading">Palm OS <br>Version</div></th>
    <th><a name="1013688"> </a><div class="CellHeading">System Preference Version</div></th>
  </tr>
  <tr valign="top">
    <td><a name="1013690"> </a><div class="CellBody">2.0</div></td>
    <td><a name="1013692"> </a><div class="CellBody">2</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013694"> </a><div class="CellBody">3.0</div></td>
    <td><a name="1013696"> </a><div class="CellBody">3</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013698"> </a><div class="CellBody">3.0</div></td>
    <td><a name="1013700"> </a><div class="CellBody">4</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013702"> </a><div class="CellBody">3.1</div></td>
    <td><a name="1013704"> </a><div class="CellBody">5</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013706"> </a><div class="CellBody">3.2 </div></td>
    <td><a name="1013708"> </a><div class="CellBody">6</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013710"> </a><div class="CellBody">3.3 </div></td>
    <td><a name="1013712"> </a><div class="CellBody">7</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013714"> </a><div class="CellBody">3.5 </div></td>
    <td><a name="1013716"> </a><div class="CellBody">8</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1013718"> </a><div class="CellBody">4.0 </div></td>
    <td><a name="1013720"> </a><div class="CellBody">9</div></td>
  </tr>
</table>




</h5><p class="Body">
  <a name="1013722"> </a>To learn which preferences were added in which version, as well as the return type expected for each preference, see <a href="Preferences.html#1145364">Table 43.1</a> in the <i>Palm OS Programmer's API Reference</i>. 
</p>
<p class="Body">
  <a name="1013729"> </a>To maintain backward compatibility, check the preference version number before checking the value of any preference added after Palm OS 2.0. For example, Palm OS 4.0 added a preference that allows you to access the handheld's locale information (the country and language) as an <span style="font-family: monospace">LmLocaleType</span> structure. Before you try to access that preference, you should check the preference version, as shown in <a href="SystemFeatures.html#1013734">Listing 10.2</a>. 
</p>
<p class="CCodeCaption">
  <a name="1013734"> </a>Listing 10.2  Checking the system preference version
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
LmLocaleType currentLocale;<a name="1013735"> </a>
CountryType currentCountry; <a name="1013736"> </a>
if (PrefGetPreference(prefVersion) &gt;= <span style="font-family: monospace">preferenceDataVer9</span>) {<a name="1013737"> </a>
   currentLocale = (LmLocaleType)
     PrefGetPreference(prefLocale);<a name="1013738"> </a>
} else { /* make do with the country */<a name="1013739"> </a>
   currentCountry = (CountryType)<a name="1013740"> </a>
     PrefGetPreference(prefCountry);<a name="1013741"> </a>
}<a name="1013742"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="1013743"> </a>In some cases, a newer preference is intended to replace an existing preference. For example, the <span style="font-family: monospace">prefAutoOffDuration</span> preference is replaced by <span style="font-family: monospace">prefAutoOffDurationSecs </span>in version 8 of the preference structure. The older preference stored the auto-off time in minutes, and the newer one stores the time in seconds. If you use <span style="font-family: monospace">prefAutoOffDuration</span> in Palm OS 4.0, the system still returns the current auto-off time in minutes; however, to obtain this value, the system converts the value in seconds to minutes and rounds the result if necessary. You'll receive a more precise value if you use <span style="font-family: monospace">prefAutoOffDurationSecs</span>. 
</p>

<h2 class="HBHeadB">
  <a name="1013745"> </a>Setting System Preferences
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1013746"> </a>Occasionally, an application may need to set the value of a system-wide preference. It is strongly recommended that you not override the system preferences without user input. 
</p>
<p class="Body">
  <a name="1013747"> </a>For example, suppose you are writing a replacement for the built-in Address Book application. The Preferences application contains a panel where the user can remap the Address Book hard key to open any application they choose. However, you want to make it more convenient for your users to remap the Address Book button, so you might display an alert that asks first-time users if they want the button remapped. If they tap Yes, then you should call <a href="Preferences.html#1146510"><span style="font-family: monospace">PrefSetPreference</span></a> with the new value. The code might look like the following: 
</p>
<p class="CCodeCaption">
  <a name="1013752"> </a>Listing 10.3  Setting a system preference
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
if (PrefGetPreference(prefHard2CharAppCreator != <a name="1013753"> </a>
      myAppCreatorId)) {<a name="1013754"> </a>
   if (FrmAlert(MakeMeTheDefaultAlert) == 0) { <a name="1013755"> </a>
      /* user pressed Yes */<a name="1013756"> </a>
      PrefSetPreference(prefHard2CharAppCreator<span style="color: #333;;  font-style: normal; font-weight: normal; text-decoration: none; text-transform: none; vertical-align: baseline"> </span>, <a name="1013757"> </a>
         myAppCreatorId);<a name="1013758"> </a>
   }<a name="1013759"> </a>
}<a name="1013760"> </a>
</pre><div class="CodeRule"><hr></div>
<div class="NWNoteWarning"><hr>
  <a name="1013761"> </a> <span style="color: #FF0000;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">WARNING!  </span> Do not confuse <span style="font-family: monospace">PrefSetPreference</span> with <span style="font-family: monospace">PrefSetPreferences</span>. The latter function is obsolete and sets the entire system preferences structure for version 1.0. 
<hr>
</div>

<h2 class="HBHeadB">
  <a name="1013765"> </a>Setting Application-Specific Preferences
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1013766"> </a>You can use the Preferences Manager to set and retrieve preferences specific to your application. You do this by storing the preferences in one of two databases: the "saved" preferences database or the "unsaved" preferences database. 
</p>
<p class="Body">
  <a name="1013767"> </a>To write application preferences, you use <a href="Preferences.html#1146434"><span style="font-family: monospace">PrefSetAppPreferences</span></a>. To read them back in, you use <a href="Preferences.html#1146236"><span style="font-family: monospace">PrefGetAppPreferences</span></a>. Typically, you write the preferences in response to the <span style="font-family: monospace">appStopEvent</span> when control is about to pass to another application. You read the preferences in response to a normal launch. 
</p>
<p class="Body">
  <a name="1013774"> </a><span style="font-family: monospace">PrefSetAppPreferences</span> and <span style="font-family: monospace">PrefGetAppPreferences</span> take roughly the same parameters: the application creator ID, a preference ID that uniquely identifies this preference resource, a pointer to a structure that holds the preference values, the size of the preferences structure, and a Boolean that indicates whether the "saved" or the "unsaved" preferences database is to be used. <span style="font-family: monospace">PrefSetAppPreferences</span> also takes a version number for the preference structure. This value is the return value for <span style="font-family: monospace">PrefGetAppPreferences</span>. 
</p>
<p class="Body">
  <a name="1013775"> </a>The following sections discuss the issues involved in using application-specific preferences:
</p>

  <a name="1013779"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013793">When to Use Application Preferences</a></p>

  <a name="1013783"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013809">How to Store Preferences</a></p>

  <a name="1013787"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013819">Which Preferences Database to Use</a></p>

  <a name="1013791"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1013899">Updating Preferences Upon a New Release</a></p>

<h4 class="HCHeadC">
  <a name="1013793"> </a>When to Use Application Preferences
</h4>
<p class="Body">
  <a name="1013794"> </a>You use application preferences to store state specific to your application that should persist across invocations of your application. For example, the built-in applications store information about the last form and the last record or records displayed before control switched to another application. This way, the user can be returned to the same view when he or she goes back to that application. 
</p>
<p class="Body">
  <a name="1013795"> </a>You can also use preferences for other values. You might allow the user to customize the way the application behaves and store such information in the preferences database. You might also use the preferences database as a way to share information with other applications. 
</p>
<p class="Body">
  <a name="1013796"> </a>Make sure that the preference values you choose are as concise as possible. In games, for example, it is often tempting to store a bitmap for the current state of the screen. Such a bitmap is over 25KB on a color handheld, and it is therefore best avoided. Instead, it is better to store items that let you recreate the current state, such as the player's position in pixels and the current level. 
</p>
<p class="Body">
  <a name="1013797"> </a>There are other ways to store values pertinent to your application. For example, you can store a single value as a feature using the Feature Manager. The differences between storing application value as preferences and storing application values as features are: 
</p>

  <a name="1013798"> </a><p class="B1Bullet"> &#8226; Preferences (including those stored in the "unsaved" database) survive a soft reset because they reside in the storage heap. Features are deleted upon a soft reset. For this reason, preferences are more appropriate for storing application state than feature are. </p>

  <a name="1013799"> </a><p class="B1Bullet"> &#8226; An application preference is a database record, so it has a size limit of 64KB. Multiple application preferences are allowed. The features that are supported by all releases of Palm OS have a maximum size of 4KB. </p>
<p class="Indented1"> <a name="1013800"> </a>In Palm OS 3.1 and higher, you can create features greater than 4KB by using feature memory. Feature memory has a maximum size of 64KB before Palm OS 3.5. Palm OS 3.5 and higher allows allocating a chunk of feature memory that is larger than 64KB. However, feature memory is intended to be used in different situations than an application preference is. See the section <a href="SystemFeatures.html#1013590">"Feature Memory"</a> for more information. </p>
<p class="Body">
  <a name="1013804"> </a>Instead of storing application state values as preferences or features, you could also use a database that your application creates and maintains itself. If you choose this method of storing application preference values, you must write your own functions to read the preferences from the database and write the preferences to the database. If you want the preferences backed up, you need to set the backup bit. However, there may be cases where using your own database has advantages. See <a href="SystemFeatures.html#1013819">"Which Preferences Database to Use"</a>. 
</p>

<h4 class="HCHeadC">
  <a name="1013809"> </a>How to Store Preferences
</h4>
<p class="Body">
  <a name="1013810"> </a>Most applications store a single preference structure under a single preference resource ID. When the application receives an <span style="font-family: monospace">appStopEvent</span>, it writes the entire structure to the resource using <a href="Preferences.html#1146434"><span style="font-family: monospace">PrefSetAppPreferences</span></a>. When it receives a <span style="font-family: monospace">sysAppLaunchCmdNormalLaunch</span>, it reads the structure back in using <a href="Preferences.html#1146236"><span style="font-family: monospace">PrefGetAppPreferences</span></a>. 
</p>
<p class="Body">
  <a name="1013817"> </a>Storing a single preference structure in the database is a convention that most applications follow because it is convenient to access the all preferences at once. The Preferences Manager does allow an application to store more than one preference resource. This requires more calls to <span style="font-family: monospace">PrefSetAppPreferences</span> and <span style="font-family: monospace">PrefGetAppPreferences</span>, but you may find it more convenient to use several preference resources if you have several variable-length preferences. 
</p>

<h4 class="HCHeadC">
  <a name="1013819"> </a>Which Preferences Database to Use
</h4>
<p class="Body">
  <a name="1013826"> </a>Both <a href="Preferences.html#1146236"><span style="font-family: monospace">PrefGetAppPreferences</span></a> and <a href="Preferences.html#1146434"><span style="font-family: monospace">PrefSetAppPreferences</span></a> take a Boolean value that indicates whether the value is to be read from and written to the "saved" or the "unsaved" preferences database. To write the preference to the "saved" preferences database, use <span style="font-family: monospace">true</span>. To write to the "unsaved" preferences database, use <span style="font-family: monospace">false</span>. 
</p>
<p class="Body">
  <a name="1013827"> </a>The only difference between the two databases is that the "saved" preferences database is backed up when a user performs the HotSync operation, and the "unsaved" preferences database is not backed up by default. (The user can use a third-party tool to set the backup bit in the "unsaved" preferences database, which would cause it to be backed up.) Both the "saved" and the "unsaved" preferences reside in the storage heap and thus persist across soft resets. The only way that preferences are lost is if a hard reset is performed. 
</p>
<p class="Body">
  <a name="1013828"> </a>Use the "saved" preferences only for items that must be restored after a hard reset, and use the "unsaved" preferences for the current state of the application. For example, if your application has a registration code, you might write that to the "saved" preferences database so that the user does not have to look up the registration code and re-enter it after a hard reset. However, such items as the current form being displayed and the current database record being displayed can be lost, so they are written to the "unsaved" preferences database. For games, you might write the high score to the "saved" preferences database and any information about the current game to the "unsaved" preferences database. 
</p>
<p class="Body">
  <a name="1013829"> </a>It is important to use the "saved" preferences database sparingly. Any time that any application stores or changes a preference in the "saved" preferences database, the <b>entire</b> database is backed up during the next HotSync operation. For users with a large number of applications, this practice can seriously impact the time that it takes to perform a HotSync operation. 
</p>
<p class="Body">
  <a name="1013833"> </a><a href="SystemFeatures.html#1013835">Listing 10.4</a> shows the preferences structures and the <span style="font-family: monospace">StopApplication</span> function from the HardBall application. The <span style="font-family: monospace">HardBallPreferenceType</span>, which is written to the "saved" preferences database, only stores the high score information and accumulated time. All other preferences are stored in <span style="font-family: monospace">GameStatusType</span>, which is written to the "unsaved" preferences database. 
</p>
<p class="CCodeCaption">
  <a name="1013835"> </a>Listing 10.4  Saving application-specific preferences
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
typedef struct {<a name="1013836"> </a>
   SavedScore highScore[highScoreMax];<a name="1013837"> </a>
   UInt8 lastHighScore;<a name="1013838"> </a>
   UInt8 startLevel;<a name="1013839"> </a>
   UInt32  accumulatedTime;<a name="1013840"> </a>
} HardBallPreferenceType;<a name="1013841"> </a>
 <a name="1013842"> </a>
typedef struct {<a name="1013843"> </a>
   enum gameProgress  status;<a name="1013844"> </a>
   UInt8  periodLength;<a name="1013845"> </a>
   UInt32 nextPeriodTime;<a name="1013846"> </a>
   UInt32 periodsToWait;<a name="1013847"> </a>
   Boolean  paused;<a name="1013848"> </a>
   UInt32  pausedTime;<a name="1013849"> </a>
   BrickType  brick[rowsOfBricks][columnsOfBricks];<a name="1013850"> </a>
   UInt8  bricksRemaining;<a name="1013851"> </a>
   UInt8 level;<a name="1013852"> </a>
   WorldState last;<a name="1013853"> </a>
   WorldState next;<a name="1013854"> </a>
   RemovedBrick brokenBricks[brokenBricksMax];<a name="1013855"> </a>
   Int16  brokenBricksCount;<a name="1013856"> </a>
   UInt8 ballsRemaining;<a name="1013857"> </a>
   Boolean movePaddleLeft;<a name="1013858"> </a>
   Boolean movePaddleRight;<a name="1013859"> </a>
   SoundType  soundToMake;<a name="1013860"> </a>
   Int8  soundPeriodsRemaining;<a name="1013861"> </a>
   Int32  scoreToAwardBonusBall;<a name="1013862"> </a>
   Boolean lowestHighScorePassed;<a name="1013863"> </a>
   Boolean highestHighScorePassed;<a name="1013864"> </a>
   Boolean gameSpedUp;<a name="1013865"> </a>
   Boolean  cheatMode;<a name="1013866"> </a>
   UInt32 startTime;<a name="1013867"> </a>
} GameStatusType;<a name="1013868"> </a>
 <a name="1013869"> </a>
HardBallPreferenceType Prefs;<a name="1013870"> </a>
static GameStatusType GameStatus;<a name="1013871"> </a>
 <a name="1013872"> </a>
static void StopApplication (void)<a name="1013873"> </a>
{<a name="1013874"> </a>
   ...<a name="1013875"> </a>
   // Update the time accounting.<a name="1013876"> </a>
   Prefs.accumulatedTime += (TimGetTicks() - <a name="1013877"> </a>
      GameStatus.startTime);<a name="1013878"> </a>
   <a name="1013879"> </a>
   // If we are saving a game resuming (it hasn't started <a name="1013880"> </a>
   // playing yet) then preserve the game status.<a name="1013881"> </a>
   if (GameStatus.status == gameResuming) {<a name="1013882"> </a>
      GameStatus.status = SavedGameStatus;<a name="1013883"> </a>
   }<a name="1013884"> </a>
   <a name="1013885"> </a>
   // Save state/prefs.<a name="1013886"> </a>
   PrefSetAppPreferences (appFileCreator, appPrefID, <a name="1013887"> </a>
      appPrefVersion, &amp;Prefs, sizeof (Prefs), true);<a name="1013888"> </a>
   <a name="1013889"> </a>
   PrefSetAppPreferences (appFileCreator, appSavedGameID, <a name="1013890"> </a>
      appSavedGameVersion, &amp;GameStatus, sizeof (GameStatus), <a name="1013891"> </a>
      false);<a name="1013892"> </a>
      <a name="1013893"> </a>
   // Close all the open forms.<a name="1013894"> </a>
   FrmCloseAllForms ();<a name="1013895"> </a>
}<a name="1013896"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="1013897"> </a>If you have a large amount of preference data that must be backed up during a HotSync operation and is frequently changed, you could, as a performance optimization, store the preferences in a database that your own application creates and maintains rather than in the "saved" preferences database. This saves the user from having to have the entire "saved" preferences database backed up on every HotSync operation. The disadvantage of this method of saving application preferences is that you must write all code to maintain the database and to retrieve information from it. 
</p>

<h4 class="HCHeadC">
  <a name="1013899"> </a>Updating Preferences Upon a New Release
</h4>
<p class="Body">
  <a name="1013900"> </a>When you update your application, you may have new items that you want to store in the preferences database. You may choose to write a separate preference record to the database. However, it is better to update the current preference structure, size permitting. 
</p>
<p class="Body">
  <a name="1013907"> </a>The <a href="Preferences.html#1146434"><span style="font-family: monospace">PrefSetAppPreferences</span></a> and <a href="Preferences.html#1146236"><span style="font-family: monospace">PrefGetAppPreferences</span></a> functions use a versioning system that allows you to update an existing preference structure. To use it, keep track of the version number that you pass to <span style="font-family: monospace">PrefSetAppPreferences</span>. Add any new preferences to the end of the preferences structure, and then increment the version number. You might use a macro for this purpose: 
</p>
<pre  class="Preformatted">
#define CurrentPrefsVersion 2<a name="1013908"> </a>
</pre>
<p class="Body">
  <a name="1013909"> </a>When a user launches the new version of the application, <span style="font-family: monospace">PrefGetAppPreferences</span> is called before <span style="font-family: monospace">PrefSetAppPreferences</span>. The <span style="font-family: monospace">PrefGetAppPreferences</span> function returns the version number of the preference structure that it retrieved from the database. For example, if the new version is version 2, <span style="font-family: monospace">PrefGetAppPreferences</span> returns 1 the first time that version 2 is run. If the returned version does not match the current version, you know that the user does not have values for the new preferences introduced in version 2. You can then decide to provide default values for those new preferences. 
</p>
<p class="Body">
  <a name="1013910"> </a>The first time any version of your application is run, <span style="font-family: monospace">PrefGetAppPreferences</span> returns <span style="font-family: monospace">noPreferenceFound</span>. This indicates that the user does not have any preferences for the current application and the application must supply default values for the entire preferences structure. <a href="SystemFeatures.html#1013915">Listing 10.5</a> shows how the Datebook handles retrieving the version number from <span style="font-family: monospace">PrefGetAppPreferences</span>.
</p>
<p class="CCodeCaption">
  <a name="1013915"> </a>Listing 10.5  Checking the preference version number
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
#define datebookPrefsVersionNum 4<a name="1013916"> </a>
 <a name="1013917"> </a>
Int16 DatebookLoadPrefs (DatebookPreferenceType* prefsP)<a name="1013918"> </a>
{<a name="1013919"> </a>
   UInt16 prefsSize;<a name="1013920"> </a>
   Int16 prefsVersion = noPreferenceFound;<a name="1013921"> </a>
   Boolean haveDefaultFont = false;<a name="1013922"> </a>
   UInt32 defaultFont;<a name="1013923"> </a>
   <a name="1013924"> </a>
   ErrNonFatalDisplayIf(!prefsP, "null prefP arg");<a name="1013925"> </a>
   <a name="1013926"> </a>
   <a name="1013927"> </a>
   // Read the preferences / saved-state information.  Fix-up if no prefs or <a name="1013928"> </a>
   // older/newer version<a name="1013929"> </a>
   prefsSize = sizeof (DatebookPreferenceType);<a name="1013930"> </a>
   prefsVersion = PrefGetAppPreferences (sysFileCDatebook, datebookPrefID, <a name="1013931"> </a>
      prefsP, &amp;prefsSize, true);<a name="1013932"> </a>
   <a name="1013933"> </a>
   // If the preferences version is from a future release (as can happen when <a name="1013934"> </a>
   // going back and syncing to an older version of the device), treat it the <a name="1013935"> </a>
   // same as "not found" because it could be significantly different<a name="1013936"> </a>
   if ( prefsVersion &gt; datebookPrefsVersionNum )<a name="1013937"> </a>
      prefsVersion = noPreferenceFound;<a name="1013938"> </a>
   <a name="1013939"> </a>
   if ( prefsVersion == noPreferenceFound ) {<a name="1013940"> </a>
      // Version 1 and 2 preferences<a name="1013941"> </a>
      prefsP-&gt;dayStartHour = defaultDayStartHour;<a name="1013942"> </a>
      prefsP-&gt;dayEndHour = defaultDayEndHour;<a name="1013943"> </a>
      prefsP-&gt;alarmPreset.advance = defaultAlarmPresetAdvance;<a name="1013944"> </a>
      prefsP-&gt;alarmPreset.advanceUnit = defaultAlarmPresetUnit;<a name="1013945"> </a>
      prefsP-&gt;saveBackup = defaultSaveBackup;<a name="1013946"> </a>
      prefsP-&gt;showTimeBars = defaultShowTimeBars;<a name="1013947"> </a>
      prefsP-&gt;compressDayView = defaultCompressDayView;<a name="1013948"> </a>
      prefsP-&gt;showTimedAppts = defaultShowTimedAppts;<a name="1013949"> </a>
      prefsP-&gt;showUntimedAppts = defaultShowUntimedAppts;<a name="1013950"> </a>
      prefsP-&gt;showDailyRepeatingAppts = <a name="1013951"> </a>
         defaultShowDailyRepeatingAppts;<a name="1013952"> </a>
 <a name="1013953"> </a>
      // We need to set up the note font with a default value for the system.<a name="1013954"> </a>
      FtrGet(sysFtrCreator, sysFtrDefaultFont, &amp;defaultFont);<a name="1013955"> </a>
      haveDefaultFont = true;<a name="1013956"> </a>
      <a name="1013957"> </a>
      prefsP-&gt;v20NoteFont = (FontID)defaultFont;<a name="1013958"> </a>
   }<a name="1013959"> </a>
   <a name="1013960"> </a>
   if ((prefsVersion == noPreferenceFound) || (prefsVersion &lt; <a name="1013961"> </a>
         datebookPrefsVersionNum)) {<a name="1013962"> </a>
      // Version 3 preferences<a name="1013963"> </a>
      prefsP-&gt;alarmSoundRepeatCount = defaultAlarmSoundRepeatCount;<a name="1013964"> </a>
      prefsP-&gt;alarmSoundRepeatInterval = defaultAlarmSoundRepeatInterval;<a name="1013965"> </a>
      prefsP-&gt;alarmSoundUniqueRecID = defaultAlarmSoundUniqueRecID;<a name="1013966"> </a>
      prefsP-&gt;noteFont = prefsP-&gt;v20NoteFont;<a name="1013967"> </a>
      <a name="1013968"> </a>
      // Fix up the note font if we copied from older preferences.<a name="1013969"> </a>
      if ((prefsVersion != noPreferenceFound) &amp;&amp; (prefsP-&gt;noteFont == <a name="1013970"> </a>
            largeFont))<a name="1013971"> </a>
         prefsP-&gt;noteFont = largeBoldFont;<a name="1013972"> </a>
      <a name="1013973"> </a>
      if (!haveDefaultFont)<a name="1013974"> </a>
         FtrGet(sysFtrCreator, sysFtrDefaultFont, &amp;defaultFont);<a name="1013975"> </a>
      <a name="1013976"> </a>
      prefsP-&gt;apptDescFont = (FontID)defaultFont;<a name="1013977"> </a>
   }<a name="1013978"> </a>
   <a name="1013979"> </a>
   if ((prefsVersion == noPreferenceFound) || (prefsVersion &lt; <a name="1013980"> </a>
         datebookPrefsVersionNum)) {<a name="1013981"> </a>
      // Version 4 preferences<a name="1013982"> </a>
      prefsP-&gt;alarmSnooze = defaultAlarmSnooze;<a name="1013983"> </a>
   }<a name="1013984"> </a>
   <a name="1013985"> </a>
   return prefsVersion;<a name="1013986"> </a>
}<a name="1028951"> </a>
</pre><div class="CodeRule"><hr></div>

<h2 class="HaHeadA">
  <a name="1028953"> </a>Sound 
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1028956"> </a>The Palm OS 5 Sound Manager controls two independent sound facilities: 
</p>

  <a name="1028696"> </a><p class="B1Bullet"> &#8226; <b>Simple sound</b>: Single voice, monophonic, square-wave sound synthesis, useful for system beeps. This is the traditional (pre-OS 5) PalmSource sound.</p>

  <a name="1028697"> </a><p class="B1Bullet"> &#8226; <b>Sampled sound</b>: Stereo, multi-format, sampled data recording and playback (new in Palm OS 5). Sampled sounds can be generated programmatically or read from a soundfile.</p>
<p class="Body">
  <a name="1028698"> </a>These facilities are independent of each other. Although you can play a simple sound and a sampled sound at the same, their respective APIs have no effect on each other. For example, you can't use the sampled sound volume-setting function (<a href="SoundManager.html#1393210"><span style="font-family: monospace">SndStreamSetVolume</span></a>) to change the volume of a simple sound. 
</p>
<p class="Body">
  <a name="1028702"> </a>The following sections take a look at the concepts introduced by the Sound Manager. For detailed API descriptions, and for more guidance with regard to the sampled data concepts presented here, see <a href="SoundManager.html#1392061">Chapter 45, "Sound Manager."</a>
</p>

<h2 class="HBHeadB">
  <a name="1028706"> </a>Simple Sound
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1028707"> </a>There are three ways to play a simple sound: 
</p>

  <a name="1028708"> </a><p class="B1Bullet"> &#8226; You can play a single tone of a given pitch, amplitude, and duration by calling <a href="SoundManager.html#1392466"><span style="font-family: monospace">SndDoCmd</span></a>.</p>

  <a name="1028712"> </a><p class="B1Bullet"> &#8226; You can play a pre-defined system sound ("Information," "Warning," "Error," and so on) through <a href="SoundManager.html#1392697"><span style="font-family: monospace">SndPlaySystemSound</span></a>. </p>

  <a name="1028716"> </a><p class="B1Bullet"> &#8226; You can play a tune by passing in a Level 0 Standard MIDI File (SMF) through the <a href="SoundManager.html#1392575"><span style="font-family: monospace">SndPlaySmf</span></a> function. For example, the alarm sounds used in the built-in Date Book application are MIDI records stored in the System MIDI database. MIDI support is included with Palm OS 3.0 and later. For information on MIDI and the SMF format, go to the official MIDI website, <span style="font-family: monospace">http://www.midi.org</span>.</p>

<h2 class="HBHeadB">
  <a name="1028720"> </a>Sampled Sound
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1028721"> </a>Over in the sampled sound facilities, there are two fundamental functions: 
</p>

  <a name="1028725"> </a><p class="B1Bullet"> &#8226; <a href="SoundManager.html#1411212"><span style="font-family: monospace">SndStreamCreate</span></a> opens a new sampled sound "stream" from/into which you record/playback buffers of "raw" data. The trick is that you first have to configure the stream to tell it how to interpret the data. (An alternate function, <a href="SoundManager.html#1411125"><span style="font-family: monospace">SndStreamCreateExtended</span></a>, lets you declare an encoding format.)</p>

  <a name="1028729"> </a><p class="B1Bullet"> &#8226; <a href="SoundManager.html#1394170"><span style="font-family: monospace">SndPlayResource</span></a> is used to playback sound data that's read from a (formatted) soundfile. The function configures the playback stream for you, based on the format information in the soundfile header. Currently, only uncompressed WAV and IMA ADPCM WAV formats are recognized. </p>
<p class="Body">
  <a name="1028730"> </a>The Sound Manager also provides functions that let you set the volume and stereo panning for individual recording and playback streams. See <a href="SoundManager.html#1393210"><span style="font-family: monospace">SndStreamSetVolume</span></a> and <a href="SoundManager.html#1393169"><span style="font-family: monospace">SndStreamSetPan</span></a>.
</p>

<h2 class="HBHeadB">
  <a name="1028737"> </a>Simple vs Sampled
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1028738"> </a>Comparing the two facilities, simple sound is easy to understand and requires very little programming: In most cases, you load up a structure, call a function, and out pops a beep. Unfortunately, the sound itself is primitive. (An example of simple sound programming is given in <a href="SystemFeatures.html#1028745">"Sound Preferences,"</a> below.)
</p>
<p class="Body">
  <a name="1028742"> </a>Sampled sound, on the other hand, is (or can be) much more satisfying, but requires more planning than simple sound. How much more depends on what you're doing. Playing samples from a soundfile isn't much more difficult than playing a simple sound, but you have to supply a soundfile. Generating samples programmatically-and recording sound-requires more work: You have to implement a callback function that knows something about sound data.
</p>
<div class="NINoteImportant"><hr>
  <a name="1028743"> </a> <span style="color: #333;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">IMPORTANT:  </span> One significant difference between simple sounds and sampled sounds is that they use different volume scales: Simple sound volumes are in the range [0, 64]; sampled sound volumes are [0, 1024]. 
<hr>
</div>

<h2 class="HBHeadB">
  <a name="1028745"> </a>Sound Preferences
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1028746"> </a>If you're adding short, "informative" sounds to your application, such as system beeps, alarms, and the like, you should first consider using the (simple) system sounds that are defined by the Palm OS, as listed in the reference documentation for <a href="SoundManager.html#1392697"><span style="font-family: monospace">SndPlaySystemSound</span></a>/
</p>
<p class="Body">
  <a name="1028750"> </a>If you want to create your own system-like sounds, you should at least respect the user's preferences settings with regard to sound volume. In Palm OS 3.0 and later, there are three sound preference constants:
</p>

  <a name="1028751"> </a><p class="B1Bullet"> &#8226; <span style="font-family: monospace">prefSysSoundVolume</span> is the default system volume.</p>

  <a name="1028752"> </a><p class="B1Bullet"> &#8226; <span style="font-family: monospace">prefGameSoundVolume</span> is used for game sounds.</p>

  <a name="1028753"> </a><p class="B1Bullet"> &#8226; <span style="font-family: monospace">prefAlarmSoundVolume</span> is used for alarms.</p>
<p class="Body">
  <a name="1028754"> </a>To apply a sound preference setting to a simple sound volume, you have to retrieve the setting and apply it yourself. For example, here we retrieve the alarm sound and use it to set the volume of a simple sound:
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
/* Create a 'sound command' structure. This will encode the parameters of the
tone we want to generate.<a name="1028755"> </a>
*/<a name="1028756"> </a>
SndCommandType sndCommand;<a name="1028757"> </a>
<a name="1028758"> </a>
/* Ask for the 'play a tone' command. */<a name="1028759"> </a>
sndCommand.cmd = sndCmdFreqDurationAmp;<a name="1028760"> </a>
<a name="1028761"> </a>
/* Set the frequency and duration. */<a name="1028762"> </a>
sndCommand.param1 = 1760;<a name="1028763"> </a>
sndCommand.param2 = 500;<a name="1028764"> </a>
<a name="1028765"> </a>
/* Now get the alarm volume and set it in the struct. */<a name="1028766"> </a>
sndCommand.param3 = PrefGetPreference (prefAlarmSoundVolume);<a name="1028767"> </a>
<a name="1028768"> </a>
/* Play the tone. */<a name="1028769"> </a>
SndDoCmd( 0, &amp;sndCommand, true);<a name="1028770"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="1028771"> </a>The sampled sound API, on the other hand, provides volume constants (<span style="font-family: monospace">sndSystemVolume</span>, <span style="font-family: monospace">sndGameVolume</span>, and <span style="font-family: monospace">sndSysVolume</span>) that look up a preference setting for you:
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
./* Point our sound data pointer to a record that contains WAV data (record
retrieval isn't shown). <a name="1028772"> </a>
*/<a name="1028773"> </a>
SndPtr soundData = MemHandleLock(...);<a name="1028774"> </a>
<a name="1028775"> </a>
/* Play the data using the default alarm volume setting. */<a name="1028776"> </a>
SndPlayResource(soundData, sndAlarmVolume, sndFlagNormal);<a name="1028777"> </a>
<a name="1028778"> </a>
/* Unlock the data. */<a name="1028779"> </a>
MemPtrUnlock(soundData);<a name="1028780"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="1028781"> </a>For greatest compatibility with multiple versions of the sound preferences mechanism, your application should check the version of Palm OS on which it is running. See <a href="SystemFeatures.html#1013505">"The System Version Feature"</a> for more information.
</p>

<h2 class="HBHeadB">
  <a name="1028785"> </a>Standard MIDI Files
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1028786"> </a>Although you an use a Level 0 Standard MIDI File to control simple sound generation, this doesn't imply broad support for MIDI messages: Only key down, key up, and tempo change messages are recognized.
</p>
<p class="Body">
  <a name="1028787"> </a>You can store your MIDI data in a MIDI database:
</p>

  <a name="1028788"> </a><p class="B1Bullet"> &#8226; The database type <span style="font-family: monospace">sysFileTMidi</span> identifies MIDI record databases. </p>

  <a name="1028789"> </a><p class="B1Bullet"> &#8226; The system MIDI database is further identified by the creator <span style="font-family: monospace">sysFileCSystem</span>. The database holds a number of system alarm sounds. </p>
<p class="Body">
  <a name="1028790"> </a>You can add MIDI records to the system MIDI database, or you can store them in your own.
</p>
<p class="Body">
  <a name="1028791"> </a>Each record in a MIDI database is concatenation of a PalmSource-defined MIDI record header, the human-readable name of the MIDI data, and then the MIDI data itself. 
</p>
<p class="Body">
  <a name="1030050"> </a>The following code creates a new MIDI record and adds it to the system MIDI database. 
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
/* We need three things: A header, a name, and some data. We'll get the name
and data from somewhere, and create the header ourselves.<a name="1030051"> </a>
*/<a name="1028794"> </a>
char *midiName = ...;<a name="1028795"> </a>
MemHandle midiData = ...;<a name="1028796"> </a>
SndMidiRecHdrType midiHeader;<a name="1028797"> </a>
<a name="1028798"> </a>
/* Database and record gadgetry. */<a name="1028799"> </a>
DmOpenRef database;<a name="1028800"> </a>
MemHandler record;<a name="1028801"> </a>
UInt16 *recordIndex = dmMaxRecordIndex;<a name="1028802"> </a>
UInt8* recordPtr;<a name="1028803"> </a>
UInt8* midiPtr;<a name="1028804"> </a>
<a name="1028805"> </a>
/* MIDI header values: Always set the signature to sndMidiRecSignature, and<a name="1028806"> </a>
reserved to 0. bDataOffset is an offset from the beginning of the header to the<a name="1030071"> </a>
first byte of actual MIDI data. The name includes a null-terminator, hence the<a name="1030072"> </a>
'+ 1'.<a name="1030073"> </a>
*/<a name="1028807"> </a>
midiHeader.signature = sndMidiRecSignature;<a name="1028808"> </a>
midiHeader.reserved = 0;<a name="1028809"> </a>
midiHeader.bDataOffset = sizeof(SndMidiRecHdrType) + StrLen(midiName) + 1;<a name="1028810"> </a>
<a name="1028811"> </a>
/* Open the database and allocate a record. */<a name="1028812"> </a>
database = DmOpenDatabaseByTypeCreator( sysFileTMidi, sysFileCSystem,<a name="1028813"> </a>
               dmModeReadWrite | dmModeExclusive);<a name="1028814"> </a>
record = DmNewRecord  database, &amp;recordIndex, <a name="1028815"> </a>
               midiHeader.bDataOffset + MemHandleSize(midiData));<a name="1028816"> </a>
<a name="1028817"> </a>
/* Lock the data and the record. */<a name="1028818"> </a>
midiDataPtr = MemHandleLock(midiData);<a name="1028819"> </a>
recordPtr = MemHandleLock(record);<a name="1028820"> </a>
<a name="1028821"> </a>
/* Write the MIDI header. */<a name="1028822"> </a>
DmWrite( recordPtr, 0, &amp;smidiHeader, sizeof(midiHeader));<a name="1028823"> </a>
<a name="1028824"> </a>
/* Write the track name. */<a name="1028825"> </a>
DmStrCopy( recordPtr, ((Uint32)(&amp;((SndMidiRecType *)0)-&gt;field, midiName);<a name="1028826"> </a>
<a name="1028827"> </a>
/* Write the MIDI data. */<a name="1028828"> </a>
DmWrite( recordPtr, midiHeader.bDataOffset, midiDataPtr, 
               MemHandleSize(midiData));<a name="1028829"> </a>
<a name="1028830"> </a>
/* Unlock the handles, release the record, close the database. */<a name="1028831"> </a>
MemHandleUnlock( midiData);<a name="1028832"> </a>
MemHandleUnlock( record);<a name="1028833"> </a>
DmReleaseRecord( database, recordIndex, 1);<a name="1028834"> </a>
DmCloseDatabase( database);<a name="1028835"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="1028839"> </a>To retrieve a MIDI record, you can use the <a href="SoundManager.html#1392445"><span style="font-family: monospace">SndCreateMidiList</span></a> function if you know the record's creator, or you can use the Data Manager functions to iterate through all MIDI records.
</p>

<h2 class="HBHeadB">
  <a name="1028840"> </a>Creating a Sound Stream
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1028841"> </a>The sound stream API, part of the sampled sound facility, is the most flexible part of the Sound Manager. A sound stream sends sampled data to or reads sampled data from the sound hardware. There are 15 sound output streams and one input stream, all running (or potentially running) concurrently. 
</p>
<p class="Body">
  <a name="1028842"> </a>To use a sound stream, you have to tell it what sort of data you're going to give it or that you expect to get from it. All of the sound format information that you need to supply to set up the stream-data quantization, sampling rate, channel count, and so on-is passed in the <a href="SoundManager.html#1411212"><span style="font-family: monospace">SndStreamCreate</span></a> or <a href="SoundManager.html#1411125"><span style="font-family: monospace">SndStreamCreateExtended</span></a> function.
</p>
<p class="Body">
  <a name="1028846"> </a>You also have to pass the function a pointer to a callback function (see <a href="SoundManager.html#1393276"><span style="font-family: monospace">SndStreamBufferCallback</span></a> or <a href="SoundManager.html#1416245"><span style="font-family: monospace">SndStreamVariableBufferCallback</span></a>); implementing this function is where you'll be doing most of your work. When you tell your stream to start running (<a href="SoundManager.html#1393231"><span style="font-family: monospace">SndStreamStart</span></a>), the callback function is called automatically, once per buffer of data. If you're operating on an input stream (in other words, if you're recording), your callback function is expected to empty the buffer, do something with the data, and then return before the next buffer shows up. Output stream callbacks do the opposite-they fill the buffer with data.
</p>
<p class="Body">
  <a name="1028853"> </a>Because of the amount of data involved, the callbacks must operate as quickly as possible. This is particularly important for output stream callbacks: Not only can there be more than one stream competing for attention, but all output callbacks run in the same task (which is created and managed by the Sound Manager). If the callback for (output) stream <span style="color: #333;;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">A</span> takes to long to fill the stream with data, the callbacks for stream <span style="color: #333;;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">B</span>, <span style="color: #333;;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">C</span>, and so on, will starve. Starving threads make glitchy sounds.
</p>
<p class="Body">
  <a name="1028854"> </a>The formats that are supported by the sampled sound functions are described in the functions themselves. 
</p>

<h2 class="HaHeadA">
  <a name="1014357"> </a>System Boot and Reset 
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014360"> </a>Any reset is normally performed by sticking a bent-open paper clip into the small hole in the back of the handheld. This hole, known as the "reset switch" is above and to the right of the serial number sticker (on Palm III handhelds). Depending on additional keys held down, the reset behavior varies, as follows:
</p>

<h2 class="HBHeadB">
  <a name="1014361"> </a>Soft Reset
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014363"> </a>A soft reset clears all of the dynamic heap (Heap 0, Card 0). The storage heaps remain untouched. The operating system restarts from scratch with a new stack, new global variables, restarted drivers, and a reset communication port. All applications on the handheld receive a <a href="AppLaunchCodes.html#971020"><span style="font-family: monospace">sysAppLaunchCmdSystemReset</span></a> launch code. 
</p>

<h2 class="HBHeadB">
  <a name="1014369"> </a>Soft Reset + Up Arrow
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014371"> </a>Holding the up-arrow down while pressing the reset switch with a paper clip causes the same soft reset logic with the following two exceptions:
</p>

  <a name="1014372"> </a><p class="B1Bullet"> &#8226; The <span style="font-family: monospace">sysAppLaunchCmdSystemReset</span> launch code is not sent to applications. This is useful if there is an application on the handheld that crashes upon receiving this launch code (not uncommon) and therefore prevents the system from booting. </p>

  <a name="1014374"> </a><p class="B1Bullet"> &#8226; The OS won't load any system patches during startup. This is useful if you have to delete or replace a system patch database. If the system patches are loaded and therefore open, they cannot be replaced or deleted from the system. </p>

<h2 class="HBHeadB">
  <a name="1014375"> </a>Hard Reset
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014377"> </a>A hard reset is performed by pressing the reset switch with a paper clip while holding down the power key. This has all the effects of the soft reset. In addition, the storage heaps are erased. As a result, all programs, data, patches, user information, etc. are lost. A confirmation message is displayed asking the user to confirm the deletion of all data. 
</p>
<p class="Body">
  <a name="1014379"> </a>The <span style="font-family: monospace">sysAppLaunchCmdSystemReset</span> launch code is sent to the applications at this time. If the user selected the "Delete all data" option, the digitizer calibration screen comes up first. The default databases for the four main applications is copied out of the ROM. 
</p>
<p class="Body">
  <a name="1014381"> </a>If you hold down the up arrow key when the "Delete all data" message is displayed, and then press the other four application buttons while still holding the up arrow key, the system is booted without reading the default databases for the four main applications out of ROM. 
</p>

<h2 class="HBHeadB">
  <a name="1014382"> </a>System Reset Calls
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014383"> </a>The system manager provides support for rebooting the Palm Powered handheld. It calls <a href="SystemManager.html#1166310"><span style="font-family: monospace">SysReset</span></a> to reset the handheld. This call does a soft reset and has the same effect as pressing the reset switch on the unit. <span style="color: #333;;  font-style: italic; font-weight: normal; text-decoration: none; text-transform: none; vertical-align: baseline">Normally applications should not use this call.</span> 
</p>
<p class="Body">
  <a name="1014388"> </a><span style="font-family: monospace">SysReset</span> is used, for example, by the Sync application. When the user copies an extension onto the Palm Powered handheld, the Sync application automatically resets the handheld after the sync is completed to allow the extension to install itself. 
</p>

<h2 class="HaHeadA">
  <a name="1014391"> </a>ARM-Native Functions 
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1021977"> </a>Palm OS 5 includes the Palm Application Compatibility Environment (PACE), within which all Palm OS applications run. PACE emulates the 68K-family processor traditionally used in Palm Powered handhelds, enabling both new and existing applications to run on Palm Powered handhelds that employ an ARM processor.
</p>
<p class="Body">
  <a name="1022105"> </a>Palm OS 5 itself is entirely ARM-native, so all operating system functions run at the full speed of the underlying processor. Because most applications spend the bulk of their time executing operating system functions, they get the performance benefit of the ARM processor with no effort. Occasionally, however, you'll write a processor-intensive function that could benefit from being recompiled as ARM code, and Palm OS 5 has a mechanism to allow this. These ARM functions can call back into the operating system and can call user-defined 68K functions as well, but because it is difficult to debug both the "68K side" and the "ARM side" of an application, and because of the overhead involved in byte-swapping the parameters, functions that make many calls into the operating system typically aren't good candidates to make ARM-native.
</p>
<p class="Body">
  <a name="1021976"> </a>Palm OS 5 includes <a href="MiscSys.html#1216225"><span style="font-family: monospace">PceNativeCall</span></a> which, when given a pointer to an ARM function and a pointer to a parameter block, calls the ARM function. Due to endianness differences between the 68K and ARM processors, <span style="font-family: monospace">PceNativeCall</span> byte-swaps the parameter pointer and return value. Because the operating system has no knowledge of the structure of the parameter block, however, it performs no byte-swapping in this block. Your ARM code must do this as necessary for your application (see <a href="SystemFeatures.html#1014448">"Accessing 68K Data From an ARM Function"</a> for more information). Also note that the context in which the code is called is undefined other than to include enough stack space for "reasonable" algorithms.
</p>
<p class="Body">
  <a name="1014397"> </a>You typically store the ARM code in a resource in the calling 68K application, and locate it using the <a href="DataAndResourceManager.html#1096290"><span style="font-family: monospace">DmGetResource</span></a> and <a href="MemoryManager.html#1132698"><span style="font-family: monospace">MemHandleLock</span></a> functions.
</p>

<h2 class="HBHeadB">
  <a name="1014424"> </a>Calling an ARM Function
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1022157"> </a>Calling an ARM function is usually just a matter of passing the proper parameters to <a href="MiscSys.html#1216225"><span style="font-family: monospace">PceNativeCall</span></a>, as defined in the <i>Palm OS Programmer's API Reference</i>. However, before calling <span style="font-family: monospace">PceNativeCall</span> you must test the processor type:
</p>

  <a name="1022161"> </a><p class="B1Bullet"> &#8226; If the processor is ARM, the 68K application should call the ARM function.</p>

  <a name="1022162"> </a><p class="B1Bullet"> &#8226; If the processor is an x86 family processor (that is, the application is running in Palm OS Simulator on Windows), the 68K application should call the Windows DLL that represents the ARM function.</p>

  <a name="1022171"> </a><p class="B1Bullet"> &#8226; Otherwise, the 68K application should either call a 68K version of the function or fail gracefully if the functionality cannot be reasonably incorporated into a 68K application. Note that in this instance your application may be running on a version of Palm OS earlier than Palm OS 5.</p>
<p class="Body">
  <a name="1014425"> </a><a href="SystemFeatures.html#1014426">Listing 10.6</a> illustrates this process. For simplicity, in this example no parameters are passed to the ARM function.
</p>
<p class="CCodeCaption">
  <a name="1014426"> </a>Listing 10.6  Calling an ARM function
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
static UInt32 PceNativeResourceCall(DmResType resType, DmResID resID,
char *DLLEntryPointP, void *userCPB) {<a name="1027210"> </a>
    UInt32    processorType;<a name="1027212"> </a>
    MemHandle armH;<a name="1027213"> </a>
    MemPtr    armP;<a name="1027214"> </a>
    UInt32    result;<a name="1027215"> </a>
<a name="1027216"> </a>
    // get the processor type<a name="1027217"> </a>
    FtrGet(sysFileCSystem, sysFtrNumProcessorID, &amp;processorType);<a name="1027218"> </a>
<a name="1027219"> </a>
    if (sysFtrNumProcessorIsARM(processorType)){<a name="1029047"> </a>
        // running on ARM; call the actual ARM resource<a name="1027222"> </a>
        armH = DmGetResource(resType, resID);<a name="1027223"> </a>
        armP = MemHandleLock(armH);<a name="1027224"> </a>
<a name="1027225"> </a>
        result = PceNativeCall(armP, userCPB);<a name="1027226"> </a>
<a name="1027227"> </a>
        MemHandleUnlock(armH);<a name="1027228"> </a>
        DmReleaseResource(armH);<a name="1029060"> </a>
    } else if (processorType == sysFtrNumProcessorx86) {<a name="1029061"> </a>
        // running on Simulator; call the DLL<a name="1029062"> </a>
        result = PceNativeCall((NativeFuncType *)DLLEntryPointP, userCPB);<a name="1027234"> </a>
    } else {<a name="1027235"> </a>
        // some other processor; fail gracefully<a name="1027238"> </a>
        ErrNonFatalDisplay("Unsupported processor type");<a name="1027239"> </a>
        result = -1;<a name="1027240"> </a>
    }<a name="1027241"> </a>
<a name="1027242"> </a>
    return result;<a name="1027243"> </a>
}<a name="1027244"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="1026636"> </a>Note that the <span style="font-family: monospace">#defines</span> for the various processor types (all of which are named <span style="font-family: monospace">sysFtrNumProcessor...</span>) can be found in <span style="font-family: monospace">SystemMgr.h</span>.
</p>

<h2 class="HBHeadB">
  <a name="1024777"> </a>ARM Function Definition
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1024778"> </a>ARM functions that are to be called from the 68K side-that is, functions that serve as entry points into your ARM code-must use the following function prototype (defined in <span style="font-family: monospace">PceNativeCall.h</span>):
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
typedef unsigned long NativeFuncType (const void *emulStateP,
void *userData68KP, Call68KFuncType *call68KFuncP)<a name="1024779"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="1024780"> </a>The function parameters are defined as follows:
</p>
<h5 class="P1"><a name="1030085"> </a><div class="P1Parameter"><table border="0" cellpadding="5" cellspacing="0">
  <tr>
    <td width="180" valign="top"><span style="font-family: monospace">-&gt; emulStateP</span></td><td valign="top">A pointer to the (opaque) PACE emulation state. This pointer is used when calling Palm OS functions and application callbacks; see <a href="SystemFeatures.html#1014490">"Calling Palm OS Functions From ARM Code"</a> for more information.</td>
  </tr>
</table>
</div></h5>
<h5 class="P1"><a name="1030089"> </a><div class="P1Parameter"><table border="0" cellpadding="5" cellspacing="0">
  <tr>
    <td width="180" valign="top"><span style="font-family: monospace">&lt;-&gt; userData68KP</td><td valign="top"></span>The <span style="font-family: monospace">userDataP</span> argument that was passed in to <span style="font-family: monospace">PceNativeCall</span>, byte-swapped so it can be dereferenced directly by the ARM code. See <a href="SystemFeatures.html#1014448">"Accessing 68K Data From an ARM Function,"</a> below, for tips on accessing the data block indicated by this pointer.</td>
  </tr>
</table>
</div></h5>
<h5 class="P1"><a name="1024786"> </a><div class="P1Parameter"><table border="0" cellpadding="5" cellspacing="0">
  <tr>
    <td width="180" valign="top"><span style="font-family: monospace">-&gt; call68KFunc</span></td><td valign="top">A hook to call back into the PACE emulated environment from ARM code. It is used for both OS function calls and application callbacks. See <a href="SystemFeatures.html#1014546">"Calling a Function via a Function Pointer"</a> for more information.</td>
  </tr>
</table>
</div></h5>
<p class="Body">
  <a name="1024790"> </a>ARM entry-point functions should return a value that is meaningful to the 68K side, since that value is passed back to the calling code. If no value is meaningful, return 0. Both register A0 and D0 are set to this return value, making it meaningful to code that is expecting either a pointer or an immediate result.
</p>

<h2 class="HBHeadB">
  <a name="1014448"> </a>Accessing 68K Data From an ARM Function
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1024829"> </a>When writing an ARM function that accesses data in the parameter block passed in from the 68K side, you need to be aware of differences in endianness, word alignment, and structure packing.
</p>

  <a name="1022605"> </a><p class="B1Bullet"> &#8226; The 68K processor is big endian, while Palm OS 5 uses the ARM processor in little-endian mode. Because of this, you'll need to byte-swap all 2- and 4-byte integers and pointers (other than <span style="font-family: monospace">userData68KP</span>, which is already byte-swapped for you).</p>

  <a name="1014449"> </a><p class="B1Bullet"> &#8226; 68K structures generally are aligned to 2-byte boundaries. (This includes stack-based structures.) The ARM processor expects 4-byte values to be aligned on a 4-byte boundary. Copy 4-byte integers into local variables before using them, but note that because of possible alignment problems a simple pointer dereference won't do when copying the values; you must provide your own unaligned read and write functions. Note that <a href="MemoryManager.html#1133348"><span style="font-family: monospace">MemPtrNew</span></a> returns chunks beginning on 4-byte boundaries; careful structure layout can avoid alignment (but not endian) problems.</p>

  <a name="1022619"> </a><p class="B1Bullet"> &#8226; Depending on the compiler options specified, a given compiler can add padding bytes to align structure components on a given byte boundary. If the ARM compiler you use expects structures to be aligned other than how they are by the 68K compiler, errors in alignment will result. You'll generally want to make a local copy of any structures that you use.</p>
<p class="Body">
  <a name="1026289"> </a>The macros in <a href="SystemFeatures.html#1026419">Listing 10.7</a> can prove very useful in your ARM code. <span style="font-family: monospace">ByteSwap16</span> and <span style="font-family: monospace">ByteSwap32</span> perform byte swapping on 2- and 4-byte quantities, respectively. <span style="font-family: monospace">Write68KUnaligned32</span> and <span style="font-family: monospace">Read68KUnaligned32</span> copy 4-byte integers to and from a location in memory that is not necessarily aligned on a 4-byte boundary.
</p>
<p class="CCodeCaption">
  <a name="1026419"> </a>Listing 10.7  Byte-swapping macros
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
#define ByteSwap16(n) ( ((((unsigned int) n) &lt;&lt; 8) &amp; 0xFF00) | \<a name="1026296"> </a>
                        ((((unsigned int) n) &gt;&gt; 8) &amp; 0x00FF) )<a name="1026297"> </a>
<a name="1026298"> </a>
#define ByteSwap32(n) ( ((((unsigned long) n) &lt;&lt; 24) &amp; 0xFF000000) |    \<a name="1026299"> </a>
                        ((((unsigned long) n) &lt;&lt;  8) &amp; 0x00FF0000) |    \<a name="1026300"> </a>
                        ((((unsigned long) n) &gt;&gt;  8) &amp; 0x0000FF00) |    \<a name="1026301"> </a>
                        ((((unsigned long) n) &gt;&gt; 24) &amp; 0x000000FF) )<a name="1026302"> </a>
<a name="1026303"> </a>
#define Read68KUnaligned32(addr)  \<a name="1026304"> </a>
  ( ((((unsigned char *)(addr))[0]) &lt;&lt; 24) | \<a name="1026305"> </a>
    ((((unsigned char *)(addr))[1]) &lt;&lt; 16) | \<a name="1026306"> </a>
    ((((unsigned char *)(addr))[2]) &lt;&lt;  8) | \<a name="1026307"> </a>
    ((((unsigned char *)(addr))[3])) )<a name="1026308"> </a>
<a name="1026309"> </a>
#define Write68KUnaligned32(addr, value) \<a name="1026359"> </a>
  ( ((unsigned char *)(addr))[0]=(unsigned char)((unsigned long)(value)&gt;&gt;24), \<a name="1026360"> </a>
    ((unsigned char *)(addr))[1]=(unsigned char)((unsigned long)(value)&gt;&gt;16), \<a name="1026312"> </a>
    ((unsigned char *)(addr))[2]=(unsigned char)((unsigned long)(value)&gt;&gt;8), \<a name="1026313"> </a>
    ((unsigned char *)(addr))[3]=(unsigned char)((unsigned long)(value)) )<a name="1026314"> </a>
</pre><div class="CodeRule"><hr></div>

<h2 class="HBHeadB">
  <a name="1014452"> </a>Embedding ARM Code in a 68K Application
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014455"> </a>Regardless of the mechanism that you use to generate the ARM binary, there are a couple of different ways to get it into a <span style="font-family: monospace">.prc</span> file:
</p>

  <a name="1014456"> </a><p class="B1Bullet"> &#8226; Use CodeWarrior or a tool such as PilRC to place the raw ARM binary into a resource file. Then simply include this resource file in your 68K project. This is the easiest of the alternatives by far.</p>

  <a name="1014460"> </a><p class="B1Bullet"> &#8226; Copy the resulting binary data into a different resource file as hex data. Use a hex dump utility to process the ARM binary file into a resource.</p>

  <a name="1014461"> </a><p class="B1Bullet"> &#8226; Include the ARM code directly in your application's source as integer arrays. Note, however, that the arrays are interpreted as big-endian by the 68K compiler, and as little-endian by the ARM processor. Thus you must byte swap the integer values to get appropriate opcodes. Also, the array itself must be 4-byte aligned in your source, so insure that your compiler settings are appropriate to produce this.</p>

<h4 class="HCHeadC">
  <a name="1022777"> </a>Native-ARM Code and the Palm OS Simulator
</h4>
<p class="Body">
  <a name="1029067"> </a>Palm OS Simulator doesn't run ARM code. Instead, it provides an implementation of Palm OS 5 running as a native Windows application. Similarly, any ARM function you write must be compiled as a Windows DLL in order to be used with Simulator. Your 68K code must recognize that it is running on Simulator (as described in <a href="SystemFeatures.html#1014424">"Calling an ARM Function"</a>) and supply a pointer to the name of the DLL and the function within that DLL when calling your "ARM" function. These two names must be separated by a null character, and the entire sequence must be terminated by a null character. For example, to load the DLL found at <span style="font-family: monospace">C:\TEST_DLL\Debug\Simple.dll</span> and call the function <span style="font-family: monospace">TestNativeCall</span> within that DLL, you might pass a pointer to the following character string literal:
</p>
<p class="Body">
  <a name="1029068"> </a><span style="font-family: monospace">"C:\\TEST_DLL\\Debug\\Simple.dll\0TestNativeCall"</span>
</p>
<p class="Body">
  <a name="1029069"> </a>Note that if you don't supply an absolute path, Simulator looks for the DLL in (or relative to) the directory from which <span style="font-family: monospace">PalmSim.exe</span> is running. Thus, if the DLL is located in the same directory as <span style="font-family: monospace">PalmSim.exe</span>, you can call the above function with:
</p>
<p class="Body">
  <a name="1029070"> </a><span style="font-family: monospace">"Simple.dll\0TestNativeCall"</span>
</p>

<h2 class="HBHeadB">
  <a name="1014490"> </a>Calling Palm OS Functions From ARM Code
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1030076"> </a>In Palm OS 5, native ARM code can call back into the 68K world, either to call Palm OS functions or to call developer-provided callbacks. A single entry point, <span style="font-family: monospace">Call68KFuncType</span>, provides the mechanism for calling both developer-specified 68K functions and OS functions via traps. This function is declared in <span style="font-family: monospace">PceNativeCall.h</span> as follows:
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
typedef unsigned long Call68KFuncType(const void *emulStateP,
unsigned long trapOrFunction, const void *argsOnStackP,
unsigned long argsSizeAndwantA0)<a name="1030077"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="1023239"> </a>The function parameters are defined as follows:
</p>
<h5 class="P1"><a name="1023192"> </a><div class="P1Parameter"><table border="0" cellpadding="5" cellspacing="0">
  <tr>
    <td width="180" valign="top"><span style="font-family: monospace">-&gt; emulStateP</span></td><td valign="top">Pointer to the PACE emulation state. Supply the pointer that was passed to your ARM function by PACE.</td>
  </tr>
</table>
</div></h5>
<h5 class="P1"><a name="1023193"> </a><div class="P1Parameter"><table border="0" cellpadding="5" cellspacing="0">
  <tr>
    <td width="180" valign="top"><span style="font-family: monospace">-&gt; trapOrFunction</td><td valign="top"></span>The trap number AND'ed with <span style="font-family: monospace">kPaceNativeTrapNoMask</span>, or a pointer to the function to call. Any value less than <span style="font-family: monospace">kPceNativeTrapNoMask</span> is treated as a trap number.</td>
  </tr>
</table>
</div></h5>
<h5 class="P1"><a name="1023196"> </a><div class="P1Parameter"><table border="0" cellpadding="5" cellspacing="0">
  <tr>
    <td width="180" valign="top"><span style="font-family: monospace">-&gt; argsOnStackP</td><td valign="top"></span>Native (little-endian) pointer to a block of memory to be copied to the 68K stack prior to the function call. This memory normally contains the arguments for the 68K function being called. <span style="font-family: monospace">Call68KFuncType</span> pops these values from the 68K stack before returning.</td>
  </tr>
</table>
</div></h5>
<h5 class="P1"><a name="1023200"> </a><div class="P1Parameter"><table border="0" cellpadding="5" cellspacing="0">
  <tr>
    <td width="180" valign="top"><span style="font-family: monospace"> -&gt; argsSizeAndwantA0</td><td valign="top"></span>The number of bytes, in little-endian format, from <span style="font-family: monospace">argsOnStackP</span> that are to be copied to the 68K emulator stack. If the function or trap returns its result in 68K register A0 (as when the result is a pointer type), you must OR the byte count with <span style="font-family: monospace">kPceNativeWantA0</span>.</td>
  </tr>
</table>
</div></h5>
<p class="Body">
  <a name="1023700"> </a>The return value from the 68K function (passed either in the 68K register D0 or A0) is returned as the result of this function, based on <span style="font-family: monospace">argsSizeAndwantA0</span>. It is returned in native (little-endian) form.
</p>
<p class="Body">
  <a name="1023387"> </a>Because of the amount of effort involved in getting parameters byte-swapped and properly aligned, if your ARM code routinely needs to call a series of operating system functions you may find it easier to write a small 68K callback function that calls the operating system functions, and then call this 68K function instead.
</p>

<h4 class="HCHeadC">
  <a name="1014507"> </a>Calling a Trap
</h4>
<p class="Body">
  <a name="1014508"> </a><a href="SystemFeatures.html#1014509">Listing 10.8</a> shows how to call an operating system function from ARM native code using the function's trap number. This sample calls <span style="font-family: monospace">MemPtrNew</span> to allocate a block of 10 bytes, initializes that block, and returns it as the result of the ARM function.
</p>
<p class="CCodeCaption">
  <a name="1014509"> </a>Listing 10.8  Calling a Palm OS function from ARM code
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
/* This armlet makes a call (through PACE) to MemPtrNew to allocate a buffer. <a name="1027520"> </a>
 * The arguments to the OS function (here just size) must be on the stack, and<a name="1027833"> </a>
 * must be in big-endian format.<a name="1030106"> </a>
 */<a name="1027532"> </a>
<a name="1027533"> </a>
#include "PceNativeCall.h"<a name="1027536"> </a>
<a name="1027539"> </a>
#include "endianutils.h" // byte-swapping macros<a name="1027540"> </a>
<a name="1027541"> </a>
// from CoreTraps.h<a name="1027544"> </a>
#define sysTrapMemPtrNew 0xA013 // we need this in order to call into MemPtrNew<a name="1027546"> </a>
<a name="1027549"> </a>
// prototype for our OS call convenience function<a name="1030099"> </a>
void *PalmOS_MemPtrNew (const void *emulStateP, Call68KFuncType *call68KFuncP,<a name="1030100"> </a>
unsigned long sizeLE);<a name="1030103"> </a>
<a name="1027555"> </a>
// This is the main entry point into the armlet.  It's the first function in<a name="1027556"> </a>
// the file so we can calculate its address easily.<a name="1030104"> </a>
unsigned long NativeFunction (const void *emulStateP, void *userData68KP,<a name="1028108"> </a>
Call68KFuncType *call68KFuncP) {<a name="1030105"> </a>
    unsigned char *bufferP;<a name="1028109"> </a>
    int i;<a name="1027566"> </a>
<a name="1027569"> </a>
// allocate 10 bytes of memory using a convenience function<a name="1027570"> </a>
    bufferP = (unsigned char*)PalmOS_MemPtrNew(emulStateP, call68KFuncP, 10);<a name="1027572"> </a>
<a name="1027575"> </a>
// Do something with the bytes in the buffer<a name="1027576"> </a>
    for (i = 0; i &lt; 9; i++) bufferP[i] = i+'A'; // write in "ABCDEFGHI"<a name="1027578"> </a>
    bufferP[9] = 0;                            // terminate the string<a name="1027580"> </a>
<a name="1027583"> </a>
    return (unsigned long)bufferP;<a name="1027584"> </a>
}<a name="1027586"> </a>
<a name="1027588"> </a>
<a name="1027589"> </a>
// Convenience function for calling MemPtrNew within ARM code<a name="1027590"> </a>
void *PalmOS_MemPtrNew(const void *emulStateP, Call68KFuncType *call68KFuncP,<a name="1027592"> </a>
unsigned long sizeLE) {<a name="1030107"> </a>
    // First, declare the argument(s) that will be passed to the OS call.<a name="1027596"> </a>
    // In this case, we're calling MemPtrNew, so we need a size argument.<a name="1027598"> </a>
    // Because this code is compiled by an ARM compiler (little endian),<a name="1027602"> </a>
    // and MemPtrNew expects its argument to be big endian, swap it.<a name="1027604"> </a>
    unsigned long sizeBE = ByteSwap32(sizeLE);<a name="1027606"> </a>
<a name="1027609"> </a>
    // Call the trap. Note that because MemPtrNew returns a pointer, the byte<a name="1028515"> </a>
    // count (the last parameter) must be "OR'd" with kPceNativeWantA0.<a name="1028532"> </a>
    return ((void *)((call68KFuncP)(emulStateP,<a name="1027610"> </a>
        PceNativeTrapNo(sysTrapMemPtrNew), &amp;sizeBE, 4 | kPceNativeWantA0))); <a name="1030108"> </a>
}<a name="1028490"> </a>
</pre><div class="CodeRule"><hr></div>

<h4 class="HCHeadC">
  <a name="1014546"> </a>Calling a Function via a Function Pointer
</h4>
<p class="Body">
  <a name="1014547"> </a>The code excerpt in <a href="SystemFeatures.html#1014549">Listing 10.9</a> shows how to pass a 68K callback function pointer to ARM native code, and <a href="SystemFeatures.html#1014577">Listing 10.10</a> shows how to call that 68K function from within the ARM code. The ARM code ultimately accomplishes the same result as in the previous example (calling <span style="font-family: monospace">MemPtrNew</span>), but this example lets the 68K-side callback function do the allocation. Note that the pointer to the callback function is passed to the ARM code as data, embedded in a structure.
</p>
<p class="Body">
  <a name="1014548"> </a>The following is implemented on the 68K side:
</p>
<p class="CCodeCaption">
  <a name="1014549"> </a>Listing 10.9  Calling PACE application code from ARM code (68K side)
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
typedef struct MyParamsTag {<a name="1024110"> </a>
    void *myAllocateFunctionP;<a name="1024112"> </a>
    UInt32 anotherValue;<a name="1024113"> </a>
} MyParamsType;<a name="1024114"> </a>
<a name="1024115"> </a>
// function to allocate 10 bytes<a name="1024117"> </a>
void *MyAllocateFunction() {<a name="1024118"> </a>
    return MemPtrNew(10);<a name="1024120"> </a>
}<a name="1024121"> </a>
<a name="1024122"> </a>
// code to call the native function, defined in the next listing<a name="1024124"> </a>
MyParamsType myParams;<a name="1024125"> </a>
MemHandle armChunkH;<a name="1024126"> </a>
void *myNativeFuncP;<a name="1024127"> </a>
Byte *result;<a name="1024128"> </a>
<a name="1024129"> </a>
armChunkH = DmGetResource('armc', 0);<a name="1024130"> </a>
myNativeFuncP = MemHandleLock(armChunkH);<a name="1024131"> </a>
<a name="1024132"> </a>
myParams.myAllocateFunctionP  = &amp;MyAllocateFunction;<a name="1024133"> </a>
<a name="1024134"> </a>
result = (Byte *)PceNativeCall(myNativeFuncP, &amp;myParams);<a name="1024135"> </a>
</pre><div class="CodeRule"><hr></div>
<p class="Body">
  <a name="1014576"> </a>In the ARM file, the following code accepts the callback function pointer and uses the 68K function to allocate the 10-byte memory block:
</p>
<p class="CCodeCaption">
  <a name="1014577"> </a>Listing 10.10  Calling PACE application code from ARM code (ARM side)
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
typedef struct MyParamsTag {<a name="1024336"> </a>
    void *myAllocateFunctionP;<a name="1024338"> </a>
    unsigned long anotherValue;<a name="1024339"> </a>
} MyParamsType;<a name="1024340"> </a>
<a name="1024341"> </a>
unsigned long MyNativeFunc(const void *emulStateP,<a name="1024342"> </a>
  void *userData68KP, Call68KFuncType *call68KFunc) {<a name="1024343"> </a>
    unsigned char *buffer68K; // array of Byte<a name="1024345"> </a>
    unsigned char i; // Byte<a name="1024346"> </a>
    void *my68KFuncP;<a name="1024347"> </a>
<a name="1024348"> </a>
    // get the function pointer out of the passed parameter block<a name="1024349"> </a>
    my68KfuncP = ByteSwap4(userData68KP-&gt;myAllocateFunctionP);<a name="1024350"> </a>
<a name="1024351"> </a>
    // invoke the callback function to allocate 10 bytes<a name="1024352"> </a>
    buffer68K = (void *)((call68KFunc)(emulStateP, my68KFuncP, 
        &amp;size, 4 | kPceNativeWantA0));<a name="1024354"> </a>
<a name="1024355"> </a>
    // do something with the bytes in the buffer<a name="1024356"> </a>
    for (i = 10; i &gt; 0; i--)<a name="1024357"> </a>
        buffer68K[i] = i;<a name="1024358"> </a>
<a name="1024359"> </a>
    return (unsigned long)buffer68K;<a name="1024360"> </a>
}<a name="1024361"> </a>
</pre><div class="CodeRule"><hr></div>

<h2 class="HaHeadA">
  <a name="1014605"> </a>Hardware Interaction 
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014608"> </a>Palm OS differs from a traditional desktop system in that it's never really turned off. Power is constantly supplied to essential subsystems and the on/off key is merely a way of bringing the handheld in or out of low-power mode. The obvious effect of pressing the on/off key is that the LCD turns on or off. When the user presses the power key to turn the handheld off, the LCD is disabled, which makes it appear as if power to the entire unit is turned off. In fact, the memory system, real-time clock, and the interrupt generation circuitry are still running, though they are consuming little current. 
</p>
<p class="Body">
  <a name="1014609"> </a>This section looks at Palm OS power management, discussing the following topics:
</p>

  <a name="1014613"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014623">Palm OS Power Modes</a></p>

  <a name="1014617"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014641">Guidelines for Application Developers</a></p>

  <a name="1014621"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014654">Power Management Calls</a></p>

<h2 class="HBHeadB">
  <a name="1014623"> </a>Palm OS Power Modes
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014625"> </a>To minimize power consumption, the operating system dynamically switches between three different modes of operation: sleep mode, doze mode, and running mode. The system manager controls transitions between different power modes and provides an API for controlling some aspects of the power management. 
</p>

  <a name="1014628"> </a><p class="B1Bullet"> &#8226; In <b>sleep mode</b>, the handheld looks like it's turned off: the display is blank, the digitizer is inactive, and the main clock is stopped. The only circuits still active are the real-time clock and interrupt generation circuitry. </p>
<p class="Indented1"> <a name="1014629"> </a>The handheld enters this mode when there is no user activity for a number of minutes or when the user presses the off button. The handheld comes out of sleep mode only when there is an interrupt, for example, when the user presses a button. </p>
<p class="Indented1"> <a name="1014630"> </a>To enter sleep mode, the system puts as many peripherals as possible into low-power mode and sets up the hardware so that an interrupt from any hard key or the real-time clock wakes up the system. When the system gets one of these interrupts while in sleep mode, it quickly checks that the battery is strong enough to complete the wake-up and then takes each of the peripherals, for example, the LCD, serial port, and timers, out of low-power mode. </p>

  <a name="1014632"> </a><p class="B1Bullet"> &#8226; In<span style="color: #333;;  font-style: italic; font-weight: normal; text-decoration: none; text-transform: none; vertical-align: baseline"> </span><span style="color: #333;;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">doze mode</span>, the main clock is running, the handheld appears to be turned on, the LCD is on, and the processor's clock is running but it's not executing instructions (that is, it's halted). When the processor receives an interrupt, it comes out of halt and starts processing the interrupt. </p>
<p class="Indented1"> <a name="1014633"> </a>The handheld enters this mode whenever it's on but has no user input to process.</p>
<p class="Indented1"> <a name="1014634"> </a>The system can come out of doze mode much faster than it can come out of sleep mode since none of the peripherals need to be woken up. In fact, it takes no longer to come out of doze mode than to process an interrupt. Usually, when the system appears on, it is actually in doze mode and goes into running mode only for short periods of time to process an interrupt or respond to user input like a pen tap or key press. </p>

  <a name="1014636"> </a><p class="B1Bullet"> &#8226; In <b>running mode</b>, the processor is actually executing instructions. </p>
<p class="Indented1"> <a name="1014637"> </a>The handheld enters this mode when it detects user input (like a tap on the screen) while in doze mode or when it detects an interrupt while in doze or sleep mode. The handheld stays in running mode only as long as it takes to process the user input (most likely less than a second), then it immediately reenters doze mode. A typical application puts the system into running mode only about 5% of the time. </p>
<p class="Body">
  <a name="1014639"> </a>To maximize battery life, the processor on the Palm Powered handheld is kept out of running mode as much as possible. Any interrupt generated on the handheld must therefore be capable of "waking" up the processor. The processor can receive interrupts from the serial port, the hard buttons on the case, the button on the cradle, the programmable timer, the memory module slot, the real-time clock (for alarms), the low-battery detector, and any built-in peripherals such as a pager or modem. 
</p>

<h2 class="HBHeadB">
  <a name="1014641"> </a>Guidelines for Application Developers
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014643"> </a>Normally, applications don't need to be aware of power management except for a few simple guidelines. When an application calls <a href="SystemEventManager.html#1161014"><span style="font-family: monospace">EvtGetEvent</span></a> to ask the system for the next event to process, the system automatically puts itself into doze mode until there is an event to process. As long as an application uses <span style="font-family: monospace">EvtGetEvent</span>, power management occurs automatically. If there has been no user input for the amount of time determined by the current setting of the auto-off preference, the system automatically enters sleep mode without intervention from the application.
</p>
<p class="Body">
  <a name="1014648"> </a>Applications should avoid providing their own delay loops. Instead, they should use <a href="SystemManager.html#1166386"><span style="font-family: monospace">SysTaskDelay</span></a>, which puts the system into doze mode during the delay to conserve as much power as possible. If an application needs to perform periodic work, it can pass a time out to <span style="font-family: monospace">EvtGetEvent</span>; this forces the unit to wake up out of doze mode and to return to the application when the time out expires, even if there is no event to process. Using these mechanisms provides the longest possible battery life.
</p>

<h2 class="HBHeadB">
  <a name="1014654"> </a>Power Management Calls
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014655"> </a>The system calls <span style="font-family: monospace">SysSleep</span> to put itself immediately into low-power sleep mode. Normally, the system puts itself to sleep when there has been no user activity for the minimum auto-off time or when the user presses the power key. 
</p>
<p class="Body">
  <a name="1014660"> </a>The <a href="SystemManager.html#1166328"><span style="font-family: monospace">SysSetAutoOffTime</span></a> routine changes the auto-off time value. This routine is normally used by the system only during boot, and by the Preferences application. The Preferences application saves the user preference for the auto-off time in a preferences database, and the system initializes the auto-off time to the value saved in the preferences database during boot. While the auto-off feature can be disabled entirely by calling <span style="font-family: monospace">SysSetAutoOffTime</span> with a time-out of 0, doing this depletes the battery. 
</p>
<p class="Body">
  <a name="1014662"> </a>The current battery level and other information can be obtained through the <a href="SystemManager.html#1165585"><span style="font-family: monospace">SysBatteryInfo</span></a> routine. This call returns information about the battery, including the current battery voltage in hundredths of a volt, the warning thresholds for the low-battery alerts, the battery type, and whether external power is applied to the unit. This call can also change the battery warning thresholds and battery type. 
</p>

<h2 class="HaHeadA">
  <a name="1014669"> </a>The Microkernel 
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014671"> </a>Palm OS has a preemptive multitasking kernel that provides basic task management.
</p>
<p class="Body">
  <a name="1014672"> </a>Most applications don't need the microkernel services because they are handled automatically by the system. This functionality is provided mainly for internal use by the system software or for certain special purpose applications. 
</p>
<p class="Body">
  <a name="1014673"> </a>In this version of the Palm OS, there is only one user interface application running at a time. The User Interface Application Shell (UIAS) is responsible for managing the current user-interface application. The UIAS launches the current user-interface application as a subroutine and doesn't get control back until that application quits. When control returns to the UIAS, the UIAS immediately launches the next application as another subroutine. See <a href="SystemFeatures.html#1014654">"Power Management Calls"</a> for more information. 
</p>
<p class="Body">
  <a name="1014679"> </a>Usually, the UIAS is the only task running. Occasionally though, an application launches another task as a part of its normal operation. One example of this is the Sync application, which launches a second task to handle the serial communication with the desktop. The Sync application creates a second task dedicated to the serial communication and gives this task a lower priority than the main user-interface task. The result is optimal performance over the serial port without a delay in response to the user-interface controls. 
</p>
<p class="Body">
  <a name="1014681"> </a>Normally, there is no user interaction during a sync, so that the serial communication task gets all of the processor's time. However, if the user does tap on the screen, for example, to cancel the sync, the user-interface task immediately processes the tap, since it has a higher priority. Alternatively, the Sync application could have been written to use just one task, but then it would have to periodically poll for user input during the serial communication, which would hamper performance and user-interface response time.
</p>
<div class="NINoteImportant"><hr>
  <a name="1014684"> </a> <span style="color: #333;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">NOTE:  </span> Only system software can launch a separate task. The multi-tasking API is not available to developer applications.
<hr>
</div>

<h2 class="HaHeadA">
  <a name="1014692"> </a>Retrieving the ROM Serial Number 
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014693"> </a>Some Palm<sup>&#8482;</sup> handhelds, beginning with the Palm III product, hold a 12-digit serial number that identifies the handheld uniquely. (Earlier handhelds do not have this identifier.) The serial number is held in a displayable text buffer with no null terminator. The user can view the serial number in the <a href="UserInterface.html#983047">Application Launcher</a> application. (The pop-up version of the Launcher does not display the serial number.) The Application Launcher also displays to the user a checksum digit that you can use to validate user entry of the serial number. 
</p>
<p class="Body">
  <a name="1014697"> </a>To retrieve the ROM serial number programmatically, pass the <span style="font-family: monospace">sysROMTokenSnum</span> selector to the <a href="SystemManager.html#1165924"><span style="font-family: monospace">SysGetROMToken</span></a><span style="font-family: monospace"> </span>function. If the <a href="SystemManager.html#1165924"><span style="font-family: monospace">SysGetROMToken</span></a><span style="font-family: monospace"> </span>function returns an error, or if the returned pointer to the buffer is <span style="font-family: monospace">NULL</span>, or if the first byte of the text buffer is <span style="font-family: monospace">0xFF</span>, then no serial number is available.
</p>
<p class="Body">
  <a name="1014707"> </a>The <span style="font-family: monospace">DrawSerialNumOrMessage</span> function shown in <a href="SystemFeatures.html#1014710">Listing 10.11</a> retrieves the ROM serial number, calculates the checksum, and draws both on the screen at a specified location. If the handheld has no serial number, this function draws a message you specify. This function accepts as its input a pair of coordinates at which it draws output, and a pointer to the message it draws when a serial number is not available. 
</p>
<p class="CCodeCaption">
  <a name="1014710"> </a>Listing 10.11  DrawSerialNumOrMessage
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
static void DrawSerialNumOrMessage(Int16 x, Int16 y, Char*
noNumberMessage)<a name="1014711"> </a>
{<a name="1014712"> </a>
   Char* bufP;<a name="1014713"> </a>
   UInt16* bufLen;<a name="1014714"> </a>
   Err retval;<a name="1014715"> </a>
   Int16    count;<a name="1014716"> </a>
   UInt8    checkSum;<a name="1014717"> </a>
   Char    checksumStr[2];<a name="1014718"> </a>
      // holds the dash and the checksum digit<a name="1014719"> </a>
 <a name="1014720"> </a>
   retval = SysGetROMToken (0, sysROMTokenSnum,
                                      (UInt8**) &amp;bufP, &amp;bufLen);<a name="1014721"> </a>
   if ((!retval) &amp;&amp; (bufP) &amp;&amp; ((UInt8) *bufP != 0xFF)) { 
      // there's a valid serial number!<a name="1014722"> </a>
      // Calculate the checksum:  Start with zero, add each digit,
      // then rotate the result one bit to the left and repeat.<a name="1014723"> </a>
         checkSum = 0;<a name="1014724"> </a>
         for (count=0; count&lt;bufLen; count++) {<a name="1014725"> </a>
            checkSum += bufP[count];<a name="1014726"> </a>
            checkSum = (checkSum&lt;&lt;1) | ((checkSum &amp; 0x80) &gt;&gt; 7);<a name="1014727"> </a>
            }<a name="1014728"> </a>
      // Add the two hex digits (nibbles) together, +2 
      // (range: 2 - 31 ==&gt; 2-9, A-W)<a name="1014729"> </a>
      // By adding 2 to the result before converting to ascii,
      // we eliminate the numbers 0 and 1, which can be
      // difficult to distinguish from the letters O and I.
      checkSum = ((checkSum&gt;&gt;4) &amp; 0x0F) + (checkSum &amp; 0x0F) + 2;<a name="1014730"> </a>
 <a name="1014731"> </a>
      // draw the serial number and find out how wide it was
      WinDrawChars(bufP, bufLen, x, y);
      x += FntCharsWidth(bufP, bufLen);<a name="1014732"> </a>
 <a name="1014733"> </a>
      // draw the dash and the checksum digit right after it
      checksumStr[0] = '-';
      checksumStr[1] = 
         ((checkSum &lt; 10) ? (checkSum +'0'):(checkSum -10 +'A'));
      WinDrawChars (checksumStr, 2, x, y);
      }<a name="1014734"> </a>
      else // there's no serial number
      // draw a status message if the caller provided one
      if (noNumberMessage)
         WinDrawChars(noNumberMessage, StrLen(noNumberMessage),x, y);<a name="1014735"> </a>
}<a name="1014737"> </a>
</pre><div class="CodeRule"><hr></div>

<h2 class="HaHeadA">
  <a name="1014739"> </a>Time 
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014744"> </a>The Palm Powered handheld has a real-time clock and programmable timer as part of the 68328 processor. The real-time clock maintains the current time even when the system is in sleep mode (turned off). It's capable of generating an interrupt to wake the handheld when an alarm is set by the user. The programmable timer is used to generate the system tick count interrupts (100 times/second) while the processor is in doze or running mode. The system tick interrupts are required for periodic activity such as polling the digitizer for user input, key debouncing, etc.
</p>
<p class="Body">
  <a name="1014750"> </a>The date and time manager (called time manager in this chapter) provides access to both the 1-second and 0.01-second timing resources on the Palm Powered handheld. 
</p>

  <a name="1014753"> </a><p class="B1Bullet"> &#8226; The <span style="color: #333;;  font-style: normal; font-weight: normal; text-decoration: underline; text-transform: none; vertical-align: baseline">1-second timer</span> keeps track of the real-time clock (date and time), even when the unit is in sleep mode. </p>

  <a name="1014756"> </a><p class="B1Bullet"> &#8226; The <span style="color: #333;;  font-style: normal; font-weight: normal; text-decoration: underline; text-transform: none; vertical-align: baseline">0.01-second timer</span>, also referred to as the <span style="color: #333;;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">system ticks</span>, can be used for finer timing tasks. This timer is not updated when the unit is in sleep mode and is reset to 0 each time the unit resets.</p>
<p class="Body">
  <a name="1014757"> </a>The basic time-manager API provides support for setting and getting the real-time clock in seconds and for getting the current system ticks value (but not for setting it). The system manager provides more advanced functionality for setting up a timer task that executes periodically or in a given number of system ticks.
</p>
<p class="Body">
  <a name="1014758"> </a>This section discusses the following topics: 
</p>

  <a name="1014762"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014768">Using Real-Time Clock Functions</a></p>

  <a name="1014766"> </a><p class="B1Bullet"> &#8226; <a href="SystemFeatures.html#1014788">Using System Ticks Functions</a></p>

<h2 class="HBHeadB">
  <a name="1014768"> </a>Using Real-Time Clock Functions
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014770"> </a>The real-time clock functions of the time manager include <a href="DateAndTimeManager.html#1174761"><span style="font-family: monospace">TimSetSeconds</span></a> and <a href="DateAndTimeManager.html#1174695"><span style="font-family: monospace">TimGetSeconds</span></a>. Real time on the Palm Powered handheld is measured in seconds from midnight, Jan. 1, 1904. Call <a href="DateAndTimeManager.html#1174736"><span style="font-family: monospace">TimSecondsToDateTime</span></a> and <a href="DateAndTimeManager.html#1174674"><span style="font-family: monospace">TimDateTimeToSeconds</span></a> to convert between seconds and a structure specifying year, month, day, hour, minute, and second.
</p>

<h2 class="HBHeadB">
  <a name="1014788"> </a>Using System Ticks Functions
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014789"> </a>The Palm Powered handheld maintains a tick count that starts at 0 when the handheld is reset. This tick increments 
</p>

  <a name="1014790"> </a><p class="B1Bullet"> &#8226; 100 times per second when running on the Palm Powered handheld</p>

  <a name="1014792"> </a><p class="B1Bullet"> &#8226; 60 times per second when running on the Macintosh under the Simulator</p>
<p class="Body">
  <a name="1014795"> </a>For tick-based timing purposes, applications should use the macro <a href="SystemManager.html#1166408"><span style="font-family: monospace">SysTicksPerSecond</span></a>, which is conditionally compiled for different platforms. Use the function <a href="DateAndTimeManager.html#1174713"><span style="font-family: monospace">TimGetTicks</span></a> to read the current tick count.
</p>
<p class="Body">
  <a name="1014804"> </a>Although the <span style="font-family: monospace">TimGetTicks</span> function could be used in a loop to implement a delay, it is recommended that applications use the <a href="SystemManager.html#1166386"><span style="font-family: monospace">SysTaskDelay</span></a> function instead. The <span style="color: #333;;  font-style: normal; font-weight: normal; text-decoration: none; text-transform: none; vertical-align: baseline">SysTaskDelay</span> function automatically puts the unit into low-power mode during the delay. Using <span style="font-family: monospace">TimGetTicks</span> in a loop consumes much more current.
</p>

<h2 class="HaHeadA">
  <a name="1014810"> </a>Floating-Point 
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>

<p class="Body">
  <a name="1014811"> </a>The Palm OS supports IEEE-754 single and double precision floating-point numbers declared with the C types <span style="font-family: monospace">float</span> and <span style="font-family: monospace">double</span>. Numbers of type <span style="font-family: monospace">float</span> occupy four bytes and have an effective range of 1.17549e-38 to 3.40282e+38. Numbers of type <span style="font-family: monospace">double</span> occupy eight bytes and have an effective range of <br>2.22507e-308 to 1.79769e+308.
</p>
<p class="Body">
  <a name="1014812"> </a>You can use basic arithmetic operations to add, subtract, multiply, and divide numbers of type <span style="font-family: monospace">float</span> and <span style="font-family: monospace">double</span>. Higher-level functions such as those in the standard C header file <span style="font-family: monospace">math.h</span> are not part of the core OS; you must either write them yourself, or you must employ a third-party math library.
</p>
<p class="Body">
  <a name="1014813"> </a>The standard IEEE-754 special "non-number" values of NaN (not a number), +INF (positive infinity), and -INF (negative infinity) are generated as appropriate if you perform an operation that produces a result outside the range of numbers that can be represented. For instance, dividing a positive number by 0 returns +INF.
</p>
<p class="Body">
  <a name="1014814"> </a>The Float Manager contains functions that convert double-precision floating-point numbers to and from a string using scientific notation. It also contains <a href="FloatManager.html#1116878"><span style="font-family: monospace">FlpBufferCorrectedAdd</span></a> and <a href="FloatManager.html#1116906"><span style="font-family: monospace">FlpBufferCorrectedSub</span></a>, which perform the indicated operation and correct the result in those situations where the result should be zero but isn't due to the way that floating-point numbers are represented. All of the Float Manager functions that either accept or return a floating-point number require it to be declared as an <span style="font-family: monospace">FlpDouble</span>. The Float Manager defines a union, <a href="FloatManager.html#1116627"><span style="font-family: monospace">FlpCompDouble</span></a>, that you use to declare values that can be interpreted either as a <span style="font-family: monospace">double</span> or as an <span style="font-family: monospace">FlpDouble</span>. You use this union as shown here:
</p>
<div class="CodeRule"><hr></div><pre class="CodeBlock">
double dblFlpCorrectedAdd (double d1, double d2, Int16 acc) {<a name="1014824"> </a>
    FlpCompDouble fcd1, fcd2, fcdResult;<a name="1014825"> </a>
 <a name="1014826"> </a>
    fcd1.d = d1;<a name="1014827"> </a>
    fcd2.d = d2;<a name="1014828"> </a>
    FlpBufferCorrectedAdd(&amp;fcdResult.fd, fcd1.fd, fcd2.fd,
        acc);<a name="1014829"> </a>
    return fcdResult.d;<a name="1014830"> </a>
}<a name="1014831"> </a>
</pre><div class="CodeRule"><hr></div>
<div class="NINoteImportant"><hr>
  <a name="1014832"> </a> <span style="color: #333;  font-style: normal; font-weight: bold; text-decoration: none; text-transform: none; vertical-align: baseline">NOTE:  </span> If you are using CodeWarrior, you have the option of using <a href="FloatManager.html#1116703"><span style="font-family: monospace">FlpAToF</span></a>, <a href="FloatManager.html#1116934"><span style="font-family: monospace">FlpCorrectedAdd</span></a>, and <a href="FloatManager.html#1116966"><span style="font-family: monospace">FlpCorrectedSub</span></a> instead of <a href="FloatManager.html#1116852"><span style="font-family: monospace">FlpBufferAToF</span></a>, <a href="FloatManager.html#1116878"><span style="font-family: monospace">FlpBufferCorrectedAdd</span></a>, and <a href="FloatManager.html#1116906"><span style="font-family: monospace">FlpBufferCorrectedSub</span></a>. These "non-buffer" functions all return their results directly, rather than updating a value pointed to by the first parameter. Because they return an <span style="font-family: monospace">FlpDouble</span>-which is a struct-and because the GCC compiler's convention for returning structures from functions is incompatible with Palm OS, GCC users can only use the <span style="font-family: monospace">FlpBuffer... </span>versions.
<hr>
</div>
<p class="Body">
  <a name="1014851"> </a>In the rare event that you need to work with the binary representation of a <span style="font-family: monospace">double</span>, the Float Manager also contains a number of functions and macros that allow you to obtain and in some cases alter the sign, mantissa, and exponent of a 64-bit floating-point number. See <a href="FloatManager.html#1116606">Chapter 32, "Float Manager,"</a> of the <i>Palm OS Programmer's API Reference</i> for the functions and macros that make up the Float Manager.
</p>
<p class="Body">
  <a name="1014858"> </a>The Float Manager, which was introduced in Palm OS 2.0, is sometimes referred to as the New Float Manager to distinguish it from the Float Manager that was part of Palm OS 1.0. The 1.0 Float Manager, which is less accurate and less convenient to use (simple operations such as addition require a call to a Float Manager function), remains in the ROM solely for backward compatibility; its functions are no longer publicly declared in the Palm OS SDK and should no longer be used. The functions in the old Float Manager all begin with "Fpl" rather than the current "Flp"; see <a href="FloatManagerOld.html#977035">Appendix C, "1.0 Float Manager,"</a> of the <i>Palm OS Programmer's API Reference</i> for the functions that make up the original Float Manager.
</p>

<h2 class="HaHeadA">
  <a name="1014866"> </a>Summary of System Features 
<a href="#1013426"><img src="images/top.gif" border="0"></a></h2>


<h5 class="TgTable">
  <a name="1014902"> </a>

<table border="1" cellpadding="5" cellspacing="0">
  <caption></caption>
  <tr bgcolor="#CCCCCC" valign="top">
    <th><a name="1014870"> </a><div class="CellHeading">Feature Manager Functions</div></th>
    <th><a name="1014872"> </a><div class="CellHeading"><br></div></th>
  </tr>
  <tr valign="top">
    <td colspan="1" rowspan="2"><a name="1014877"> </a><div class="CellBody"><a href="FeatureManager.html#1110037">FtrGet</a><br><a href="FeatureManager.html#1110193">FtrSet</a><br><a href="FeatureManager.html#1110109">FtrPtrNew</a><br><a href="FeatureManager.html#1110158">FtrPtrResize</a></div></td>
    <td colspan="1" rowspan="2"><a name="1014891"> </a><div class="CellBody"><a href="FeatureManager.html#1110060">FtrGetByIndex</a><br><a href="FeatureManager.html#1110224">FtrUnregister</a><br><a href="FeatureManager.html#1110084">FtrPtrFree</a></div></td>
  </tr>
  <tr valign="top">
  </tr>
</table>




</h5>
<h5 class="TgTable">
  <a name="1014946"> </a>

<table border="1" cellpadding="5" cellspacing="0">
  <caption></caption>
  <tr bgcolor="#CCCCCC" valign="top">
    <th><a name="1014905"> </a><div class="CellHeading">Preferences Functions</div></th>
    <th><a name="1014907"> </a><div class="CellHeading"><br></div></th>
  </tr>
  <tr valign="top">
    <td colspan="1" rowspan="2"><a name="1014912"> </a><div class="CellBody"><a href="Preferences.html#1146236">PrefGetAppPreferences</a><br><a href="Preferences.html#1146434">PrefSetAppPreferences</a><br><a href="Preferences.html#1146319">PrefGetPreference</a><br><a href="Preferences.html#1146382">PrefOpenPreferenceDB</a><br><a href="Preferences.html#1146359">PrefGetPreferences</a></div></td>
    <td colspan="1" rowspan="2"><a name="1014929"> </a><div class="CellBody"><a href="Preferences.html#1146291">PrefGetAppPreferencesV10</a><br><a href="Preferences.html#1146482">PrefSetAppPreferencesV10</a><br><a href="Preferences.html#1146510">PrefSetPreference</a><br><a href="Preferences.html#1146411">PrefOpenPreferenceDBV10</a><br><a href="Preferences.html#1146532">PrefSetPreferences</a></div></td>
  </tr>
  <tr valign="top">
  </tr>
</table>




</h5>
<h5 class="TgTable">
  <a name="1014991"> </a>

<table border="1" cellpadding="5" cellspacing="0">
  <caption></caption>
  <tr bgcolor="#CCCCCC" valign="top">
    <th><a name="1014949"> </a><div class="CellHeading">Sound Manager Functions</div></th>
    <th><a name="1014951"> </a><div class="CellHeading"><br></div></th>
  </tr>
  <tr valign="top">
    <td colspan="1" rowspan="3"><a name="1014956"> </a><div class="CellBody"><a href="SoundManager.html#1392445">SndCreateMidiList</a><br><a href="SoundManager.html#1392536">SndGetDefaultVolume</a><br><a href="SoundManager.html#1392575">SndPlaySmf</a><br><a href="SoundManager.html#1392645">SndPlaySmfResource</a><br><a href="SoundManager.html#1392697">SndPlaySystemSound</a></div></td>
    <td colspan="1" rowspan="3"><a name="1014973"> </a><div class="CellBody"><a href="SoundManager.html#1392466">SndDoCmd</a><br><a href="SoundManager.html#1392556">SndInterruptSmfIrregardless</a><br><a href="SoundManager.html#1392628">SndPlaySmfIrregardless</a><br><a href="SoundManager.html#1392677">SndPlaySmfResourceIrregardless</a></div></td>
  </tr>
  <tr valign="top">
  </tr>
  <tr valign="top">
  </tr>
</table>




</h5>
<h5 class="TgTable">
  <a name="1015146"> </a>

<table border="1" cellpadding="5" cellspacing="0">
  <caption></caption>
  <tr bgcolor="#CCCCCC" valign="top">
    <th><a name="1014995"> </a><div class="CellHeading">System Manager Functions</div></th>
    <th><a name="1014997"> </a><div class="CellHeading"><br></div></th>
  </tr>
  <tr valign="top">
    <td><a name="1014999"> </a><div class="CellHeading">System Dialogs</div></td>
    <td><a name="1015001"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015006"> </a><div class="CellBody"><a href="SystemDialogs.html#1060133">SysGraffitiReferenceDialog</a><br><a href="SystemManager.html#1166141">SysKeyboardDialogV10</a></div></td>
    <td><a name="1015014"> </a><div class="CellBody"><a href="SystemManager.html#1166115">SysKeyboardDialog</a></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015016"> </a><div class="CellHeading">Power Management</div></td>
    <td><a name="1015018"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015023"> </a><div class="CellBody"><a href="SystemManager.html#1165585">SysBatteryInfo</a><br><a href="SystemManager.html#1166328">SysSetAutoOffTime</a></div></td>
    <td><a name="1015031"> </a><div class="CellBody"><a href="SystemManager.html#1165625">SysBatteryInfoV20</a><br><a href="SystemManager.html#1166386">SysTaskDelay</a></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015036"> </a><div class="CellHeading">System Management</div></td>
    <td><a name="1015038"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015043"> </a><div class="CellBody"><a href="SystemManager.html#1166164">SysLibFind</a><br><a href="SystemManager.html#1166295">SysRandom</a><br><a href="SystemManager.html#1166000">SysGremlins</a></div></td>
    <td><a name="1015054"> </a><div class="CellBody"><a href="SystemManager.html#1166207">SysLibLoad</a><br><a href="SystemManager.html#1166310">SysReset</a></div></td>
  </tr>
  <tr valign="top">
    <td colspan="2" rowspan="1"><a name="1015059"> </a><div class="CellHeading">Working With Strings and Resources</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015066"> </a><div class="CellBody"><a href="SystemManager.html#1165664">SysBinarySearch</a><br><a href="SystemManager.html#1166255">SysQSort</a><br><a href="SystemManager.html#1165808">SysCreatePanelList</a><br><a href="SystemManager.html#1165885">SysFormPointerArrayToStrings</a></div></td>
    <td><a name="1015080"> </a><div class="CellBody"><a href="SystemManager.html#1166051">SysInsertionSort</a><br><a href="SystemManager.html#1165737">SysCopyStringResource</a><br><a href="SystemManager.html#1166364">SysStringByIndex</a></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015088"> </a><div class="CellHeading">Database Support</div></td>
    <td><a name="1015090"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015095"> </a><div class="CellBody"><a href="SystemManager.html#1165752">SysCreateDataBaseList</a></div></td>
    <td><a name="1015100"> </a><div class="CellBody"><a href="SystemManager.html#1165839">SysCurAppDatabase</a></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015102"> </a><div class="CellHeading">Error Handling</div></td>
    <td><a name="1015104"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015109"> </a><div class="CellBody"><a href="SystemManager.html#1165862">SysErrString</a></div></td>
    <td><a name="1015114"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015116"> </a><div class="CellHeading">Event Handling</div></td>
    <td><a name="1015118"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015123"> </a><div class="CellBody"><a href="SystemManager.html#1166025">SysHandleEvent</a></div></td>
    <td><a name="1015125"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015127"> </a><div class="CellHeading">System Information</div></td>
    <td><a name="1015129"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015134"> </a><div class="CellBody"><a href="SystemManager.html#1165901">SysGetOSVersionString</a><br><a href="SystemManager.html#1165924">SysGetROMToken</a></div></td>
    <td><a name="1015142"> </a><div class="CellBody"><a href="SystemManager.html#1165956">SysGetStackInfo</a><br><a href="SystemManager.html#1166408">SysTicksPerSecond</a></div></td>
  </tr>
</table>




</h5>
<h5 class="TgTable">
  <a name="1015259"> </a>

<table border="1" cellpadding="5" cellspacing="0">
  <caption></caption>
  <tr bgcolor="#CCCCCC" valign="top">
    <th><a name="1015150"> </a><div class="CellHeading">Time Manager Functions</div></th>
    <th><a name="1015152"> </a><div class="CellHeading"><br></div></th>
  </tr>
  <tr valign="top">
    <td colspan="2" rowspan="1"><a name="1015154"> </a><div class="CellHeading">Allowing User to Change Date and Time</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015161"> </a><div class="CellBody"><a href="DateAndTimeSelector.html#995438">DayDrawDays</a><br><a href="DateAndTimeSelector.html#995458">DayDrawDaySelector</a><br><a href="DateAndTimeSelector.html#995478">DayHandleEvent</a></div></td>
    <td><a name="1015172"> </a><div class="CellBody"><a href="DateAndTimeSelector.html#995510">SelectDay</a><br><a href="DateAndTimeSelector.html#995622">SelectTimeV33</a><br><a href="DateAndTimeSelector.html#995542">SelectDayV10</a></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015180"> </a><div class="CellHeading">Changing the Date</div></td>
    <td><a name="1015182"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015187"> </a><div class="CellBody"><a href="DateAndTimeManager.html#1174127">DateAdjust</a><br><a href="DateAndTimeManager.html#1174761">TimSetSeconds</a></div></td>
    <td><a name="1015195"> </a><div class="CellBody"><a href="DateAndTimeManager.html#1174650">TimAdjust</a></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015197"> </a><div class="CellHeading">Converting to Date Format</div></td>
    <td><a name="1015199"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015204"> </a><div class="CellBody"><a href="DateAndTimeManager.html#1174151">DateDaysToDate</a><br><a href="DateAndTimeManager.html#1174736">TimSecondsToDateTime</a></div></td>
    <td><a name="1015212"> </a><div class="CellBody"><a href="DateAndTimeManager.html#1174179">DateSecondsToDate</a></div></td>
  </tr>
  <tr valign="top">
    <td colspan="2" rowspan="1"><a name="1015214"> </a><div class="CellHeading">Converting Dates to Other Formats</div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015221"> </a><div class="CellBody"><a href="DateAndTimeManager.html#1174444">DateToAscii</a><br><a href="DateAndTimeManager.html#1174491">DateToDays</a><br><a href="DateAndTimeManager.html#1174695">TimGetSeconds</a><br><a href="DateAndTimeManager.html#1174713">TimGetTicks</a></div></td>
    <td><a name="1015235"> </a><div class="CellBody"><a href="DateAndTimeManager.html#1174788">TimeToAscii</a><br><a href="DateAndTimeManager.html#1174515">DateToDOWDMFormat</a><br><a href="DateAndTimeManager.html#1174674">TimDateTimeToSeconds</a><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015243"> </a><div class="CellHeading">Date Information</div></td>
    <td><a name="1015245"> </a><div class="CellBody"><br></div></td>
  </tr>
  <tr valign="top">
    <td><a name="1015250"> </a><div class="CellBody"><a href="DateAndTimeManager.html#1174567">DayOfMonth</a><br><a href="DateAndTimeManager.html#1174636">DaysInMonth</a></div></td>
    <td><a name="1015258"> </a><div class="CellBody"><a href="DateAndTimeManager.html#1174587">DayOfWeek</a></div></td>
  </tr>
</table>




</h5>
<h5 class="TgTable">
  <a name="1015319"> </a>

<table border="1" cellpadding="5" cellspacing="0">
  <caption></caption>
  <tr bgcolor="#CCCCCC" valign="top">
    <th><a name="1015262"> </a><div class="CellHeading">Float Manager Functions</div></th>
    <th><a name="1015264"> </a><div class="CellHeading"><br></div></th>
  </tr>
  <tr valign="top">
    <td colspan="1" rowspan="6"><a name="1015269"> </a><div class="CellBody"><a href="FloatManager.html#1116703">FlpAToF</a><br><a href="FloatManager.html#1116878">FlpBufferCorrectedAdd</a><br><a href="FloatManager.html#1116934">FlpCorrectedAdd</a><br><a href="FloatManager.html#1116993">FlpFToA</a><br><a href="FloatManager.html#1117119">FlpSetNegative</a></div></td>
    <td colspan="1" rowspan="6"><a name="1015286"> </a><div class="CellBody"><a href="FloatManager.html#1116852">FlpBufferAToF</a><br><a href="FloatManager.html#1116906">FlpBufferCorrectedSub</a><br><a href="FloatManager.html#1116966">FlpCorrectedSub</a><br><a href="FloatManager.html#1117091">FlpNegate</a><br><a href="FloatManager.html#1117147">FlpSetPositive</a></div></td>
  </tr>
  <tr valign="top">
  </tr>
  <tr valign="top">
  </tr>
  <tr valign="top">
  </tr>
  <tr valign="top">
  </tr>
  <tr valign="top">
  </tr>
</table>




</h5>
&nbsp;<br>
				<!-- CONTENT_END -->

		</td>
		<td width="5">&nbsp;&nbsp;</td>
	</tr>
      </table>
    </td>
			</tr>
  <tr>
				<td>
					<table border="0" cellpadding="0" cellspacing="0" width="760">
        <!-- CONTENTCELL_END -->
        <tr valign="top"> 
          <td width="10">&nbsp;<!-- FOOTER_START --></td>
          <td width="72">&nbsp;</td>
          <td width="25" bgcolor="white" background="images/bkgrnd.gif">&nbsp;</td>
          <td width="600"> 
            <table border="0" cellpadding="0" cellspacing="0" width="600">
              <tr> 
                <td><img src="images/rule_10-1-5_ltblue.gif" width="600" height="16" border="0"></td>
              </tr>
              <tr> 
                <td> 
                  <p align="center" class="footer"> ©2002 PalmSource, Inc. and its affiliates.  All rights reserved. 
<a href="http://www.palmos.com/dev/training/">Training</a>&nbsp;|&nbsp;<a href="http://www.palmos.com/dev/support/kb/">Knowledge Base</a>&nbsp;|&nbsp;<a href="http://www.palmos.com/">Palm&nbsp;OS&nbsp;Platform</a>&nbsp;|&nbsp;<a href="Companion_Front.html" target="_blank">Legal Notices</a>&nbsp;<br>
												<!-- FOOTER_END --><br>
											</p>
                </td>
              </tr>
            </table>
          </td>
        </tr>
      </table>
				</td>
			</tr>
</table>
</BODY>
</HTML>