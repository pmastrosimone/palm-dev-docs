<html>
<head>
<title>(68K) Exchange Libraries | Palm OS&#174; Programmer's Companion</title> 
<link href="psi_devpubs.css" rel="stylesheet" type="text/css">

<!-- BEGIN META DATA -->
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<META NAME="PSITEMPLATE" CONTENT="1006-007 PalmSource_HTML_2003 20041101">
<META NAME="GENERATOR" CONTENT="Quadralay WebWorks AutoMap 2003 for FrameMaker 8.0.6.2138">
<META NAME="LASTUPDATED" CONTENT="11/22/04 10:43:43">
<!-- END META DATA -->
</head>

<body bgcolor="#ffffff" text="#000000" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">
<a name="1001417"></a>

<!-- BEGIN TOPNAV -->
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
<td><img src="images/shim.gif" width="7" height="75" border="0" alt=""></td>
<td align="left"><table border="0" cellpadding="0" cellspacing="0" width="744">
<tr>
<td><img name="index_r2_c1" src="images/shim.gif" width="25" height="75" border="0" alt=""></td>
<td valign="top"><table border="0" cellpadding="0" cellspacing="0" width="96">
<tr>
<td><img name="index_r2_c4" src="images/shim.gif" width="96" height="15" border="0" alt=""></td>
</tr>
<tr>
<td><a href="http://www.palmsource.com/"><img name="ps_logo" src="images/ps_logo.gif" width="96" height="54" border="0" alt=""></a></td>
</tr>

</table>
</td>

<td><table border="0" cellpadding="0" cellspacing="0" width="30">
<td><img name="index_x" src="images/shim.gif" width="30" height="75" border="0" alt=""></td>
</table></td>

<!--BEGIN MASTHEAD-->
<td><table border="0" cellpadding="0" cellspacing="0" width="96">
<tr>
<td><img name="index_x" src="images/shim.gif" width="615" height="5" border="0" alt=""></td>
</tr>
<tr>
<td>
<!--BEGIN BOOK NAVIGATION-->
<span class="nav">
<A href="http://www.palmos.com/dev/support/docs/">Documentation</a>&nbsp;&nbsp;|&nbsp;&nbsp;
<a href="Companion2TOC.html">Table of Contents</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="ExchangeManagerConcept.html">&lt;&nbsp;Previous</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="PersonalDataInterchange.html">Next&nbsp;&gt;</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="Companion2IX.html">Index</a>
</span>
<!--END BOOK NAVIGATION-->
</tr>
<tr>
<td>
<!--BEGIN PAGE TITLE-->
<h2 class="PageTitle">2 &nbsp;&nbsp;
Exchange Libraries</h2></td>
<!--END PAGE TITLE-->
</tr>
<tr>
<td>
<!--BEGIN BOOK TITLE-->
<p class="BookTitle">Palm OS&#174; Programmer's Companion</p>
<p class="SubTitle">Volume II Communications </p>
<!--END BOOK TITLE-->
</td>
</tr>
<tr>
<td><img name="index_x" src="images/shim.gif" width="615" height="5" border="0" alt=""></td>
</tr>
</table>
</td>
<!--END MASTHEAD-->
</tr>
</table>
<img name="dashes" src="images/dashes.gif" width="744" height="3" border="0" alt=""></td>
</tr>
</table>
<!-- END TOPNAV -->

<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
<td valign="top" width="5"><img name="index_x" src="images/shim.gif" width="5" height="33" border="0" alt=""></td>

<!--BEGIN SIDETOC-->
<td valign="top" width="175">
<div id="sidetoc" valign="bottom">
<h1 class="SideTOC1"><a href="ExchangeLibraries.html">2  Exchange Libraries</a></h1>

   <h2 class="SideTOC2"><a href="#1001449">
   About Exchange Libraries</a></h2>

      <h3 class="SideTOC3"><a href="#1001462">
      Exchange Libraries, Exchange Manager, and Applications</a></h3>

      <h3 class="SideTOC3"><a href="#1001522">
      Palm OS Exchange Libraries</a></h3>

   <h2 class="SideTOC2"><a href="#1001568">
   Exchange Library Components</a></h2>

      <h3 class="SideTOC3"><a href="#1001580">
      The Exchange Library API</a></h3>

      <h3 class="SideTOC3"><a href="#1001658">
      Dispatch Table</a></h3>

   <h2 class="SideTOC2"><a href="#1001816">
   Implementing an Exchange Library</a></h2>

      <h3 class="SideTOC3"><a href="#1001819">
      Required Functions</a></h3>

      <h3 class="SideTOC3"><a href="#1001901">
      Registering with the Exchange Manager</a></h3>

   <h2 class="SideTOC2"><a href="#1001915">
   Summary of Exchange Library</a></h2>

</div>
</td>

<td width="5">&nbsp;&nbsp;</td>
<td width="2" background="images/index_r8_c10.gif"><img src="images/shim.gif" width="2" height="75" border="0" alt=""></td>
<td width="5">&nbsp;&nbsp;</td>

<!--END SIDETOC-->

<td valign="top">

<!--BEGIN CONTENT-->
<div id="content" valign="bottom">
<p><a name="1001425"> </a>This chapter describes how to implement an exchange library. It covers the following topics:</p>
<ul type="disc">
  <li><a name="1001429"> </a><a href="ExchangeLibraries.html#1001449">About Exchange Libraries</a>
  <li><a name="1001433"> </a><a href="ExchangeLibraries.html#1001568">Exchange Library Components</a>
  <li><a name="1001437"> </a><a href="ExchangeLibraries.html#1001816">Implementing an Exchange Library</a>
</ul>

<p><a name="1001438"> </a>Prior to implementing an exchange library, you should have a clear understanding of how the Exchange Manager operates. See <a href="ExchangeManagerConcept.html#995795">Chapter 1, "Object Exchange,"</a> for an in-depth discussion on the Exchange Manager. Also see <a href="../PalmOSReference/ExgLibAPI.html#1069165">Chapter 63, "Exchange Library,"</a> of the <i>Palm OS Programmer's API Reference</i> for a detailed description of the functions that must be implemented in each exchange library.</p>

<h2 class="haH2">
  <a name="1001449"> </a>About Exchange Libraries <a href="#1001417"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="1001451"> </a>Exchange libraries are Palm OS<sup>&#174;</sup> shared libraries that act as "plug-ins" to the <a href="../PalmOSReference/ExchangeManager.html#1054717">Exchange Manager</a>. They deal with protocols and communication devices and allow Palm OS applications to import and export data objects without regard to the transport mechanism. For example, one exchange library always available to Palm Powered<sup>&#8482;</sup> handhelds implements the IrDA protocol, IrOBEX. This allows applications to beam objects by way of infrared from one Palm Powered handheld to another.</p>

<p><a name="1001455"> </a>The following can take advantage of the Exchange Library API:</p>
<ul type="disc">
  <li><a name="1001456"> </a>Removable storage cards
  <li><a name="1001457"> </a>Notification services
  <li><a name="1001458"> </a>Email attachments
  <li><a name="1001459"> </a>Web (HTTP/FTP/CTP/WAP) exchange
  <li><a name="1001460"> </a>HotSync<sup>&#174;</sup> simplified import and export
</ul>
<h3 class="hbH3">
  <a name="1001462"> </a>Exchange Libraries, Exchange Manager, and Applications <a href="#1001417"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001463"> </a>The Exchange Manager is a high-level tool for applications to use. An exchange library is a set of routines that handle the implementation specifics of a particular transport. Typically, exchange library functions are called from the Exchange Manager and are not directly accessed by applications. Applications wanting to send or receive data call the functions provided by the Exchange Manager API, many of which do little more than invoke the corresponding function in the appropriate exchange library.</p>

<p><a name="1001464"> </a>Exchange libraries also make calls back into the Exchange Manager. For example, an exchange library would call <a href="../PalmOSReference/ExchangeManager.html#1056358"><code>ExgNotifyReceive</code></a> to have the Exchange Manager deliver objects received by the exchange library.</p>

<p><a name="1001468"> </a>No one component involved with data exchange (Exchange Manager, exchange library, or application) is complete in itself. However, applications and exchange libraries should be written so the user experiences all interaction as a single seamless interface, even though what takes place is really a complex interaction between different pieces of code.</p>

<p><a name="1001472"> </a><a href="ExchangeLibraries.html#1001474">Figure 2.1</a> illustrates the relationship between applications, the Exchange Manager, and the exchange libraries within two devices that are in communication.</p>

<p class="FFigureCaption">
  <a name="1001474"> </a><b>Figure 2.1&nbsp;&nbsp;Object exchange using Exchange Manager<div align="left"><img src="images/ExchangeMgr2.gif" border="0" hspace="0" vspace="0">
</div></b>
</p>


<p><a name="1001479"> </a>The following table lists the division of responsibilities between Palm OS applications, the Exchange Manager, and the exchange libraries.</p>

<p class="caption"><a name="1001485"> </a><b>Table 2.1&nbsp;&nbsp;Division of responsibility for data object exchange </b></p>
<div class="tablediv"><table cellspacing="0" class="tTable">

  <tr valign="top">
    <th><p class="tt"><a name="1001491"> </a><b>Palm OS Application</b></p>
    </th>
    <th><p class="tt"><a name="1001493"> </a><b>Exchange Manager</b></p>
    </th>
    <th><p class="tt"><a name="1001495"> </a><b>Exchange Library</b></p>
    </th>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001497"> </a>Creates, edits, and stores data</p>
    </td>
    <td><p class="tt"><a name="1001499"> </a>Maintains registry of exchange libraries</p>
    </td>
    <td><p class="tt"><a name="1001501"> </a>Sends data to or receives data from other devices</p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001503"> </a>Converts data to and from the interchange formats</p>
    </td>
    <td><p class="tt"><a name="1001505"> </a>Maintains registry of applications that can receive data</p>
<p class="tt"><a name="1001506"> </a></p>
    </td>
    <td><p class="tt"><a name="1001508"> </a>Displays a dialog to get addressing information from user</p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001510"> </a>Views or describes data</p>
    </td>
    <td><p class="tt"><a name="1001512"> </a>Passes send and receive requests to appropriate exchange library</p>
    </td>
    <td><p class="tt"><a name="1001514"> </a>Displays status and error dialogs, possibly using the Progress Manager</p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001516"> </a></p>
    </td>
    <td><p class="tt"><a name="1001518"> </a>Displays a dialog asking if user wants to receive data</p>
    </td>
    <td><p class="tt"><a name="1001520"> </a></p>
    </td>
  </tr>
</table>

</div>

<h3 class="hbH3">
  <a name="1001522"> </a>Palm OS Exchange Libraries <a href="#1001417"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001523"> </a>The Exchange Manager was introduced in Palm OS 3.0 and was significantly enhanced in Palm OS 4.0. Because of this, the various exchange libraries require different versions of the OS. <a href="ExchangeLibraries.html#1001534">Table 2.2</a> lists the minimum OS version required by various exchange libraries.</p>

<p class="caption"><a name="1001534"> </a><b>Table 2.2&nbsp;&nbsp;Version of Palm OS required by exchange libraries </b></p>
<div class="tablediv"><table cellspacing="0" class="tTable">

  <tr valign="top">
    <th><p class="tt"><a name="1001538"> </a><b>Exchange Library </b></p>
    </th>
    <th><p class="tt"><a name="1001540"> </a><b>Minimum Palm OS Version </b></p>
    </th>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001543"> </a>IR Library (IrDA) </p>
    </td>
    <td><p class="tt"><a name="1001545"> </a>Palm OS 3.0</p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001548"> </a>Local Exchange Library </p>
    </td>
    <td><p class="tt"><a name="1001550"> </a>Palm OS 4.0</p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001553"> </a>SMS Library (Short Messaging System)</p>
    </td>
    <td><p class="tt"><a name="1001555"> </a>Palm OS 4.0</p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001561"> </a>Bluetooth Library<a href="#1001560"><sup>1</sup></a></p>
    </td>
    <td><p class="tt"><a name="1001563"> </a>Palm OS 4.0</p>
    </td>
  </tr>
</table>
<div class="tablediv"><table cellspacing="0" class="tTableNR">
   <tr>
     <td><div class="FNTFootnoteTable">
<a name="1001560"> </a><a href="#1001561">1</a>. Although not present in Palm OS 4.0, Palm plans to provide a Bluetooth Library soon after Palm OS 4.0 ships.</div>
</td>
   </tr>
</table></div>

</div>


<p><a name="1001566"> </a>Included with the Palm OS SDK version 4 is the HostTransfer sample exchange library which can be used as a starting point when creating your own exchange libraries.</p>

<h2 class="haH2">
  <a name="1001568"> </a>Exchange Library Components <a href="#1001417"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="1001569"> </a>This section describes the components that make up an exchange library. The topics covered are:</p>
<ul type="disc">
  <li><a name="1001573"> </a><a href="ExchangeLibraries.html#1001580">The Exchange Library API</a>
  <li><a name="1001577"> </a><a href="ExchangeLibraries.html#1001658">Dispatch Table</a>
</ul>
<h3 class="hbH3">
  <a name="1001580"> </a>The Exchange Library API <a href="#1001417"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001584"> </a>The Palm OS <a href="../PalmOSReference/ExgLibAPI.html#1069165">Exchange Library</a> API specifies the minimum set of functions that all exchange libraries must implement. These functions can be classified into three major categories: functions that must be included in all shared libraries, functions that establish a connection and send and receive data, and miscellaneous support functions.</p>

<h4 class="hcH4">
  <a name="1001585"> </a>Standard Shared Library Functions
</h4>

<p><a name="1001586"> </a>Any Palm OS shared library must implement open, close, sleep, and wake functions.</p>
<ul type="disc">
  <li><a name="1001590"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069454">ExgLibOpen</a>
  <li><a name="1001594"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069221">ExgLibClose</a>
  <li><a name="1001598"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069660">ExgLibSleep</a>
  <li><a name="1001602"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069679">ExgLibWake</a>
</ul>

<h4 class="hcH4">
  <a name="1001603"> </a>Functions That Send and Receive Data
</h4>

<p><a name="1001604"> </a>These functions do the work of establishing a connection and sending and receiving data.</p>


<ul type="disc">
  <li><a name="1001609"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069180">ExgLibAccept</a>
  <li><a name="1001613"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069237">ExgLibConnect</a>
  <li><a name="1001617"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069325">ExgLibDisconnect</a>
  <li><a name="1001621"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069386">ExgLibGet</a>
  <li><a name="1001625"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069470">ExgLibPut</a>
  <li><a name="1001629"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069533">ExgLibReceive</a>
  <li><a name="1001633"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069581">ExgLibRequest</a>
  <li><a name="1001637"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069614">ExgLibSend</a>
</ul>

<p><a name="1001638"> </a>Note that each of these corresponds directly to an Exchange Manager function; in most cases the Exchange Manager simply calls the corresponding exchange library function.</p>

<h4 class="hcH4">
  <a name="1001639"> </a>Support Functions
</h4>

<p><a name="1001640"> </a>This category consists of functions that provide information about your exchange library and that handle events.</p>
<ul type="disc">
  <li><a name="1001644"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069286">ExgLibControl</a>
  <li><a name="1001648"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069430">ExgLibHandleEvent</a>
</ul>

<p><a name="1001649"> </a>Although each of the functions in these three categories must be present in every exchange library, depending on the specific requirements of the exchange library some of them can simply return <code>errNone</code> or <code>exgErrNotSupported</code>.</p>

<p><a name="1001651"> </a>As with any shared library, the order in which the functions appear in the exchange library's dispatch table identifies the functions in the library. This order is specified in <code>ExgLib.h</code>. Because it's the function's position in the dispatch table and not its name that is important, the actual function names used in a given exchange library may be different from those specified in <code>ExgLib.h</code>. In fact, you'll likely want to use function names that are unique to your shared library, as the Host Transfer library does with such functions as <code>HostTransferLibPut</code>, <code>HostTransferLibSend</code>, and <code>HostTransferLibDisconnect</code>. By using function names specific to your exchange library, you can link your functions into the Mac Simulator and debug with it. If you use the function names defined in <code>ExgLib.h</code> for your functions, you'll get a link error because the Simulator uses those names for stub functions which call your functions.</p>

<p><a name="1001655"> </a>Beyond the functions listed above, additional library-specific functions must appear in the exchange library's dispatch table after <code>exgLibTrapLast</code>.</p>
<h3 class="hbH3">
  <a name="1001658"> </a>Dispatch Table <a href="#1001417"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001659"> </a>The dispatch table is a map used by the Palm OS to find the functions in the exchange library. At link time, references to the exchange library functions are resolved to a system trap by way of the <code>SYS_TRAP</code> macro. At runtime, when an exchange library function is called, a trap occurs and the trap finds the function in its library dispatch table and computes the function's offset into the code resource of the exchange library. A JMP instruction to the function's address is made, causing the function to be executed.</p>

<div><hr>
  <a name="1001662"> </a> <b>NOTE: </b> The structure of the dispatch table for exchange libraries is the same as that of shared libraries. Exchange libraries must do everything shared libraries must do, plus they must register with the Exchange Manager. This gives applications access to their services by way of the Exchange Manager APIs such as <a href="../PalmOSReference/ExchangeManager.html#1056469"><code>ExgPut</code></a>.
<hr>
</div>

<p><a name="1001666"> </a>A sample dispatch table source file, <code>HostTransferDispatch.c</code>, is provided with the OS SDK. <a href="ExchangeLibraries.html#1001671">Listing 2.1</a> provides a sample of the dispatch table contained within this file (some parts are omitted for clarity).</p>
<p class="CCodeCaption">
  <a name="1001671"> </a><b>Listing 2.1&nbsp;&nbsp;HostTransferDispatch.c</b>
</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
...<a name="1001672"> </a>
void *PrvHostTransferDispatchTable(void);<a name="1001673"> </a>
...<a name="1001674"> </a>
extern Err PrvInstallHostTransferDispatcher(UInt16 refNum, SysLibTblEntryType 
*entryP);<a name="1001675"> </a>
...<a name="1001676"> </a>
Err __Startup__(UInt16 refNum, SysLibTblEntryType *entryP)<a name="1001677"> </a>
{<a name="1001678"> </a>
   return PrvInstallHostTransferDispatcher(refNum, entryP);<a name="1001679"> </a>
}<a name="1001680"> </a>
...<a name="1001681"> </a>
asm void *PrvHostTransferDispatchTable(void)<a name="1001682"> </a>
{<a name="1001683"> </a>
   LEA  @Table, A0            // table ptr<a name="1001684"> </a>
   RTS                                 // exit with it<a name="1001685"> </a>
 <a name="1001686"> </a>
@Table:<a name="1001687"> </a>
   DC.W  @Name<a name="1001688"> </a>
   DC.W  (kOffset)       // Open<a name="1001689"> </a>
   DC.W  (kOffset+(1*4))   // Close<a name="1001690"> </a>
   DC.W  (kOffset+(2*4))   // Sleep<a name="1001691"> </a>
   DC.W  (kOffset+(3*4))   // Wake<a name="1001692"> </a>
   // Start of the exchange libary<a name="1001693"> </a>
   DC.W  (kOffset+(4*4)) // HostTransferLibHandleEvent<a name="1001694"> </a>
...<a name="1001695"> </a>
   DC.W  (kOffset+(12*4))  // HostTransferLibControl<a name="1001696"> </a>
   DC.W  (kOffset+(13*4))  // HostTransferLibRequest<a name="1001697"> </a>
 <a name="1001698"> </a>
@GotoOpen:<a name="1001699"> </a>
   JMP   HostTransferLibOpen<a name="1001700"> </a>
@GotoClose:<a name="1001701"> </a>
   JMP   HostTransferLibClose<a name="1001702"> </a>
@GotoSleep:<a name="1001703"> </a>
   JMP   HostTransferLibSleep<a name="1001704"> </a>
@GotoWake:<a name="1001705"> </a>
   JMP   HostTransferLibWake<a name="1001706"> </a>
 <a name="1001707"> </a>
@GotoHandleEvent:<a name="1001708"> </a>
   JMP   HostTransferLibHandleEvent<a name="1001709"> </a>
...<a name="1001710"> </a>
@GotoOption:<a name="1001711"> </a>
   JMP   HostTransferLibControl<a name="1001712"> </a>
@GotoCheck:<a name="1001713"> </a>
   JMP   HostTransferLibRequest<a name="1001714"> </a>
 <a name="1001715"> </a>
@Name:<a name="1001716"> </a>
   DC.B  HostTransferName<a name="1001717"> </a>
}<a name="1001718"> </a>
...<a name="1001719"> </a>
 <a name="1001720"> </a>
</pre><div class="CodeRule"><hr></div>


<p><a name="1001721"> </a>The last entry in the dispatch table is the name of the exchange library. This must match the name of the database containing the exchange library, and on the simulator, it must end with "-<i>crid</i>", where <i>crid</i> is the creator ID. For example, the Host Transfer library uses <code>"HostTransfer Library-HXfr"</code>.</p>

<p><a name="1001722"> </a>The code segment must be locked so that the dispatch table itself, and the routine addresses in it, will remain valid. The library's database is automatically protected so that it cannot be deleted.</p>

<div><hr>
  <a name="1001724"> </a> <b>NOTE: </b> The system's shared library table has a slot for library globals for each loaded library. The start-up routine should at least zero this field, if not actually allocate the globals. Some libraries allocate a small structure with an <code>openCount</code> and leave the larger allocation for later, when the library is opened by way of the library's <code>Open()</code> entry point. In this case, the small structure has a reference to the larger one.
<hr>
</div>

<p><a name="1001727"> </a>The code resource of an exchange library must start with a routine that sets up the dispatch table. This routine must be named <code>__Startup__</code>. The prototype for this function is:</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
Err __Startup__(UInt16 refNum,
	SysLibTblEntryType *entryP)<a name="1001729"> </a>
</pre><div class="CodeRule"><hr></div>


<p><a name="1001730"> </a>Usually, <code>__Startup__</code> consists of a one line call in a <code>MyLibDispatch.c</code> file that calls the actual setup routine in a corresponding <code>MyLib.c</code> file. For example, in the <code>HostTransferDispatch.c</code> sample file provided with the OS SDK the following is used to install the HostTransfer dispatch table:</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
extern Err PrvInstallHostTransferDispatcher(UInt16 refNum,
SysLibTblEntryType *entryP);<a name="1001731"> </a>
...<a name="1001732"> </a>
Err __Startup__(UInt16 refNum, SysLibTblEntryType *entryP)<a name="1001733"> </a>
{<a name="1001734"> </a>
	return PrvInstallHostTransferDispatcher(refNum, entryP);<a name="1001735"> </a>
}<a name="1001736"> </a>
...<a name="1001737"> </a>
</pre><div class="CodeRule"><hr></div>


<p><a name="1001738"> </a><code>__Startup__</code> is called to set up the dispatch table when a call to <a href="../PalmOSReference/SystemManager.html#1076694"><code>SysLibInstall</code></a> or <a href="../PalmOSReference/SystemManager.html#1076720"><code>SysLibLoad</code></a> is made. For example:</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
SysLibInstall(PrvInstallHostTransferDispatcher, &amp;refNum);<a name="1001745"> </a>
</pre><div class="CodeRule"><hr></div>


<p><a name="1001749"> </a><a href="ExchangeLibraries.html#1001755">Listing 2.2</a> shows how the HostTransfer dispatch table installer function is implemented. This function can be found in the OS SDK sample file <code>HostTransferLib.c</code>. The dispatch table installer function is responsible for making the system's library table entry (<code>entryP</code>) point to the dispatch table. For example:</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
entryP-&gt;dispatchTblP =
  (MemPtr *)PrvHostTransferDispatchTable();<a name="1001750"> </a>
</pre><div class="CodeRule"><hr></div>


<p><a name="1001751"> </a>The dispatch installer routine generally does a bit of initialization as well.</p>
<p class="CCodeCaption">
  <a name="1001755"> </a><b>Listing 2.2&nbsp;&nbsp;Host transfer dispatch table installer function</b>
</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
Err PrvInstallHostTransferDispatcher(UInt16 refNum, SysLibTblEntryType *entryP)<a name="1001756"> </a>
{<a name="1001757"> </a>
   Err err;<a name="1001758"> </a>
   HostTransferGlobalsType *gP;<a name="1001759"> </a>
   UInt32 value;<a name="1001760"> </a>
   Char macro[14];<a name="1001761"> </a>
   <a name="1001762"> </a>
   // Must be 4.0 or greator<a name="1001763"> </a>
   err = FtrGet(sysFtrCreator, sysFtrNumROMVersion, &amp;value);<a name="1001764"> </a>
   if (err || value &lt; kVersion4_0) return -1;<a name="1001765"> </a>
   <a name="1001766"> </a>
   // Allocate library globals and store pointer to them in the system's <a name="1001767"> </a>
   // library table<a name="1001768"> </a>
   gP = MemPtrNew(sizeof(HostTransferGlobalsType));<a name="1001769"> </a>
   ErrFatalDisplayIf(!gP, "No memory for globals");<a name="1001770"> </a>
   if (gP)<a name="1001771"> </a>
      {<a name="1001772"> </a>
      MemPtrSetOwner(gP, 0);<a name="1001773"> </a>
      MemSet(gP, sizeof(HostTransferGlobalsType), 0);<a name="1001774"> </a>
      gP-&gt;refNum = refNum;   // make self reference<a name="1001775"> </a>
      entryP-&gt;globalsP = gP;<a name="1001776"> </a>
      }<a name="1001777"> </a>
 <a name="1001778"> </a>
   // Install pointer to our dispatch table in system's library table<a name="1001779"> </a>
   entryP-&gt;dispatchTblP = (MemPtr *)PrvHostTransferDispatchTable();<a name="1001780"> </a>
   <a name="1001781"> </a>
   // Check if we're running on the simulator or emulator. On a real device,<a name="1001782"> </a>
   // there's no host so we don't register this library with the Exchange<a name="1001783"> </a>
   // Manager. In this case, we should really abort the library installation<a name="1001784"> </a>
   // altogether, but this demonstrates how exchange libs can change their<a name="1001785"> </a>
   // registration status.<a name="1001786"> </a>
#if EMULATION_LEVEL == EMULATION_NONE<a name="1001787"> </a>
   if (FtrGet('pose', 0, &amp;value) != ftrErrNoSuchFeature)<a name="1001788"> </a>
#endif<a name="1001789"> </a>
      {<a name="1001790"> </a>
      Char description[exgTitleBufferSize + 1];<a name="1001791"> </a>
      UInt16 descriptionSize = sizeof(description);<a name="1001792"> </a>
      Err err;<a name="1001793"> </a>
      <a name="1001794"> </a>
      // Get the title of the library<a name="1001795"> </a>
      err = HostTransferLibControl(refNum, exgLibCtlGetTitle, &amp;description,
         &amp;descriptionSize);<a name="1001796"> </a>
      if (! err)<a name="1001797"> </a>
         {<a name="1001798"> </a>
         // Register this library with the Exchange Manager<a name="1001799"> </a>
         err = ExgRegisterDatatype(HostTransferCreator, exgRegSchemeID,<a name="1001800"> </a>
           kHostTransferScheme "\t" exgSendScheme, description, 0 /*flags*/);<a name="1001801"> </a>
         }<a name="1001802"> </a>
      }<a name="1001803"> </a>
   <a name="1001804"> </a>
   // Add a magic macro to initiate ExgRequest<a name="1001805"> </a>
   StrCopy(macro, "\x01" "0117" "0000" "0408");<a name="1001806"> </a>
   // virtualkeycode,vchrIrReceive,refnum,libEvtHookKeyMask<a name="1001807"> </a>
   macro[7] = PrvHexToAscii((refNum&gt;&gt;4) &amp; 0x0f); // put refnum into string as 
hex<a name="1001808"> </a>
   macro[8] = PrvHexToAscii(refNum &amp; 0x0f);<a name="1001809"> </a>
   PrvDeleteExistingMacro(".r");<a name="1001810"> </a>
   GrfAddMacro(".r", (UInt8 *)macro, 13);<a name="1001811"> </a>
   <a name="1001812"> </a>
   return err;<a name="1001813"> </a>
}<a name="1001814"> </a>
</pre><div class="CodeRule"><hr></div>


<h2 class="haH2">
  <a name="1001816"> </a>Implementing an Exchange Library <a href="#1001417"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="1001817"> </a>In order to work with the Palm OS Exchange Manager, an exchange library must implement a required set of functions and must register with the Exchange Manager.</p>
<h3 class="hbH3">
  <a name="1001819"> </a>Required Functions <a href="#1001417"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001820"> </a>Exchange libraries contain functions to handle implementation specifics of a particular transport plus the functions required by the <a href="../PalmOSReference/ExgLibAPI.html#1069165">Exchange Library</a> API. Functions required to handle transport-specific tasks or other tasks that aren't specific to the Exchange Library API are outside the scope of this document. In general, however, other functions required by the exchange library could include tasks such as polling devices, handling interrupts, or checking for user input.</p>

<p><a name="1001824"> </a>Depending on the application, the exchange library's requirements may be send only, receive only, or both. At a minimum, when sending objects, <a href="../PalmOSReference/ExgLibAPI.html#1069470"><code>ExgLibPut</code></a>, <a href="../PalmOSReference/ExgLibAPI.html#1069614"><code>ExgLibSend</code></a>, and <a href="../PalmOSReference/ExgLibAPI.html#1069325"><code>ExgLibDisconnect</code></a> are typically required; for receiving objects, <a href="../PalmOSReference/ExgLibAPI.html#1069180"><code>ExgLibAccept</code></a>, <a href="../PalmOSReference/ExgLibAPI.html#1069533"><code>ExgLibReceive</code></a>, and <a href="../PalmOSReference/ExgLibAPI.html#1069325"><code>ExgLibDisconnect</code></a> are needed. See <a href="../PalmOSReference/ExgLibAPI.html#1069165">Chapter 63, "Exchange Library,"</a> of the <i>Palm OS Programmer's API Reference</i> for a detailed description of each exchange library function.</p>

<h4 class="hcH4">
  <a name="1001854"> </a>Implementing ExgLibAccept
</h4>

<p><a name="1001855"> </a>There are two situations in which an application calls the Exchange Manager's <a href="../PalmOSReference/ExchangeManager.html#1055291"><code>ExgAccept</code></a> function:</p>
<ul type="disc">
  <li><a name="1001859"> </a>The application wants to initiate a connection to receive data, which it does in response to <code>sysAppLaunchCmdExgReceiveData</code>.
  <li><a name="1001860"> </a>The application wants to initiate a connection to receive a preview of the data, which it does in response to <code>sysAppLaunchCmdExgAskUser</code>.
</ul>

<p><a name="1001864"> </a>The Exchange Manager in turn calls <a href="../PalmOSReference/ExgLibAPI.html#1069180"><code>ExgLibAccept</code></a>. </p>

<p><a name="1001866"> </a>When previewing data, you must buffer incoming data. Your <code>ExgLibAccept</code> function should observe the preview flag and rewind the buffer, preparing for non-destructive read. When it is called again without the preview flag, it should rewind again, this time preparing for destructive read. </p>

<p><a name="1001867"> </a><code>ExgLibAccept</code> must update any progress dialogs to indicate that data is being accepted, or received, into an application.</p>

<h4 class="hcH4">
  <a name="1001869"> </a>Handling Connection Errors
</h4>

<p><a name="1001874"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069237"><code>ExgLibConnect</code></a> can be used by exchange libraries as a convenient place to put code that needs to be executed prior to the first <a href="../PalmOSReference/ExgLibAPI.html#1069470"><code>ExgLibPut</code></a> call. Many exchange libraries don't support <code>ExgLibConnect</code>, however, instead establishing a connection in the initial call to <code>ExgLibPut</code>. If your library doesn't need to support <code>ExgLibConnect</code>, your implementation of this function should simply return <code>errNone</code>.</p>

<p><a name="1001878"> </a>If your exchange library doesn't support <code>ExgLibConnect</code> and an error occurs during the initial call to <code>ExgLibPut</code>, your implementation of <code>ExgLibPut</code> should clean up after itself; it should not count on <a href="../PalmOSReference/ExgLibAPI.html#1069325"><code>ExgLibDisconnect</code></a> being called. If the initial call to <code>ExgLibPut</code> succeeds, however, cleanup of subsequent errors can be done in <code>ExgLibDisconnect</code>.</p>

<p><a name="1001882"> </a>If your exchange library does support <code>ExgLibConnect</code> and an error occurs during a call to it, <code>ExgLibConnect</code> should clean up after itself. Cleanup of errors that occur after a successful call to <code>ExgLibConnect</code>, however, can be delegated to <code>ExgLibDisconnect</code>.</p>

<p><a name="1001883"> </a>Finally, if your exchange library supports <code>ExgLibConnect</code> but the application doesn't call it prior to calling <code>ExgLibPut</code>, the situation is as if your library didn't implement <code>ExgLibConnect</code>: if an error occurs during the initial call to <code>ExgLibPut</code> your implementation of <code>ExgLibPut</code> should clean up after itself, while if the initial call to <code>ExgLibPut</code> succeeds you can clean up after any subsequent errors in <code>ExgLibDisconnect</code>.</p>

<p><a name="1001884"> </a>Note that you must support <code>ExgLibConnect</code> if your exchange library supports two-way communication as discussed in <a href="ExchangeManagerConcept.html#996910">"Two-Way Communications."</a></p>

<h4 class="hcH4">
  <a name="1001889"> </a>Buffering Data
</h4>

<p><a name="1001890"> </a>Data can be sent by the exchange library as it receives it by using <a href="../PalmOSReference/ExgLibAPI.html#1069614"><code>ExgLibSend</code></a> calls or by buffering the data and sending it in response to an <a href="../PalmOSReference/ExgLibAPI.html#1069325"><code>ExgLibDisconnect</code></a> call. Buffering has some advantages. For example, the communication stack does not have to share cycles with the sending or receiving application and the communication hardware is on for the shortest possible time, conserving battery power. One drawback is that buffering requires extra storage that could be problematic if the amount of data exchanged is large.</p>
<h3 class="hbH3">
  <a name="1001901"> </a>Registering with the Exchange Manager <a href="#1001417"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001902"> </a>Exchange libraries, like applications, must register with the Exchange Manager for the object types they are to receive. Exchange libraries typically register for two URL schemes, one that is used to uniquely identify the exchange library, and one for how it is used.</p>

<p><a name="1001905"> </a>For example, the IR library registers for "_irobex", which identifies the specific protocol, and for "_beam" which makes it accessible from the Beam command. The Host Transfer sample exchange library registers for "_host" and "_send". The latter registration makes it accessible from the Send command. Most exchange libraries will probably want to register for the "_send" scheme. These URL schemes all start with an underscore to avoid conflicting with standard URL schemes like "http" and "mailto". See <a href="ExchangeManagerConcept.html#996044">Table 1.3</a> in <a href="ExchangeManagerConcept.html#995795">Chapter 1, "Object Exchange,"</a> for the supported URL schemes.</p>

<h2 class="haH2">
  <a name="1001915"> </a>Summary of Exchange Library <a href="#1001417"><span class="nav">^TOP^</span></a>
</h2>



<div class="tablediv"><table cellspacing="0" class="tTable">

  <tr valign="top">
    <th colspan="2" rowspan="1"><p class="tt"><a name="1001918"> </a><b>Exchange Library Functions</b></p>
    </th>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001922"> </a><b>Handling the Connection</b></p>
    </td>
    <td><p class="tt"><a name="1001924"> </a><b></b></p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001929"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069237"><code>ExgLibConnect</code></a><br><a href="../PalmOSReference/ExgLibAPI.html#1069325"><code>ExgLibDisconnect</code></a></p>
    </td>
    <td><p class="tt"><a name="1001937"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069180"><code>ExgLibAccept</code></a><br><a href="../PalmOSReference/ExgLibAPI.html#1069470"><code>ExgLibPut</code></a></p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001942"> </a><b>Requesting Data</b></p>
    </td>
    <td><p class="tt"><a name="1001944"> </a><b></b></p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001949"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069386"><code>ExgLibGet</code></a></p>
    </td>
    <td><p class="tt"><a name="1001954"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069581"><code>ExgLibRequest</code></a></p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001956"> </a><b>Transferring Data </b></p>
    </td>
    <td><p class="tt"><a name="1001958"> </a><b></b></p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001963"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069533"><code>ExgLibReceive</code></a></p>
    </td>
    <td><p class="tt"><a name="1001968"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069614"><code>ExgLibSend</code></a></p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001970"> </a><b>Querying the Exchange Library</b></p>
    </td>
    <td><p class="tt"><a name="1001972"> </a><b></b></p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001977"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069286"><code>ExgLibControl</code></a></p>
    </td>
    <td><p class="tt"><a name="1001979"> </a></p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001981"> </a><b>Handling Events</b></p>
    </td>
    <td><p class="tt"><a name="1001983"> </a></p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001988"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069430"><code>ExgLibHandleEvent</code></a></p>
    </td>
    <td><p class="tt"><a name="1001990"> </a></p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001992"> </a><b>Required Shared Library Functions</b></p>
    </td>
    <td><p class="tt"><a name="1001994"> </a></p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001999"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069454"><code>ExgLibOpen</code></a><br><a href="../PalmOSReference/ExgLibAPI.html#1069221"><code>ExgLibClose</code></a></p>
    </td>
    <td><p class="tt"><a name="1002007"> </a><a href="../PalmOSReference/ExgLibAPI.html#1069660"><code>ExgLibSleep</code></a><br><a href="../PalmOSReference/ExgLibAPI.html#1069679"><code>ExgLibWake</code></a></p>
    </td>
  </tr>
</table>

</div>


<p><a name="1002012"> </a></p>
&nbsp;<br>
</div>
<!--END CONTENT-->

</td>
<td width="5">&nbsp;&nbsp;</td>
</tr>

</table>

<!-- BEGIN FOOTER -->
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
<td width="7" rowspan="2"><img name="index_x" src="images/shim.gif" width="7" height="33" border="0" alt=""></td>
<td align="left"><img name="dashes" src="images/dashes.gif" width="744" height="3" border="0" alt=""></td>
<td width="10" rowspan="2"><img name="index_x" src="images/shim.gif" width="10" height="33" border="0" alt=""></td>
</tr>
<tr>
<td align="center">
<p class="footer">
Copyright © 1996-2004, PalmSource, Inc. and its affiliates.  All rights reserved. <br>
<a href="http://www.palmsource.com/contact/">Write Us</a> | <a href="http://www.palmos.com/dev/training/">Training</a> | <a href="http://www.palmos.com/dev/support/kb/">Knowledge Base</a> | <a href="Companion2Front.html" target="_blank">Legal</a></p>
<br>
<!--BEGIN BOOK NAVIGATION-->
<p class="nav">
<A href="http://www.palmos.com/dev/support/docs/">Documentation</a>&nbsp;&nbsp;|&nbsp;&nbsp;
<a href="Companion2TOC.html">Table of Contents</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="ExchangeManagerConcept.html">&lt;&nbsp;Previous</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="PersonalDataInterchange.html">Next&nbsp;&gt;</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="Companion2IX.html">Index</a>
</p>
</td>
</tr>
</table>
<!-- END FOOTER -->

</body>
</html>