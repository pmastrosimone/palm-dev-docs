<html>
<head>
<title>(Protein) Expansion | System Management</title> 
<link href="psi_devpubs.css" rel="stylesheet" type="text/css">

<!-- BEGIN META DATA -->
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<META NAME="PSITEMPLATE" CONTENT="1006-007 PalmSource_HTML_2003 20041101">
<META NAME="GENERATOR" CONTENT="Quadralay WebWorks AutoMap 2003 for FrameMaker 8.0.6.2138">
<META NAME="LASTUPDATED" CONTENT="11/22/04 11:27:12">
<!-- END META DATA -->
</head>

<body bgcolor="#ffffff" text="#000000" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">
<a name="1000865"></a>

<!-- BEGIN TOPNAV -->
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
<td><img src="images/shim.gif" width="7" height="75" border="0" alt=""></td>
<td align="left"><table border="0" cellpadding="0" cellspacing="0" width="744">
<tr>
<td><img name="index_r2_c1" src="images/shim.gif" width="25" height="75" border="0" alt=""></td>
<td valign="top"><table border="0" cellpadding="0" cellspacing="0" width="96">
<tr>
<td><img name="index_r2_c4" src="images/shim.gif" width="96" height="15" border="0" alt=""></td>
</tr>
<tr>
<td><a href="http://www.palmsource.com/"><img name="ps_logo" src="images/ps_logo.gif" width="96" height="54" border="0" alt=""></a></td>
</tr>

</table>
</td>

<td><table border="0" cellpadding="0" cellspacing="0" width="30">
<td><img name="index_x" src="images/shim.gif" width="30" height="75" border="0" alt=""></td>
</table></td>

<!--BEGIN MASTHEAD-->
<td><table border="0" cellpadding="0" cellspacing="0" width="96">
<tr>
<td><img name="index_x" src="images/shim.gif" width="615" height="5" border="0" alt=""></td>
</tr>
<tr>
<td>
<!--BEGIN BOOK NAVIGATION-->
<span class="nav">
<A href="http://www.palmos.com/dev/support/docs/">Documentation</a>&nbsp;&nbsp;|&nbsp;&nbsp;
<a href="SysMgt_TOC.html">Table of Contents</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="Sound.html">&lt;&nbsp;Previous</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="SharedLibraries.html">Next&nbsp;&gt;</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="SysMgt_IX.html">Index</a>
</span>
<!--END BOOK NAVIGATION-->
</tr>
<tr>
<td>
<!--BEGIN PAGE TITLE-->
<h2 class="PageTitle">5 &nbsp;&nbsp;
Expansion</h2></td>
<!--END PAGE TITLE-->
</tr>
<tr>
<td>
<!--BEGIN BOOK TITLE-->
<p class="BookTitle">System Management</p>
<p class="SubTitle">Exploring Palm OS&#174; </p>
<!--END BOOK TITLE-->
</td>
</tr>
<tr>
<td><img name="index_x" src="images/shim.gif" width="615" height="5" border="0" alt=""></td>
</tr>
</table>
</td>
<!--END MASTHEAD-->
</tr>
</table>
<img name="dashes" src="images/dashes.gif" width="744" height="3" border="0" alt=""></td>
</tr>
</table>
<!-- END TOPNAV -->

<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
<td valign="top" width="5"><img name="index_x" src="images/shim.gif" width="5" height="33" border="0" alt=""></td>

<!--BEGIN SIDETOC-->
<td valign="top" width="175">
<div id="sidetoc" valign="bottom">
<h1 class="SideTOC1-PartTab"><a href="SysMgt_Part1.html">Part I: Concepts</a> </h1>
<h1 class="SideTOC1"><a href="Expansion.html">5  Expansion</a></h1>

   <h2 class="SideTOC2"><a href="#1000912">
   Expansion Support</a></h2>

      <h3 class="SideTOC3"><a href="#1000918">
      Primary vs. Secondary Storage</a></h3>

      <h3 class="SideTOC3"><a href="#1000936">
      Expansion Slot</a></h3>

      <h3 class="SideTOC3"><a href="#1000946">
      Universal Connector</a></h3>

   <h2 class="SideTOC2"><a href="#1000953">
   Architectural Overview</a></h2>

      <h3 class="SideTOC3"><a href="#1000965">
      Block Device Drivers</a></h3>

      <h3 class="SideTOC3"><a href="#1000976">
      File Systems</a></h3>

      <h3 class="SideTOC3"><a href="#1014386">
      VFS Manager</a></h3>

      <h3 class="SideTOC3"><a href="#1001008">
      Expansion Manager</a></h3>

   <h2 class="SideTOC2"><a href="#1001070">
   Applications on Cards</a></h2>

   <h2 class="SideTOC2"><a href="#1001095">
   Card Insertion and Removal</a></h2>

      <h3 class="SideTOC3"><a href="#1001193">
      Start.prc</a></h3>

   <h2 class="SideTOC2"><a href="#1001214">
   Checking for Expansion Cards</a></h2>

      <h3 class="SideTOC3"><a href="#1001217">
      Verifying Handheld Compatibility</a></h3>

      <h3 class="SideTOC3"><a href="#1001246">
      Checking for Mounted Volumes</a></h3>

      <h3 class="SideTOC3"><a href="#1001269">
      Enumerating Slots</a></h3>

      <h3 class="SideTOC3"><a href="#1001298">
      Determining a Card's Capabilities</a></h3>

   <h2 class="SideTOC2"><a href="#1002154">
   Summary of Expansion Manager</a></h2>

</div>
</td>

<td width="5">&nbsp;&nbsp;</td>
<td width="2" background="images/index_r8_c10.gif"><img src="images/shim.gif" width="2" height="75" border="0" alt=""></td>
<td width="5">&nbsp;&nbsp;</td>

<!--END SIDETOC-->

<td valign="top">

<!--BEGIN CONTENT-->
<div id="content" valign="bottom">
<p><a name="1000866"> </a>This chapter describes how to work with expansion cards and add-on devices using the Palm OS<sup>&#174;</sup> Expansion and Virtual File System (VFS) Managers.</p>
<ul type="disc">
  <li><a name="1000870"> </a><a href="Expansion.html#1000912">Expansion Support</a> introduces basic terminology and discusses the hardware and file systems supported by the Expansion and VFS Managers.
  <li><a name="1000874"> </a><a href="Expansion.html#1000953">Architectural Overview</a> illustrates the Palm OS expansion architecture and discusses the differences between primary and secondary storage.
  <li><a name="1000882"> </a><a href="Expansion.html#1001070">Applications on Cards</a> covers the various implications of running Palm OS applications from an expansion card.
  <li><a name="1000886"> </a><a href="Expansion.html#1001095">Card Insertion and Removal</a> covers, in detail, the sequence of events that occur when an expansion card is inserted into or removed from an expansion slot.
  <li><a name="1000890"> </a><a href="Expansion.html#1001214">Checking for Expansion Cards</a> shows you how to verify that the handheld supports expansion, how to check each of the handheld's slots for expansion cards, and how to determine the capabilities of a card in a given slot.
</ul>

<h2 class="haH2">
  <a name="1000912"> </a>Expansion Support <a href="#1000865"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="1000917"> </a>The Palm OS Expansion and VFS Managers are optional system extensions that provide a standard mechanism by which Palm OS applications can take advantage of the expansion capabilities of various Palm Powered<sup>&#8482;</sup> handhelds. This capability not only augments the memory and I/O of the handheld, but facilitates data interchange with other Palm Powered handhelds and with devices that aren't running the Palm OS. These other devices include digital cameras, digital audio players, desktop or laptop computers, and the like.</p>
<h3 class="hbH3">
  <a name="1000918"> </a>Primary vs. Secondary Storage <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1000920"> </a>All Palm Powered handhelds contain <b>primary storage</b>&#8212;directly addressable memory that is used for both long-term and temporary storage. This includes storage RAM, used to hold nonvolatile user data and applications; and dynamic RAM, which is used as working space for temporary allocations.</p>

<p><a name="1000922"> </a>On most handhelds, primary storage is contained entirely within the device itself. The Palm OS memory architecture doesn't limit devices to this, however; devices can be designed to accept additional storage RAM. The products developed by Handspring&#8482; work this way; memory modules plugged into the Springboard slot are fully-addressable and appear to a Palm OS application as additional storage RAM.</p>

<p><a name="1000924"> </a><b>Secondary storage</b>, by contrast, is designed primarily to be add-on nonvolatile storage. Although not limited to any particular implementation, most secondary storage media:</p>
<ul type="disc">
  <li><a name="1000925"> </a>can be inserted and removed from the expansion slot at will
  <li><a name="1000927"> </a>are based upon a third-party standard, such as Secure Digital (SD) memory cards, MultiMedia (MMC) cards, CompactFlash, Sony's Memory Stick&#8482;, and others
  <li><a name="1000931"> </a>present a serial interface, accessing data one bit, byte, or block at a time
</ul>

<p><a name="1000932"> </a>Applications access primary storage either directly, in the case of most dynamic RAM, or through the Database and Resource Managers. To access secondary storage, however, applications use the Expansion and VFS Managers. These have been designed to support as broad a range of serial expansion architectures as possible.</p>
<h3 class="hbH3">
  <a name="1000936"> </a>Expansion Slot <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1000937"> </a>The expansion slots found on many Palm Powered handhelds vary depending on the manufacturer. While some may accept SD and MMC cards, others may accept Memory Stick or CompactFlash. Note that there is no restriction on the number of expansion slots that a given handheld can have.</p>

<p><a name="1000938"> </a>Depending on the expansion technology used, there can be a wide variety of expansion cards usable with a given handheld:</p>
<ul type="disc">
  <li><a name="1000940"> </a>Storage cards provide secondary storage and can either be used to hold additional applications and data, or can be used for a specific purpose, for instance as a backup mechanism.
  <li><a name="1000942"> </a>ROM cards hold dedicated applications and data.
  <li><a name="1000943"> </a>I/O cards extend the handheld's I/O capabilities. A modem, for instance, could provide wired access, while a Bluetooth&#8482; transceiver could add wireless capability.
  <li><a name="1000944"> </a>"Combo" cards provide both additional storage or ROM along with some I/O capability.
</ul>
<h3 class="hbH3">
  <a name="1000946"> </a>Universal Connector <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1000947"> </a>Certain Palm Powered handhelds may be equipped with a universal connector that connects the handheld to a HotSync<sup>&#174;</sup> cradle. This connector can be used to connect the handheld to snap-on I/O devices as well. A special device driver dedicated to this connector allows handheld-to-accessory communication using the serial portion of the connector. This "plug and play" driver presents the peripheral as a card in a slot, even to the extent of providing the card insertion notification when the peripheral is attached.</p>

<p><a name="1000950"> </a>Because the universal connector's driver makes a snap-on peripheral appear to be a card in a slot, such peripherals can be treated as expansion cards, at least from an application developer's perspective. For the remainder of this chapter, wherever an I/O card could be used, the phrase "expansion card" can be taken to mean both "expansion card" and "plug and play peripheral."</p>

<h2 class="haH2">
  <a name="1000953"> </a>Architectural Overview <a href="#1000865"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="1000957"> </a><a href="Expansion.html#1000959">Figure 5.1</a> illustrates the Palm OS expansion architecture. It is designed to be flexible enough to support multiple file systems and diverse physical expansion mechanisms while still presenting a consistent set of APIs to applications and to other parts of the Palm OS. The following sections describe the major components of the Palm OS expansion architecture. Working from the bottom up, those components are: block device drivers, file systems, the VFS Manager, and the Expansion Manager.</p>

<p class="FFigureCaption">
  <a name="1000959"> </a><b>Figure 5.1&nbsp;&nbsp;Palm OS expansion architecture</b>
</p>
<div align="left"><img src="images/ExpArch.jpg" height="437" width="480" border="0" hspace="0" vspace="0">
</div>
<h3 class="hbH3">
  <a name="1000965"> </a>Block Device Drivers <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1000966"> </a>A block device driver is a standard Palm OS shared library that encapsulates direct access to the hardware and provides a standard set of services to the Expansion Manager (and optionally to file system libraries). Adding support for a new type of hardware expansion is usually simply a matter of writing a block device driver for it. As illustrated in <a href="Expansion.html#1000959">Figure 5.1</a>, applications don't normally interact directly with device drivers.</p>

<p><a name="1000970"> </a>Each expansion slot has a block device driver associated with it. Slots are identified by a unique <b>slot reference number</b>, which is assigned by the Expansion Manager. Expansion cards themselves are not numbered individually; applications typically reference the slot into which a card is inserted. Note, however, that a slot may or may not have a card in it at any given time, and that a card can be inserted and removed while an application is running.</p>

<p><a name="1000974"> </a>The current implementation only supports one volume per slot.</p>
<h3 class="hbH3">
  <a name="1000976"> </a>File Systems <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1000977"> </a>The Palm OS expansion architecture defines a common interface for all file system implementations on the Palm OS. This interface consists of a complete set of APIs for interacting with the file system, including the ability to open, close, read, write, and delete both files and directories on named volumes.</p>

<p><a name="1000979"> </a>File system implementations are packaged as shared libraries of type <code>sysFileTFileSystem</code> (<code>'libf'</code>). They are modular plug-ins that add support for a particular type of file system, such as VFAT, HFS, or NFS. The Palm OS expansion architecture allows multiple file system libraries to be installed at any given time. Typically, an implementation of the VFAT file system is present.</p>

<p><a name="1000981"> </a>VFAT is the industry standard for flash memory cards of all types. It enables easy transfer of data and or applications to desktops and other devices. The VFAT file system library natively supports VFAT file systems on secondary storage media. It is able to recognize and mount FAT and VFAT file systems, and offers to reformat unrecognizable or corrupted media.</p>

<p><a name="1014385"> </a>Because the VFAT file system requires long filenames to be stored in Unicode/UCS2 format, the standard VFAT file system library supports conversion between UCS2 and Shift-JIS (the standard Palm OS multi-byte character encoding), and the Palm/Latin encoding.</p>

<p><a name="1014477"> </a>The FAT filesystem component in Palm OS Cobalt supports FAT12/16 and VFAT as well as FAT32. Volumes greater than 512 MB are implicitly formatted as FAT32. However, the system recognizes volumes of any size that are formatted as FAT12 or FAT16.</p>
<h3 class="hbH3">
  <a name="1014386"> </a>VFS Manager <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1014387"> </a>The VFS (Virtual File System) Manager provides a unified API that gives applications access to many different file systems on many different media types. It abstracts the underlying file systems so that applications can be written without regard to the actual file system in use. The VFS Manager includes APIs for manipulating files, directories, and volumes.</p>

<div><hr>
  <a name="1000988"> </a> <b>NOTE: </b> Although the great majority of the functions in the VFS Manager can be used by any application, some are intended only for use by drivers and file systems. Others are not intended for use by third-party applications but are designed primarily for system use.
<hr>
</div>

<h4 class="hcH4">
  <a name="1000990"> </a>The VFS Manager, the Data Manager, and File Streaming APIs
</h4>

<p><a name="1000991"> </a>With the addition of the VFS Manager to the Palm OS, there are now three distinct ways applications can store and retrieve Palm OS user data:</p>
<ul type="disc">
  <li><a name="1000992"> </a>The Data Manager manages user data in the storage heap. It was specifically designed to make the most of the limited dynamic RAM and the nonvolatile RAM used instead of disk storage on most handhelds. Use the Data Manager to store and retrieve Palm OS user data when storage on the handheld is all that is needed, or when efficient access to data is paramount.
  <li><a name="1000993"> </a>The File Streaming API is a layer on top of the Data Manager that provides file functionality with all data being read from or written to a database in the storage heap. Most applications have no need for the File Streaming APIs; they are primarily used by applications that need to work with large blocks of data.
  <li><a name="1000995"> </a>The VFS and Expansion Managers were designed specifically to support many types of expansion memory as secondary storage. The VFS Manager APIs present a consistent interface to many different types of file systems on many types of external media. Applications that use the VFS APIs can support the widest variety of file systems. Use the VFS Manager when your application needs to read and write data stored on external media.
</ul>

<p><a name="1000996"> </a>Palm OS applications should use the appropriate APIs for each given situation. The Data Manager, being an efficient manager of storage in the storage heap, should be used whenever access to external media is not absolutely needed. Use the VFS API when interoperability and file system access is needed. Note, however, that the VFS Manager adds the extra overhead of buffering all reads and writes in memory when accessing data, so only applications that specifically need this functionality should use the VFS Manager. </p>

<p><a name="1000997"> </a>For more information on the Data and Resource Managers, as well as on the File Streaming APIs and the VFS Manager, see <i>Exploring Palm OS: Memory, Databases, and Files</i>.</p>
<h3 class="hbH3">
  <a name="1001008"> </a>Expansion Manager <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001009"> </a>The Expansion Manager is a software layer that manages block device drivers on Palm OS handhelds. Supported expansion card types include, but are not limited to, Memory Stick and SD cards. The Expansion Manager does not support these expansion cards directly; rather, it provides an architecture and higher level set of APIs that, with the help of low level block device drivers and file system libraries, support these types of media.</p>

<p><a name="1001011"> </a>The Expansion Manager:</p>
<ul type="disc">
  <li><a name="1001012"> </a>broadcasts notification of card insertion and removal
  <li><a name="1001013"> </a>plays sounds to signify card insertion and removal
  <li><a name="1001014"> </a>mounts and unmounts card-resident volumes
</ul>

<div><hr>
  <a name="1001016"> </a> <b>NOTE: </b> Some of the other functions provided by the Expansion Manager are for use by drivers and file systems and are not generally used by their-party applications.
<hr>
</div>

<p><a name="1001019"> </a>For details of the APIs presented by the VFS Manager, see <i>Exploring Palm OS: Memory, Databases, and Files</i>.</p>

<h2 class="haH2">
  <a name="1001070"> </a>Applications on Cards <a href="#1000865"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="1001071"> </a>Palm OS applications located in the <code>/PALM/Launcher</code> directory of an expansion card volume appear in a separate Launcher category when the card is inserted into the handheld's expansion slot. If you tap the icon for one of these applications, it is copied to main memory and then launched.</p>

<p><a name="1001073"> </a>Applications launched from a card ("card-launched" applications) are first sent a <a href="../Programming_Basics/CmnLaunchCodes.html#993894"><code>sysAppLaunchCmdCardLaunch</code></a> launch code, along with a parameter block that includes the reference number of the volume on which the application resides and the complete path to the application. When processing this launch code, the application shouldn't interact with the user or access globals. Unless the application sets the <code>sysAppLaunchStartFlagNoUISwitch</code> bit in the <code>start</code> flags (which are part of the parameter block), the application is then sent a <code>sysAppLaunchCmdNormalLaunch</code> launch code. This is when the application should, if it needs to, interact with user. Applications may want to save some state when <code>sysAppLaunchCmdCardLaunch</code> is received, then act upon that state information when <code>sysAppLaunchCmdNormalLaunch</code> is received.</p>

<p><a name="1001080"> </a>When the user switches to a new application, the card-launched application is removed from main memory. Note, however, that any databases created by the card-launched application remain.</p>

<p><a name="1001081"> </a>There are certain implications to this "copy and run" process.</p>
<ul type="disc">
  <li><a name="1001082"> </a>There must be sufficient memory for the application. If the handheld doesn't have enough memory to receive the application, it isn't copied from the expansion card and it isn't launched.
  <li><a name="1001083"> </a>The copying process takes time. For large applications, this can cause a noticeable delay before the application is actually launched.
  <li><a name="1001084"> </a>If some version of the application on the card is already present in main memory, the Launcher puts up a dialog that requires the user to choose whether or not to overwrite the in-memory version.
  <li><a name="1001087"> </a>Card-launched applications have a limited lifetime: applications reside in main memory only while they are running. When the user switches to a different application, the card-launched application that was just running is removed from main memory. If the card-launched application is then re-launched, it is once again copied into the handheld's memory.
  <li><a name="1001089"> </a>"Legacy" applications&#8212;those that are unaware that they are being launched from a card&#8212;only work with databases in main memory. Associated databases aren't copied to main memory along with the application unless the database is bundled with the application. Databases created by card-launched applications are not removed along with the application, however, so this data is available to the application when it is subsequently run. Applications that are written to take advantage of the VFS Manager can read and write data on the expansion card, so this limitation generally only applies to legacy applications.
   <p><a name="1001090"> </a>Bundled databases, although copied to main memory along with their associated application, are meant for static data that doesn't change, such as a game level database. Bundled databases are not copied back to the card; they are simply deleted from memory when the user chooses another application. To bundle a database with an application, give it the same creator ID as the owning application, set the <code>dmHdrAttrBundle</code> bit, and place it in the <code>/PALM/Launcher</code> directory along with the application.</p>
  <li><a name="1001092"> </a>Unless a card-launched application is running, it doesn't receive notifications or launch codes since it isn't present on the handheld. In particular, these applications don't receive notifications and aren't informed when an alarm is triggered.
</ul>

<h2 class="haH2">
  <a name="1001095"> </a>Card Insertion and Removal <a href="#1000865"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="1001096"> </a>The Expansion Manager supports the insertion and removal of expansion media at any time. The handheld continues to run as before, though an application switch may occur upon card insertion. The handheld need not be reset or otherwise explicitly informed that a card has been inserted or removed.</p>

<div><hr>
  <a name="1001097"> </a> <span class="warning">WARNING! </span> Due to the way certain expansion cards are constructed, if the user removes an expansion card while it is being written to, in certain rare circumstances it is possible for the card to become damaged to the point where either it can no longer be used or it must be reformatted. To the greatest extent possible, applications should only write to the card at well-defined points, and the application should warn the user&#8212;perhaps with a "Please Wait" or progress dialog&#8212;at that time not to remove the expansion card. The card can be removed while an application is reading from it without fear of damage.
<hr>
</div>

<p><a name="1001099"> </a>The Palm OS uses a series of notifications to indicate that a card has been inserted or removed, or that a volume has been mounted or unmounted. The following table lists these notifications, and the priority for which they have been registered by the Expansion and VFS Managers. Note that the priorities may change in a future release, so applications shouldn't depend on these precise values. Applications that register for these using normal priority get the correct behavior.</p>

<p class="caption"><a name="1001103"> </a><b>Table 5.1&nbsp;&nbsp;Expansion card notifications</b></p>
<div class="tablediv"><table cellspacing="0" class="tTable">

  <tr valign="top">
    <th><p class="tt"><a name="1001109"> </a><b>Notification</b></p>
    </th>
    <th><p class="tt"><a name="1001111"> </a><b>Registered by</b></p>
    </th>
    <th><p class="tt"><a name="1001113"> </a><b>Priority</b></p>
    </th>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001119"> </a><a href="../Programming_Basics/NotifyMgr.html#996555"><code>sysNotifyCardInsertedEvent</code></a></p>
    </td>
    <td><p class="tt"><a name="1001121"> </a>Exp. Manager</p>
    </td>
    <td><p class="tt"><a name="1001123"> </a> 20</p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001129"> </a><a href="../Programming_Basics/NotifyMgr.html#996613"><code>sysNotifyCardRemovedEvent</code></a></p>
    </td>
    <td><p class="tt"><a name="1001131"> </a>Exp. Manager</p>
    </td>
    <td><p class="tt"><a name="1001133"> </a>-20</p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001139"> </a><a href="../Programming_Basics/NotifyMgr.html#996627"><code>sysNotifyVolumeMountedEvent</code></a></p>
    </td>
    <td><p class="tt"><a name="1001141"> </a>Exp. Manager</p>
    </td>
    <td><p class="tt"><a name="1001143"> </a>-20</p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001148"> </a><a href="../Programming_Basics/NotifyMgr.html#996627"><code>sysNotifyVolumeMountedEvent</code></a></p>
    </td>
    <td><p class="tt"><a name="1001150"> </a>VFS Manager</p>
    </td>
    <td><p class="tt"><a name="1001152"> </a> 10</p>
    </td>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1001158"> </a><a href="../Programming_Basics/NotifyMgr.html#996649"><code>sysNotifyVolumeUnmountedEvent</code></a></p>
    </td>
    <td><p class="tt"><a name="1001160"> </a>Exp. Manager</p>
    </td>
    <td><p class="tt"><a name="1001162"> </a>-20</p>
    </td>
  </tr>
</table>

</div>


<p><a name="1001164"> </a>The following diagram shows the sequence of events that occur when an expansion card is inserted into a Palm Powered handheld's expansion slot. For clarity, it assumes that no errors occur. If the card doesn't contain a mountable volume, and if the card cannot be formatted and then mounted, this sequence is aborted and the card remains unmounted, although the card insertion notification is still broadcast.</p>

<p class="FFigureCaption">
  <a name="1001165"> </a><b>Figure 5.2&nbsp;&nbsp;Sequence of events upon card insertion</b>
</p>
<div align="left"><img src="images/ExpCardSequence2.jpg" height="447" width="480" border="0" hspace="0" vspace="0">
</div>

<p><a name="1001171"> </a>The Expansion Manager registers for <code>sysNotifyCardInsertedEvent</code> with a priority of 20, ensuring that it is notified after other handlers that may have registered with normal priority. To override the Expansion Manager's default handler, register your handler to receive <code>sysNotifyCardInsertedEvent</code> with normal priority, and have it set the appropriate bits in the <code>handled</code> member of the <code>SysNotifyParamType</code> structure: </p>
<ul type="disc">
  <li><a name="1001172"> </a><code>expHandledVolume</code> indicates that any volumes associated with the card have been dealt with, and prevents the Expansion Manager from mounting or unmounting the card's volumes.
  <li><a name="1001173"> </a><code>expHandledSound</code> indicates that your application has handled the playing of an appropriate sound, and prevents the Expansion Manager from playing a sound when the card is inserted or removed. 
</ul>

<p><a name="1001174"> </a>Note that the number of the slot into which the card was inserted is passed to your handler using the <code>notifyDetailsP</code> member&#8212;which is a <code>UInt16</code>, cast to a <code>void *</code>&#8212;of the <code>SysNotifyParamType</code> structure.</p>

<p><a name="1001175"> </a>Although most applications only register for volume mount and unmount notifications, if you need to receive notifications when the user removes a card from a slot managed by the Expansion Manager, have your application register to receive <code>sysNotifyCardRemovedEvent</code>. Unlike with <code>sysNotifyCardInsertedEvent</code>, the Expansion Manager registers for <code>sysNotifyCardRemovedEvent</code> with a priority of -20, ensuring that it receives the notification before other handlers that are registered for it with normal priority. This notification, too, passes the number of the slot from which the card was removed to your handler using the <code>notifyDetailsP</code> member&#8212;which is a <code>UInt16</code>, cast to a <code>void *</code>&#8212;of the <code>SysNotifyParamType</code> structure.</p>

<p><a name="1001177"> </a>The VFS Manager registers for <code>sysNotifyVolumeMountedEvent</code> with a priority of 10. To override the VFS Manager's default handler, register your handler to receive <code>sysNotifyVolumeMountedEvent</code> with normal priority, and have it set the appropriate bits in the <code>handled</code> member of the <code>SysNotifyParamType</code> structure:</p>
<ul type="disc">
  <li><a name="1001179"> </a><code>vfsHandledUIAppSwitch</code> indicates that your application has handled <code>SysUIAppSwitch</code> to <code>start.prc</code>. This bit prevents the VFS Manager from performing its own <code>SysUIAppSwitch</code> to <code>start.prc</code> (although <code>start.prc</code> is still loaded and a <code>SysAppLaunch</code> is performed), and also prevents the launcher from switching to itself.
  <li><a name="1001180"> </a><code>vfsHandledStartPrc</code> indicates that your handler has dealt with the automatic running of <code>start.prc</code>. The VFS Manager won't load it and won't call either <code>SysAppLaunch</code> or <code>SysUIAppSwitch</code>.
</ul>

<p><a name="1001181"> </a>Note that if your application handles the running of <code>start.prc</code>, you need to keep security in mind. If the handheld is locked when an expansion card is inserted, the VFS Manager's own handler defers the execution of <code>start.prc</code> until the user unlocks the handheld.</p>

<p><a name="1001184"> </a>Card removal follows a similar sequence, although there is no equivalent to <code>start.prc</code> that is automatically run. This sequence is illustrated in the following diagram.</p>

<p class="FFigureCaption">
  <a name="1001185"> </a><b>Figure 5.3&nbsp;&nbsp;Sequence of events upon card removal</b>
</p>
<div align="left"><img src="images/ExpCardRemove3.jpg" height="302" width="480" border="0" hspace="0" vspace="0">
</div>

<p><a name="1001190"> </a>Upon card removal, the Expansion Manager broadcasts a notification to all applications that have registered to receive card removal notifications and unmounts any mounted volumes on the card. This causes the VFS Manager to issue a card unmounted notification. Each application must register for the card unmounted notification and provide the necessary error handling code if card removal at any time will cause a problem for the application.</p>

<p><a name="1001191"> </a>Note that the card insertion and removal notifications are intended primarily for system use, although they can be registered for by applications that need them. Applications that deal only with file systems and the VFS Manager should confine themselves to the volume mounted and unmounted notifications.</p>
<h3 class="hbH3">
  <a name="1001193"> </a>Start.prc <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001198"> </a>Upon receipt of a <a href="../Programming_Basics/NotifyMgr.html#996627"><code>sysNotifyVolumeMountedEvent</code></a> that hasn't already been handled (as indicated by the state of the <code>vfsHandledStartPrc</code> bit, as described in the previous section), the VFS Manager copies <code>/Palm/start.prc</code>&#8212;and its overlay, if there is one&#8212;to the storage heap and launches it. This process enables "application cards"&#8212;single-function cards that execute automatically upon card insertion. It also allows for combo cards that automatically load any necessary drivers and applications to support card I/O.</p>

<p><a name="1001199"> </a>To launch <code>start.prc</code>, the VFS Manager first sends it a special launch code, <a href="../Programming_Basics/CmnLaunchCodes.html#993894"><code>sysAppLaunchCmdCardLaunch</code></a>. If the application only needs to do a bit of work and return, it should do it here and then set the <code>sysAppLaunchStartFlagNoUISwitch</code> bit in the start flags, which are part of the <code>sysAppLaunchCmdCardLaunch</code> parameter block. Note that the application doesn't have access to globals and it shouldn't interact with the user here. If the <code>sysAppLaunchStartFlagNoUISwitch</code> bit is not set, as it isn't if the application ignores the <code>sysAppLaunchCmdCardLaunch</code> launch code, the VFS Manager then sends it a <code>sysAppLaunchCmdNormalLaunch</code> launch code to run the application normally. This ensures backwards compatibility with applications that do not understand the <code>sysAppLaunchCmdCardLaunch</code> launch code. This is where the application can interact with the user; an application may want to save state when it receives <code>sysAppLaunchCmdCardLaunch</code>, and then act upon that state when it receives <code>sysAppLaunchCmdNormalLaunch</code>.</p>

<p><a name="1001206"> </a>To avoid running out of stack space, the VFS Manager sets the "new stack" bit when launching <code>start.prc</code>. The <code>start.prc</code> application remains in system memory until the volume from which it was copied is removed. <code>start.prc</code> is deleted before <code>VFSVolumeUnmount</code> broadcasts <code>sysNotifyVolumeUnmountedEvent</code> but after the Expansion Manager broadcasts <code>sysNotifyCardRemovedEvent</code>. By registering for <code>sysNotifyCardRemovedEvent</code>, <code>start.prc</code> can react to the volume being removed before it is deleted.</p>

<div><hr>
  <a name="1001208"> </a> <b>NOTE: </b> If an expansion card is inserted while the handheld is locked, <code>start.prc</code> is not executed until the user unlocks the handheld.
<hr>
</div>

<h2 class="haH2">
  <a name="1001214"> </a>Checking for Expansion Cards <a href="#1000865"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="1001215"> </a>Before looking for an expansion card, your program should first make sure that the handheld supports expansion by verifying the presence of the Expansion and VFS Managers. It can then query for mounted volumes. Finally, your program may want to ascertain the capabilities of the card; whether it has memory, whether it does I/O, and so on. The following sections describe each of these steps.</p>
<h3 class="hbH3">
  <a name="1001217"> </a>Verifying Handheld Compatibility <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001218"> </a>There are many different Palm OS handhelds, and in the future there will be many more. Some will have expansion slots to support secondary storage, and some will not. Hardware to support secondary storage is optional, and may or may not be present on a given handheld. Since the Expansion and VFS Managers are of no use on a handheld that has no physical expansion capability, they are optional system extensions that are not present on every Palm Powered handheld. </p>

<p><a name="1001219"> </a>Due to the great variability both in handheld configuration and in the modules which can be plugged into or snapped onto the handheld, applications shouldn't attempt to detect the manufacturer or model of a specific handheld when determining if it supports secondary storage. Instead, check for the presence and capabilities of the underlying operating system.</p>
<h3 class="hbH3">
  <a name="1001246"> </a>Checking for Mounted Volumes <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001247"> </a>Many applications rely on the handheld's expansion capabilities for additional storage. Applications that don't care about the physical characteristics of the secondary storage module, and that don't need to know the slot into which the module is inserted, can rely on the fact that the Palm OS automatically mounts any recognized volumes inserted into or snapped onto the handheld. Thus, many applications can simply enumerate the mounted volumes and select one as appropriate. The following code illustrates how to do this:</p>
<p class="CCodeCaption">
  <a name="1001248"> </a><b>Listing 5.1&nbsp;&nbsp;Enumerating mounted volumes</b>
</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
UInt16 volRefNum;<a name="1001249"> </a>
UInt32 volIterator = vfsIteratorStart;<a name="1001250"> </a>
 <a name="1001251"> </a>
while (volIterator != vfsIteratorStop) {<a name="1001252"> </a>
   err = VFSVolumeEnumerate(&amp;volRefNum, &amp;volIterator);<a name="1001253"> </a>
   if (err == errNone) {<a name="1001254"> </a>
      // Do something with the volRefNum<a name="1001255"> </a>
   } else {<a name="1001256"> </a>
      // handle error... possibly by <a name="1001257"> </a>
      // breaking out of the loop<a name="1001258"> </a>
   }<a name="1001259"> </a>
}<a name="1001260"> </a>
</pre><div class="CodeRule"><hr></div>


<p><a name="1001261"> </a>The volume reference number obtained from <a href="../Memory_Databases_Files/VFSMgr.html#997470"><code>VFSVolumeEnumerate()</code></a> can then be used with many of the volume, directory, and file operations that are described later in this chapter.</p>

<p><a name="1001266"> </a>Occasionally an application needs to know more than that there is secondary storage available for use. Those applications likely need to take a few extra steps, beginning with checking each of the handheld's slots.</p>
<h3 class="hbH3">
  <a name="1001269"> </a>Enumerating Slots <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001270"> </a>Before you can determine which expansion modules are attached to a Palm OS handheld, you must first determine how those modules could be attached. Expansion cards and some I/O devices could be plugged into physical slots, and snap-on modules could be connected through the handheld's universal connector. Irrespective of how they're physically connected, the Expansion Manager presents these to the developer as slots. Enumerating these slots is made simple due to the presence of the <a href="ExpansionMgr.html#995065"><code>ExpSlotEnumerate()</code></a> function. The use of this function is illustrated here:</p>
<p class="CCodeCaption">
  <a name="1001275"> </a><b>Listing 5.2&nbsp;&nbsp;Iterating through a handheld's expansion slots</b>
</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
UInt16 slotRefNum;<a name="1001276"> </a>
UInt32 slotIterator = expIteratorStart;<a name="1001277"> </a>
 <a name="1001278"> </a>
while (slotIterator != expIteratorStop) {<a name="1001279"> </a>
   // Get the slotRefNum for the next slot<a name="1001280"> </a>
   err = ExpSlotEnumerate(&amp;slotRefNum, &amp;slotIterator);<a name="1001281"> </a>
   if(err == errNone) {<a name="1001282"> </a>
      // perform slot-specific processing here<a name="1001283"> </a>
   } else {<a name="1001284"> </a>
      // handle error... possibly by<a name="1001285"> </a>
      // breaking out of the loop<a name="1001286"> </a>
}<a name="1001287"> </a>
</pre><div class="CodeRule"><hr></div>


<p><a name="1001289"> </a>The slot reference number returned by <code>ExpSlotEnumerate</code> uniquely identifies a given slot. This can be supplied to various Expansion Manager functions to obtain information about the slot, such as whether there is a card or other expansion module present in the slot.</p>

<h4 class="hcH4">
  <a name="1001291"> </a>Checking a Slot for the Presence of a Card
</h4>

<p><a name="1001296"> </a>Use the <a href="ExpansionMgr.html#994237"><code>ExpCardPresent</code></a> function to determine if a card is present in a given slot. Given the slot reference number, this function returns <code>errNone</code> if there is a card in the slot, or an error if either there is no card in the slot or there is a problem with the specified slot.</p>
<h3 class="hbH3">
  <a name="1001298"> </a>Determining a Card's Capabilities <a href="#1000865"><span class="nav">^TOP^</span></a>
</h3>


<p><a name="1001299"> </a>Just knowing that an expansion card is inserted into a slot or connected to the handheld isn't enough; your application needs to know something about the card to ensure that the operations it needs to perform are compatible with the card. For instance, if your application needs to write data to the card, its important to know if writing is permitted.</p>

<p><a name="1001300"> </a>The capabilities available to your application depend not only on the card but on the block device driver as well. Handheld manufacturers will provide one or more block device drivers that define standard interfaces to certain classes of expansion hardware. Card and device manufacturers may also choose to provide card-specific block device drivers, or they may require that applications use the slot custom control function and a registered creator code to access and control certain cards.</p>

<p><a name="1001301"> </a>The block device driver is responsible for querying expansion cards for a standard set of capabilities. When a block device driver is present for a given expansion card, you can use the <a href="ExpansionMgr.html#993765"><code>ExpCardInfo</code></a> function to determine the following:</p>
<ul type="disc">
  <li><a name="1001306"> </a>the name of the expansion card's manufacturer
  <li><a name="1001307"> </a>the name of the expansion card
  <li><a name="1001308"> </a>the "device class," or type of expansion card. Values returned here might include "Ethernet" or "Backup"
  <li><a name="1001309"> </a>a unique identifier for the device, such as a serial number
  <li><a name="1001310"> </a>whether the card supports both reading and writing, or whether it is read-only
  <li><a name="1001311"> </a>whether the card supports a simple serial interface
</ul>

<p><a name="1001312"> </a>Note that the existence of the <code>ExpCardInfo</code> function does not imply that all expansion cards support these capabilities. It only means that the block device driver is able to assess a card and report its findings up to the Expansion Manager.</p>

<h2 class="haH2">
  <a name="1002154"> </a>Summary of Expansion Manager <a href="#1000865"><span class="nav">^TOP^</span></a>
</h2>



<div class="tablediv"><table cellspacing="0" class="tTable">

  <tr valign="top">
    <th colspan="2" rowspan="1"><p class="tt"><a name="1002157"> </a><b>Expansion Manager Functions</b></p>
    </th>
  </tr>
  <tr valign="top">
    <td><p class="tt"><a name="1002164"> </a><a href="ExpansionMgr.html#993765"><code>ExpCardInfo()</code></a><br><a href="ExpansionMgr.html#993811"><code>ExpCardIsFilesystemSupported()</code></a><br><a href="ExpansionMgr.html#993861"><code>ExpCardMediaType()</code></a><br><a href="ExpansionMgr.html#993907"><code>ExpCardMetrics()</code></a><br><a href="ExpansionMgr.html#994237"><code>ExpCardPresent()</code></a><br><a href="ExpansionMgr.html#994428"><code>ExpCardSectorRead()</code></a><br><a href="ExpansionMgr.html#994521"><code>ExpCardSectorWrite()</code></a><br><a href="ExpansionMgr.html#994583"><code>ExpSlotCustomControl()</code></a></p>
    </td>
    <td><p class="tt"><a name="1002178"> </a><a href="ExpansionMgr.html#995065"><code>ExpSlotEnumerate()</code></a><br><a href="ExpansionMgr.html#995429"><code>ExpSlotMediaType()</code></a><br><a href="ExpansionMgr.html#995475"><code>ExpSlotPowerCheck()</code></a><br></p>
    </td>
  </tr>
</table>

</div>


<p><a name="1002368"> </a></p>
&nbsp;<br>
</div>
<!--END CONTENT-->

</td>
<td width="5">&nbsp;&nbsp;</td>
</tr>

</table>

<!-- BEGIN FOOTER -->
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
<td width="7" rowspan="2"><img name="index_x" src="images/shim.gif" width="7" height="33" border="0" alt=""></td>
<td align="left"><img name="dashes" src="images/dashes.gif" width="744" height="3" border="0" alt=""></td>
<td width="10" rowspan="2"><img name="index_x" src="images/shim.gif" width="10" height="33" border="0" alt=""></td>
</tr>
<tr>
<td align="center">
<p class="footer">
Copyright © 1996&#8211;2004, PalmSource, Inc. and its affiliates. All rights reserved.<br>
<a href="http://www.palmsource.com/contact/">Write Us</a> | <a href="http://www.palmos.com/dev/training/">Training</a> | <a href="http://www.palmos.com/dev/support/kb/">Knowledge Base</a> | <a href="SysMgt_Front.html" target="_blank">Legal</a></p>
<br>
<!--BEGIN BOOK NAVIGATION-->
<p class="nav">
<A href="http://www.palmos.com/dev/support/docs/">Documentation</a>&nbsp;&nbsp;|&nbsp;&nbsp;
<a href="SysMgt_TOC.html">Table of Contents</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="Sound.html">&lt;&nbsp;Previous</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="SharedLibraries.html">Next&nbsp;&gt;</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="SysMgt_IX.html">Index</a>
</p>
</td>
</tr>
</table>
<!-- END FOOTER -->

</body>
</html>