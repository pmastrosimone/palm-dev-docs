<html>
<head>
<title>(Protein) Using the Telephony API | Telephony and SMS</title> 
<link href="psi_devpubs.css" rel="stylesheet" type="text/css">

<!-- BEGIN META DATA -->
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<META NAME="PSITEMPLATE" CONTENT="1006-007 PalmSource_HTML_2003 20041101">
<META NAME="GENERATOR" CONTENT="Quadralay WebWorks AutoMap 2003 for FrameMaker 8.0.6.2138">
<META NAME="LASTUPDATED" CONTENT="11/22/04 11:29:17">
<!-- END META DATA -->
</head>

<body bgcolor="#ffffff" text="#000000" leftmargin="0" topmargin="0" marginwidth="0" marginheight="0">
<a name="608590"></a>

<!-- BEGIN TOPNAV -->
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
<td><img src="images/shim.gif" width="7" height="75" border="0" alt=""></td>
<td align="left"><table border="0" cellpadding="0" cellspacing="0" width="744">
<tr>
<td><img name="index_r2_c1" src="images/shim.gif" width="25" height="75" border="0" alt=""></td>
<td valign="top"><table border="0" cellpadding="0" cellspacing="0" width="96">
<tr>
<td><img name="index_r2_c4" src="images/shim.gif" width="96" height="15" border="0" alt=""></td>
</tr>
<tr>
<td><a href="http://www.palmsource.com/"><img name="ps_logo" src="images/ps_logo.gif" width="96" height="54" border="0" alt=""></a></td>
</tr>

</table>
</td>

<td><table border="0" cellpadding="0" cellspacing="0" width="30">
<td><img name="index_x" src="images/shim.gif" width="30" height="75" border="0" alt=""></td>
</table></td>

<!--BEGIN MASTHEAD-->
<td><table border="0" cellpadding="0" cellspacing="0" width="96">
<tr>
<td><img name="index_x" src="images/shim.gif" width="615" height="5" border="0" alt=""></td>
</tr>
<tr>
<td>
<!--BEGIN BOOK NAVIGATION-->
<span class="nav">
<A href="http://www.palmos.com/dev/support/docs/">Documentation</a>&nbsp;&nbsp;|&nbsp;&nbsp;
<a href="TelSMS_TOC.html">Table of Contents</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="TelSMS_ServiceTypes.html">&lt;&nbsp;Previous</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="TelSMS_TelMgrSummary.html">Next&nbsp;&gt;</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="TelSMS_IX.html">Index</a>
</span>
<!--END BOOK NAVIGATION-->
</tr>
<tr>
<td>
<!--BEGIN PAGE TITLE-->
<h2 class="PageTitle">2 &nbsp;&nbsp;
Using the Telephony API</h2></td>
<!--END PAGE TITLE-->
</tr>
<tr>
<td>
<!--BEGIN BOOK TITLE-->
<p class="BookTitle">Telephony and SMS</p>
<p class="SubTitle">Exploring Palm OS&#174;  </p>
<!--END BOOK TITLE-->
</td>
</tr>
<tr>
<td><img name="index_x" src="images/shim.gif" width="615" height="5" border="0" alt=""></td>
</tr>
</table>
</td>
<!--END MASTHEAD-->
</tr>
</table>
<img name="dashes" src="images/dashes.gif" width="744" height="3" border="0" alt=""></td>
</tr>
</table>
<!-- END TOPNAV -->

<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
<td valign="top" width="5"><img name="index_x" src="images/shim.gif" width="5" height="33" border="0" alt=""></td>

<!--BEGIN SIDETOC-->
<td valign="top" width="175">
<div id="sidetoc" valign="bottom">
<h1 class="SideTOC1-PartTab"><a href="TelSMS_TelPartTab.html">Part I: Telephony Manager</a> </h1>
<h1 class="SideTOC1"><a href="TelSMS_UsingTelephony.html">2  Using the Telephony API</a></h1>

   <h2 class="SideTOC2"><a href="#995794">
   Opening the Telephony Manager Library</a></h2>

   <h2 class="SideTOC2"><a href="#995965">
   Closing the Telephony Manager Library</a></h2>

   <h2 class="SideTOC2"><a href="#995966">
   Using Synchronous and Asynchronous Calls</a></h2>

   <h2 class="SideTOC2"><a href="#1000091">
   Using Data Structures With Variably-sized Fields</a></h2>

   <h2 class="SideTOC2"><a href="#995968">
   Testing the Telephony Environment</a></h2>

   <h2 class="SideTOC2"><a href="#997672">
   Telephony Events</a></h2>

   <h2 class="SideTOC2"><a href="#997867">
   Sleep and Wake</a></h2>

</div>
</td>

<td width="5">&nbsp;&nbsp;</td>
<td width="2" background="images/index_r8_c10.gif"><img src="images/shim.gif" width="2" height="75" border="0" alt=""></td>
<td width="5">&nbsp;&nbsp;</td>

<!--END SIDETOC-->

<td valign="top">

<!--BEGIN CONTENT-->
<div id="content" valign="bottom">
<p><a name="995975"> </a>This chapter describes how to use the Telephony API.</p>

<p><a name="998031"> </a>Note that the only network supported in this release is GSM/GPRS.</p>

<h2 class="haH2">
  <a name="995794"> </a>Opening the Telephony Manager Library <a href="#608590"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="995990"> </a>Before you can use the Telephony Manager library, you must open it by calling <a href="TelSMS_TelMgrRef.html#1060172"><code>TelOpen()</code></a> or <a href="TelSMS_TelMgrRef.html#1060199"><code>TelOpenPhoneProfile()</code></a>. The library is automatically loaded by the system upon the first telephony function call.</p>

<p><a name="996488"> </a>When opened, the Telephony Manager library uses the Connection Manager to open an internal component known as the Telephony Server, which interfaces to the phone drivers. The Telephony Server retrieves information about the needed drivers through the Connection Manager profile.</p>

<p><a name="996592"> </a>The particular Connection Manager phone profile that is used depends on how you open the Telephony Manager:</p>
<ul type="disc">
  <li><a name="996672"> </a>If you call <a href="TelSMS_TelMgrRef.html#1060172"><code>TelOpen()</code></a>, the phone profile is automatically selected by the Telephony Manager via a call to <a href="../High-Level_Communications/HLC_ConnMgrRef.html#996053"><code>CncProfileFindFirst()</code></a>. This finds the first telephony profile that is usable and available in the list of telephony profiles.
  <li><a name="996702"> </a>If you call <a href="TelSMS_TelMgrRef.html#1060199"><code>TelOpenPhoneProfile()</code></a>, you select the phone profile by passing its identifier to this function.
</ul>

<h2 class="haH2">
  <a name="995965"> </a>Closing the Telephony Manager Library <a href="#608590"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="996036"> </a>When you are done with the library, you should close it by calling the <a href="TelSMS_TelMgrRef.html#1058499"><code>TelClose()</code></a> function, which releases any resources associated with your use of the Telephony Manager. </p>

<h2 class="haH2">
  <a name="995966"> </a>Using Synchronous and Asynchronous Calls <a href="#608590"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="996067"> </a>Almost all of the telephony functions can be called either synchronously or asynchronously. If you call a function synchronously, it blocks until it completes or an error occurs.</p>

<p><a name="997726"> </a>If you call a function asynchronously, it returns immediately and your application receives an event to notify it that the function has completed. The event that you receive contains status and other information returned by the function. For more information about telephony events, see <a href="TelSMS_UsingTelephony.html#997672">"Telephony Events."</a></p>

<p><a name="997991"> </a>You can cancel an asynchronous function call that is in progress by calling <a href="TelSMS_TelMgrRef.html#1057502"><code>TelCancel()</code></a>.</p>

<p><a name="996068"> </a>This section provides a simple example of calling the <a href="TelSMS_TelMgrRef.html#1059830"><code>TelNwkGetStatus()</code></a> function both synchronously and asynchronously to illustrate the difference. </p>

<p><a name="997735"> </a>When you call a function synchronously, you need to test the result value returned by the function to determine if the call was successful. For example, the code in <a href="TelSMS_UsingTelephony.html#996963">Listing 2.1</a> calls the <code>TelNwkGetStatus()</code> function synchronously.</p>
<p class="CCodeCaption">
  <a name="996963"> </a><b>Listing 2.1&nbsp;&nbsp;Calling a function synchronously</b>
</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
status_t err = errNone;<a name="996964"> </a>
int32_t sTelDescId;<a name="997024"> </a>
uint8_t sNetworkStatus;<a name="997036"> </a>
err = TelNwkGetStatus(sTelDescId, &amp;sNetworkStatus, NULL)<a name="997041"> </a>
printf("Result of getting network status is %d", err);<a name="996077"> </a>
</pre><div class="CodeRule"><hr></div>


<p><a name="996079"> </a>To call the same function asynchronously, you specify a transaction ID in the call, instead of specifying <code>NULL</code> as the last argument. The transaction ID (<code>sNwkStatusTransId</code> in <a href="TelSMS_UsingTelephony.html#996084">Listing 2.2</a>) is a pointer to an unsigned integer value that is filled in by the Telephony Manager with a value associated with the asynchronous operation that is begun. This same ID value is found in the <code>transId</code> field of the event you receive when the operation completes.</p>
<p class="CCodeCaption">
  <a name="996084"> </a><b>Listing 2.2&nbsp;&nbsp;Calling a function asynchronously</b>
</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
status_t err = errNone;<a name="997079"> </a>
int32_t sTelDescId;<a name="997080"> </a>
uint8_t sNetworkStatus;<a name="997081"> </a>
uint16_t sNwkStatusTransId = kTelInvalidTransId;<a name="997135"> </a>
err = TelNwkGetStatus(sTelDescId, &amp;sNetworkStatus, &amp;sNwkStatusTransId)<a name="997082"> </a>
...<a name="996088"> </a>
// Telephony application event handler; called from event loop<a name="997987"> </a>
static void MyProcessTelephonyEvent(TelEventType *eventP)<a name="996089"> </a>
{<a name="996090"> </a>
  switch( eventP-&gt;functionId )<a name="996091"> </a>
  {<a name="996092"> </a>
...<a name="996093"> </a>
    case kTelNwkGetStatusMessage:<a name="996094"> </a>
      printf("Result of function call is %d", eventP-&gt;returnCode);<a name="996095"> </a>
      printf("Network status is %d", eventP-&gt;paramP);<a name="997192"> </a>
      break;<a name="996097"> </a>
...<a name="996098"> </a>
  }<a name="996099"> </a>
</pre><div class="CodeRule"><hr></div>


<h2 class="haH2">
  <a name="1000091"> </a>Using Data Structures With Variably-sized Fields <a href="#608590"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="996117"> </a>Many of the telephony functions use data structures that have variably-sized buffer fields. For example, the <a href="TelSMS_TelMgrRef.html#1059446"><code>TelNwkGetLocation()</code></a> function uses the <a href="TelSMS_TelMgrRef.html#2533471"><code>TelNwkLocationType</code></a> structure, which contains two such fields.</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
typedef struct _TelNwkLocationType {<a name="997285"> </a>
  char *areaCodeP;<a name="997307"> </a>
  size_t areaCodeSize;<a name="997308"> </a>
  char *cellIdP;<a name="997309"> </a>
  size_t cellIdSize;<a name="997310"> </a>
} TelNwkLocationType;<a name="997291"> </a>
</pre><div class="CodeRule"><hr></div>


<p><a name="996132"> </a>The <code>areaCodeP</code> and <code>cellIdP</code> buffers are variable-sized strings that you allocate in the heap. When you initialize one of these structures to pass to the <code>TelNwkGetLocation()</code> function, you must preallocate the buffers and store the allocated size in the corresponding size fields. </p>

<p><a name="996136"> </a>The following code sample initializes a <code>TelNwkLocationType</code> data structure and passes it to the <code>TelNwkGetLocation()</code> function to retrieve the network location. </p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
#define maxAreaCodeSize 5<a name="996137"> </a>
#define maxCellIdSize 30<a name="996138"> </a>
TelNwkLocationType myLoc;<a name="996139"> </a>
<a name="996141"> </a>
myLoc.areaCodeP = MemPtrNew(maxAreaCodeSize);<a name="996143"> </a>
myLoc.areaCodeSize = maxAreaCodeSize;<a name="996144"> </a>
myLoc.cellIdP = MemPtrNew(maxCellIdSize);<a name="996145"> </a>
myLoc.cellIdSize = maxCellIdSize;<a name="996146"> </a>
err = TelNwkGetLocation(sTelDescId, &amp;myLoc, NULL);<a name="996148"> </a>
</pre><div class="CodeRule"><hr></div>


<p><a name="996154"> </a>Upon return from the function, the buffer fields are filled in, and the size fields contain the actual number of bytes that were stored into the buffer fields. </p>

<p><a name="996155"> </a>If the allocated size of a buffer is not large enough to contain the entire value, the function does the following:</p>
<ul type="disc">
  <li><a name="996156"> </a>Returns the <code>telErrBufferSize</code> error.
  <li><a name="996157"> </a>Fills the buffer with as much data as it can, and truncates the data that does not fit. If the data ends with a null terminator and is truncated, the null terminator is retained.
  <li><a name="997468"> </a>Sets the value of the size field to the actual size required to contain all of the data.
</ul>

<p><a name="997469"> </a>Note that for string buffers, the size includes the byte required for the null terminator character.</p>

<div><hr>
  <a name="996168"> </a> <b>NOTE: </b> When you call a function asynchronously, the <code>telErrBufferSize</code> error is returned in the <code>returnCode</code> field of the event you receive upon completion of the function's execution.<br><br>Also, when you call a function asynchronously, it is your responsibility to ensure that any data structures used by the function remain in memory until you receive the completion event. At that time, you are responsible for freeing the memory for any buffers you allocated.
<hr>
</div>

<h2 class="haH2">
  <a name="995968"> </a>Testing the Telephony Environment <a href="#608590"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="996184"> </a>Before running your application, you need to verify that the environment in which it is running (the Palm Powered<span style="color: #000000;  font-style: normal; font-weight: normal; text-decoration: none; text-transform: none; vertical-align: super">&#8482;</span> device and the telephone) supports the facilities that your application needs. The Telephony Manager allows you to determine if a specific service set is available with <a href="TelSMS_TelMgrRef.html#1059141"><code>TelIsServiceAvailable()</code></a>, and also allows you to determine if a specific function call is supported with <a href="TelSMS_TelMgrRef.html#1058994"><code>TelIsFunctionSupported()</code></a>. </p>

<p><a name="997560"> </a>Alternatively, there are a series of macros that you can use to check if a service is available (<code>TelIs</code><code class="par">ServiceName</code><!-PS02-><span style="color: #000000;  font-family: Courier; font-style: normal; font-weight: normal; text-decoration: none; text-transform: none; vertical-align: baseline">ServiceAvailable()</span>), or if a function is available (<code>TelIs</code><code class="par">FunctionName</code><!-PS02-><span style="color: #000000;  font-family: Courier; font-style: normal; font-weight: normal; text-decoration: none; text-transform: none; vertical-align: baseline">Supported()</span>).</p>

<p><a name="996188"> </a>The code excerpt in <a href="TelSMS_UsingTelephony.html#996191">Listing 2.3</a> shows how to use the macros to verify that the environment supports particular phone book capabilities. The code first tests for the availability of the phone book service set, and then determines if several specific functions are supported.</p>
<p class="CCodeCaption">
  <a name="996191"> </a><b>Listing 2.3&nbsp;&nbsp;Testing for the presence of specific capabilities</b>
</p>

<div class="CodeRule"><hr></div><pre class="CodeBlock">
// Test if phone book capabilities are present<a name="997600"> </a>
err = TelIsPhbServiceAvailable(sTelDescId);<a name="996192"> </a>
if (err != errNone)<a name="996194"> </a>
  return err;<a name="996195"> </a>
<a name="996196"> </a>
// Check that this phone supports adding entries<a name="996197"> </a>
err = TelIsPhbAddEntrySupported(sTelDescId);<a name="996198"> </a>
if (err != errNone)<a name="996199"> </a>
  return err;<a name="996200"> </a>
<a name="996201"> </a>
// Check that this phone supports selecting a phone book<a name="996202"> </a>
err = TelIsPhbSetPhonebookSupported(sTelDescId);<a name="996203"> </a>
if (err != errNone)<a name="996204"> </a>
  return err;<a name="996205"> </a>
<a name="996206"> </a>
// Check that this phone supports getting entries list<a name="996207"> </a>
err = TelIsPhbGetEntriesSupported(sTelDescId);<a name="996208"> </a>
if (err != errNone)<a name="996209"> </a>
  return err;<a name="996210"> </a>
<a name="996211"> </a>
// Check that this phone supports getting an entry<a name="996212"> </a>
err = TelIsPhbGetEntrySupported(sTelDescId);<a name="996213"> </a>
if (err != errNone)<a name="996214"> </a>
  return err;<a name="996215"> </a>
<a name="996216"> </a>
// Check that this phone supports deleting an entry<a name="996217"> </a>
err = TelIsPhbDeleteEntrySupported(sTelDescId);<a name="996218"> </a>
return err;<a name="996219"> </a>
</pre><div class="CodeRule"><hr></div>


<h2 class="haH2">
  <a name="997672"> </a>Telephony Events <a href="#608590"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="997675"> </a>The Telephony Manager sends telephony events to an application through its event loop or via notifications sent by the Notification Manager.</p>

<p><a name="997812"> </a>Events sent via the event loop are mainly for the completion of asynchronous function calls. Applications can call <a href="TelSMS_TelMgrRef.html#1071814"><code>TelEvtGetEvent()</code></a> to receive both system events and telephony events in the main event loop. To receive only telephony events, use <a href="TelSMS_TelMgrRef.html#1058712"><code>TelEvtGetTelephonyEvent()</code></a>. Telephony events have the event type <a href="TelSMS_TelMgrRef.html#1057399"><code>kTelTelephonyEvent</code></a>.</p>

<p><a name="997813"> </a>Events sent via notifications are for many other kinds of telephony events such as an incoming SMS message, a call connection, battery status change, etc. These are communicated via a notification of the type <a href="TelSMS_TelMgrRef.html#1057484"><code>kTelTelephonyNotification</code></a>. Applications that want to receive such telephony notifications must register with the Notification Manager.</p>

<h2 class="haH2">
  <a name="997867"> </a>Sleep and Wake <a href="#608590"><span class="nav">^TOP^</span></a>
</h2>


<p><a name="997711"> </a>When the Telephony Server exchanges data with the mobile phone, the device is prevented from sleeping (<code>EvtResetAutoOffTimer()</code> is called internally). This means that the device won't go to sleep when data is being sent or received.</p>

<p><a name="997714"> </a>If the user switches off the device during data exchange, the connection is stopped, and all of the pending commands are canceled.</p>
&nbsp;<br>
</div>
<!--END CONTENT-->

</td>
<td width="5">&nbsp;&nbsp;</td>
</tr>

</table>

<!-- BEGIN FOOTER -->
<table width="100%" border="0" cellspacing="0" cellpadding="0">
<tr>
<td width="7" rowspan="2"><img name="index_x" src="images/shim.gif" width="7" height="33" border="0" alt=""></td>
<td align="left"><img name="dashes" src="images/dashes.gif" width="744" height="3" border="0" alt=""></td>
<td width="10" rowspan="2"><img name="index_x" src="images/shim.gif" width="10" height="33" border="0" alt=""></td>
</tr>
<tr>
<td align="center">
<p class="footer">
Copyright © 1996&#8211;2004, PalmSource, Inc. and its affiliates. All rights reserved.<br>
<a href="http://www.palmsource.com/contact/">Write Us</a> | <a href="http://www.palmos.com/dev/training/">Training</a> | <a href="http://www.palmos.com/dev/support/kb/">Knowledge Base</a> | <a href="TelSMS_Front.html" target="_blank">Legal</a></p>
<br>
<!--BEGIN BOOK NAVIGATION-->
<p class="nav">
<A href="http://www.palmos.com/dev/support/docs/">Documentation</a>&nbsp;&nbsp;|&nbsp;&nbsp;
<a href="TelSMS_TOC.html">Table of Contents</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="TelSMS_ServiceTypes.html">&lt;&nbsp;Previous</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="TelSMS_TelMgrSummary.html">Next&nbsp;&gt;</a>&nbsp;&nbsp;
             |&nbsp;&nbsp;<a href="TelSMS_IX.html">Index</a>
</p>
</td>
</tr>
</table>
<!-- END FOOTER -->

</body>
</html>